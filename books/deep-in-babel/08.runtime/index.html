<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《深入理解 Babel》 · 刘远洋</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="manifest" href="/books/deep-in-babel/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="Just playing around">
    <meta property="og:url" content="/books/deep-in-babel/08.runtime/">
    <meta property="og:site_name" content="《深入理解 Babel》 · 刘远洋">
    <meta property="og:description" content="Babel 对源码的转译涉及 2 个部分: 一个是语法类。比如箭头函数 () =&gt; {} 转译为普通函数 function() {}。 一个是补丁类。针对转译产物&quot;运行时（runtime）&quot;做的一些处理，该部分主要处理API对宿主环境的兼容问题、转译产物尺寸优化等问题，比如为低版本浏览器提供数组的 includes 方法模拟实现: [1, 2, 3].inc">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="《深入理解 Babel》 · 刘远洋">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/books/deep-in-babel/assets/css/0.styles.99892225.css" as="style"><link rel="preload" href="/books/deep-in-babel/assets/js/app.e5f107d9.js" as="script"><link rel="preload" href="/books/deep-in-babel/assets/js/vendors~layout-Layout.d24908b2.js" as="script"><link rel="preload" href="/books/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" as="script"><link rel="preload" href="/books/deep-in-babel/assets/js/page--4c0dc106.7ad2507e.js" as="script"><link rel="preload" href="/books/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" as="script"><link rel="prefetch" href="/books/deep-in-babel/assets/js/23.202ad9ba.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/layout-Blog.b0c6dcb7.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/layout-Layout.54347a9b.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/layout-NotFound.846facba.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/layout-Slide.88fa1023.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--340e5eca.c95f57b2.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--4fdeacc4.e552a9df.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--584954b8.b2f66e01.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--5e0b8312.1f336454.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--6723acaa.4fad50c8.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--8fcba694.bce8a031.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--9bf3e428.cd5ab0a9.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--aec4dcea.d25a7bca.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--c3b426fa.a5024669.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page--d99aed8e.d5506aaa.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page-前言.b76c1a88.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/page-语法分析和语义分析.85427f02.js"><link rel="prefetch" href="/books/deep-in-babel/assets/js/vendors~photo-swipe.a1ad4d40.js">
    <link rel="stylesheet" href="/books/deep-in-babel/assets/css/0.styles.99892225.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/books/deep-in-babel/" class="home-link router-link-active"><!----> <!----> <span class="site-name can-hide">《深入理解 Babel》 · 刘远洋</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://notelyio.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  撰写工具 · Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github · hoperyy
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></nav> <!----> <!----> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="https://notelyio.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  撰写工具 · Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github · hoperyy
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><a href="/books/deep-in-babel/00.%E5%89%8D%E8%A8%80/" class="sidebar-link">第 0 章 - 前言</a></li><li><a href="/books/deep-in-babel/01.%E6%A6%82%E8%BF%B0/" class="sidebar-link">第 1 章 - 概述</a></li><li><a href="/books/deep-in-babel/02.%E8%BD%AC%E8%AF%91%E5%8E%9F%E7%90%86(1)/" class="sidebar-link">第 2 章 - 转译原理 (1)</a></li><li><a href="/books/deep-in-babel/02.%E8%BD%AC%E8%AF%91%E5%8E%9F%E7%90%86(2)/" class="sidebar-link">第 2 章 - 转译原理 (2)</a></li><li><a href="/books/deep-in-babel/03.Babel%E8%8A%82%E7%82%B9/" class="sidebar-link">第 3 章 - Babel 节点</a></li><li><a href="/books/deep-in-babel/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/" class="sidebar-link">第 4 章 - Babel 工具集</a></li><li><a href="/books/deep-in-babel/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/" class="sidebar-link">第 5 章 - Babel 插件编写</a></li><li><a href="/books/deep-in-babel/06.Babel%E5%86%85%E7%BD%AEplugin/" class="sidebar-link">第 6 章 - Babel 内置 Plugin</a></li><li><a href="/books/deep-in-babel/07.Babel%E5%86%85%E7%BD%AEpreset/" class="sidebar-link">第 7 章 - Babel 内置 Preset</a></li><li><a href="/books/deep-in-babel/08.runtime/" aria-current="page" class="active sidebar-link">第 8 章 - runtime</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-1-补丁类工具" class="sidebar-link">8.1 补丁类工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-1-1-核心工具" class="sidebar-link heading3">8.1.1 核心工具</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-1-2-案例" class="sidebar-link heading3">8.1.2 案例</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-1-3-总结" class="sidebar-link heading3">8.1.3 总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-2-core-js" class="sidebar-link">8.2 core-js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-2-1-简介" class="sidebar-link heading3">8.2.1 简介</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-2-2-core-js-2与core-js-3" class="sidebar-link heading3">8.2.2 core-js@2与core-js@3</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-2-3-core-js-3-子模块分类" class="sidebar-link heading3">8.2.3 core-js@3 子模块分类</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-2-3-core-js中的补丁" class="sidebar-link heading3">8.2.3 core-js中的补丁</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#准备工作" class="sidebar-link heading3">准备工作</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#ecmascript标准的补丁" class="sidebar-link heading3">ECMAScript标准的补丁</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#ecmascript提案的补丁" class="sidebar-link heading3">ECMAScript提案的补丁</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#web-标准-api-的补丁" class="sidebar-link heading3">WEB 标准 API 的补丁</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#缺失的补丁" class="sidebar-link heading3">缺失的补丁</a></li></ul></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-3-regenerator-runtime" class="sidebar-link">8.3 regenerator-runtime</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-3-1-generator对象" class="sidebar-link heading3">8.3.1 Generator对象</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#迭代协议" class="sidebar-link heading3">迭代协议</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#可迭代协议" class="sidebar-link heading3">可迭代协议</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#迭代器协议" class="sidebar-link heading3">迭代器协议</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#生成器对象到底是一个迭代器-还是一个可迭代对象" class="sidebar-link heading3">生成器对象到底是一个迭代器，还是一个可迭代对象？</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-3-2-babel-对-generator-函数的转译" class="sidebar-link heading3">8.3.2 Babel 对 generator 函数的转译</a></li><li class="sidebar-sub-header"><a href="/books/deep-in-babel/08.runtime/#_8-3-3-regenerator-runtime-源码解析" class="sidebar-link heading3">8.3.3 regenerator-runtime 源码解析</a></li></ul></li></ul></li><li><a href="/books/deep-in-babel/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" class="sidebar-link">第 9 章 - Babel 项目管理</a></li><li><a href="/books/deep-in-babel/10.%E8%BD%AC%E8%AF%91%E5%99%A8%E5%AF%B9%E6%AF%94/" class="sidebar-link">第 10 章 - 转译器对比</a></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline"></span></h1> <div class="page-info"><!----> <!----><!----><span aria-label="Writing Date📅" data-balloon-pos="down" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2022-2-24</span></span><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 49 min</span> <meta property="timeRequired" content="PT49M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-1-补丁类工具" class="anchor-link heading2"><div>8.1 补丁类工具</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-1-1-核心工具" class="anchor-link heading3"><div>8.1.1 核心工具</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-1-2-案例" class="anchor-link heading3"><div>8.1.2 案例</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-1-3-总结" class="anchor-link heading3"><div>8.1.3 总结</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-2-core-js" class="anchor-link heading2"><div>8.2 core-js</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-2-1-简介" class="anchor-link heading3"><div>8.2.1 简介</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-2-2-core-js-2与core-js-3" class="anchor-link heading3"><div>8.2.2 core-js@2与core-js@3</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-2-3-core-js-3-子模块分类" class="anchor-link heading3"><div>8.2.3 core-js@3 子模块分类</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-2-3-core-js中的补丁" class="anchor-link heading3"><div>8.2.3 core-js中的补丁</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#准备工作" class="anchor-link heading3"><div>准备工作</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#ecmascript标准的补丁" class="anchor-link heading3"><div>ECMAScript标准的补丁</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#ecmascript提案的补丁" class="anchor-link heading3"><div>ECMAScript提案的补丁</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#web-标准-api-的补丁" class="anchor-link heading3"><div>WEB 标准 API 的补丁</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#缺失的补丁" class="anchor-link heading3"><div>缺失的补丁</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-3-regenerator-runtime" class="anchor-link heading2"><div>8.3 regenerator-runtime</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-3-1-generator对象" class="anchor-link heading3"><div>8.3.1 Generator对象</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#迭代协议" class="anchor-link heading3"><div>迭代协议</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#可迭代协议" class="anchor-link heading3"><div>可迭代协议</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#迭代器协议" class="anchor-link heading3"><div>迭代器协议</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#生成器对象到底是一个迭代器-还是一个可迭代对象" class="anchor-link heading3"><div>生成器对象到底是一个迭代器，还是一个可迭代对象？</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-3-2-babel-对-generator-函数的转译" class="anchor-link heading3"><div>8.3.2 Babel 对 generator 函数的转译</div></a></li><li class="anchor"><a href="/books/deep-in-babel/08.runtime/#_8-3-3-regenerator-runtime-源码解析" class="anchor-link heading3"><div>8.3.3 regenerator-runtime 源码解析</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><p>Babel 对源码的转译涉及 2 个部分:</p> <p>一个是语法类。比如箭头函数 <code>() =&gt; {}</code> 转译为普通函数 <code>function() {}</code>。</p> <p>一个是补丁类。针对转译产物&quot;运行时（runtime）&quot;做的一些处理，该部分主要处理API对宿主环境的兼容问题、转译产物尺寸优化等问题，比如为低版本浏览器提供数组的 <code>includes</code> 方法模拟实现: <code>[1, 2, 3].includes(...)</code>。</p> <blockquote><p>runtime 是相对于语法类转译的状态而言的，指的是转译产物在宿主环境运行时的状态。</p></blockquote> <p>本章将介绍 Babel 针对转译产物的&quot;运行时（runtime）&quot;所做的工作。</p> <h2 id="_8-1-补丁类工具"><a href="#_8-1-补丁类工具" class="header-anchor">#</a> 8.1 补丁类工具</h2> <h3 id="_8-1-1-核心工具"><a href="#_8-1-1-核心工具" class="header-anchor">#</a> 8.1.1 核心工具</h3> <p>Babel为源码&quot;打补丁&quot;的时候，用到了多种工具，这里做下介绍。</p> <ul><li><p><code>core-js</code></p> <p><code>core-js</code> 提供了对 ECMAScript 标准、ECMAScript 提案、WEB 部分标准 API 等方面，对于目标宿主环境的补丁实现。</p> <p>对其常见的一个用法是兼容低版本浏览器，比如 <code>Promise</code> 在部分低的版本浏览器下是不支持的（如IE 6-10），<code>core-js</code> 提供了 <code>Promise</code> 对象的模拟实现。</p> <p>随着 ECMAScript、WEB 标准的不断发展，<code>core-js</code> 也在不断迭代，截至本书编写时，<code>core-js</code> 主要有两个版本系列: <code>core-js@2</code>、<code>core-js@3</code>。</p> <p>本章有专门的一节介绍 <code>core-js</code>。</p></li> <li><p>babel-preset-env</p> <p>babel-preset-env 会同时提供语法部分和补丁类的转译功能。值得注意的是，babel-preset-env 提供的高级 API 的补丁，是通过引入全局变量的形式实现的，因此可能会污染全局变量。</p> <p>babel-preset-env 的配置项有很多，和补丁类相关的主要是: <code>useBuiltIns</code>和<code>corejs</code>。</p> <p>比如，待转译的源码 <code>Promise</code>，通过 babel-preset-env 转译时，相应配置项的含义如下:</p> <ul><li><p><code>useBuiltIns</code></p> <p>该配置描述了是否自动引入 <code>core-js</code>、用哪种方式引入 <code>core-js</code>，它有几种值:</p> <ul><li><p><code>false</code></p> <p>不会自动引入 <code>core-js</code>，这是默认值。</p></li> <li><p><code>entry</code></p> <p>需要在源码入口文件中手动引入 <code>core-js</code>，且只能引入一次。</p> <p>比如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>没什么变化，这是因为源码中没有引入 <code>core-js</code>。</p> <p>源码调整为:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'core-js'</span>
Promise
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>转译结果为:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es6.array.copy-within.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 全量的 core-js 子包</span>
<span class="token operator">...</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/web.dom.iterable.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到，转译结果有以下特点:</p> <ul><li>引入的 <code>Promise</code> 补丁污染了全局变量</li> <li>补丁是全量引入的</li></ul></li> <li><p><code>usage</code></p> <p>会自动在转译后代码中按需引入 <code>core-js</code> 的子包。</p> <p>比如转译如下代码时:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Promise
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es6.object.to-string.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 影响全局变量 Promise</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es6.promise.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>可以看到，转译结果有以下特点:</p> <ul><li>引入的补丁污染了全局变量</li> <li>补丁是按需引入的</li></ul> <p>如果目标环境需要引入的话，转译时会自动引入对 <code>Promise</code> 的 API 补丁。</p></li></ul></li> <li><p><code>corejs: string | { version: string, proposals: boolean }</code></p> <p><code>corejs</code> 配置项对应 <code>core-js</code> 工具包，该工具提供了高版本API的兼容性实现。默认 <code>2</code>（随着发展，默认值可能调整为 <code>3</code>）。</p> <p>注意，只有在 babel-preset-env 的 <code>useBuiltIns</code> 配置项的值为 <code>usage | entry</code> 的情况下，<code>corejs</code> 的配置才会生效。</p> <p><code>corejs</code> 配置的特点如下:</p> <ul><li><p><code>corejs</code> 可以设置精确的版本号</p> <p>如 <code>corejs: &quot;3.8&quot;</code>。</p></li> <li><p><code>corejs</code> 可配置是否支持提案API</p> <p>比如目标源码是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 截稿时，globalThis 是提案阶段 API</span>
globalThis
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当 babel-preset-env 的配置项如下（不开启对提案 API 的补丁支持），:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">useBuiltIns</span><span class="token operator">:</span> <span class="token string">'usage'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">corejs</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token literal-property property">proposals</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果开启对提案 API 的补丁支持（配置 <code>proposals: true</code>），转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/esnext.global-this.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

globalThis<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul></li></ul></li> <li><p>babel-plugin-polyfill-corejs2/3</p> <p>TODO</p></li> <li><p>babel-plugin-transform-runtime</p> <ul><li><p>作用1: 为转译过程中的辅助函数提供可复用的模块，以提高代码复用性</p> <p>babel-plugin-transform-runtime 将语法转换过程中产生的辅助函数，从硬编码的形式，改为模块引入的形式，避免重复代码。</p> <p>比如，源码:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// class 为语法部分</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>不同配置下的转译结果不同。</p> <ul><li><p>不配置 babel-plugin-transform-runtime</p> <p>Babel配置:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'@babel/preset-env'</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// [ '@babel/plugin-transform-runtime' ]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>转译结果是:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot call a class as a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>配置 babel-plugin-transform-runtime</p> <p>Babel配置:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'@babel/preset-env'</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'@babel/plugin-transform-runtime'</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>转译结果是:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> _classCallCheck <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/classCallCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _classCallCheck<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>_classCallCheck</code> 方法被以第三方模块引入的方式定义，避免出现重复的函数定义。</p> <p>另外可以看到，<code>_classCallCheck</code> 引用自 <code>babel-runtime</code>，哪些工具可以提供这些辅助函数，可以在 babel-plugin-transform-runtime 的配置项 <code>corejs</code> 设置。</p></li></ul></li> <li><p>作用2: 将 API 补丁以局部变量的形式引入到转译产物，避免污染全局对象</p> <p>比如，源码:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>Promise
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Babel 未配置 babel-plugin-transform-runtime时:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">useBuiltIns</span><span class="token operator">:</span> <span class="token string">'usage'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>转译结果:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es.promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 会影响全局变量 Promise</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Babel 配置 babel-plugin-transform-runtime时:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">useBuiltIns</span><span class="token operator">:</span> <span class="token string">'usage'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">corejs</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>转译结果是:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> _promise <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime-corejs3/core-js-stable/promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 局部变量</span>
<span class="token keyword">new</span> <span class="token class-name">_promise</span><span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以看到，babel-plugin-transform-runtime 会将补丁以局部变量的形式提供给转译结果。</p></li> <li><p>babel-plugin-transform-runtime 配置</p> <ul><li><p><code>corejs: false | 2 | 3 | { version: 2 | 3, proposals: boolean }</code></p> <ul><li><p><code>false</code></p> <p>不配置 core-js 版本，直接使用 <code>babel-runtime</code> 包提供的辅助函数。</p> <p>该配置项需要项目增加对 <code>babel-runtime</code> 包的依赖。</p></li> <li><p><code>2</code></p> <p>使用 <code>babel-runtime-core2</code> 包提供的辅助函数。</p> <p><code>corejs: 2</code> 仅支持全局变量（如 <code>Promise</code>）和静态属性（如 <code>Array.from</code>）。</p> <p>该配置项需要项目引入依赖 <code>babel-runtime-corejs2</code> 包。</p></li> <li><p><code>3</code></p> <p>使用 <code>babel-runtime-core3</code> 提供的辅助函数。</p> <p><code>corejs: 3</code> 除了支持全局变量（如 <code>Promise</code>）和静态属性（如 <code>Array.from</code>），也支持实例的属性（如 <code>[].includes</code>）。</p> <p>该配置项需要项目引入依赖 <code>babel-runtime-corejs3</code> 包。</p></li> <li><p><code>{ version: 2 | 3, proposals: boolean }</code></p> <p>与 babel-preset-env 中关于 <code>corejs</code> 的配置一致，描述是否提供提案 API 的补丁注入支持。</p></li></ul></li> <li><p><code>helpers: boolean</code></p> <p>表示 babel-plugin-transform-runtime 是否开启将硬编码形式的 helpers 函数，转为模块式的引入。默认是 <code>true</code>。</p> <p>举例，目标源码是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Babel在如下配置时:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">useBuiltIns</span><span class="token operator">:</span> <span class="token string">'usage'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> 
            <span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">,</span> 
            <span class="token punctuation">{</span> <span class="token literal-property property">helpers</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token comment">// 不开启模块化引入 helpers 的功能</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 这是硬编码定义的 helpers 函数</span>
<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot call a class as a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当设置 <code>helpers: true</code> 时，转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _classCallCheck2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/classCallCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _classCallCheck2<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p><code>useESModules: boolean</code></p> <p>是否引入 <code>esm</code> 格式的 Babel helpers 函数，默认是 <code>false</code>，即默认不开启。</p> <p>举例，目标源码是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Babel在如下配置时:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">useBuiltIns</span><span class="token operator">:</span> <span class="token string">'usage'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> 
            <span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">,</span> 
            <span class="token punctuation">{</span> <span class="token literal-property property">useESModules</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span> <span class="token comment">// 默认值，不引入 esm 格式的 Babel helpers 函数</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这是非 esm 格式的 helper 函数</span>
<span class="token keyword">var</span> _classCallCheck2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/classCallCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _classCallCheck2<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当设置 <code>useESModules: true</code> 时，转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这是 esm 格式的 helper 函数</span>
<span class="token keyword">var</span> _classCallCheck2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/esm/classCallCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">A</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _classCallCheck2<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p><code>regenerator: boolean</code></p> <p>表示是否提供辅助方法用于转译 <code>generator</code> 函数，默认是 <code>true</code>。</p> <p>举个实际的例子就比较清楚了，待转译的源码:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果 Babel 配置是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">'@babel/preset-env'</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> 
            <span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">,</span> 
            <span class="token punctuation">{</span> <span class="token literal-property property">regenerator</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token comment">// 提供辅助方法用于转译 generator 函数</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 提供的辅助函数用于转译 generator 函数</span>
<span class="token keyword">var</span> _regenerator <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/regenerator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _marked <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span>_regenerator<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _regenerator<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">run$</span><span class="token punctuation">(</span><span class="token parameter">_context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>_context<span class="token punctuation">.</span>prev <span class="token operator">=</span> _context<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token string">&quot;end&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> _context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> _marked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>如果设置 <code>regeneraotr: false</code>，转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _marked <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span>regeneratorRuntime<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">run$</span><span class="token punctuation">(</span><span class="token parameter">_context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>_context<span class="token punctuation">.</span>prev <span class="token operator">=</span> _context<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token string">&quot;end&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> _context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> _marked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以看到，<code>regeneraotr: false</code> 时，转译结果代码依赖一个全局对象 <code>regeneratorRuntime</code>，从安全性上说，对全局变量的依赖是不稳定的。</p></li></ul></li></ul></li></ul> <h3 id="_8-1-2-案例"><a href="#_8-1-2-案例" class="header-anchor">#</a> 8.1.2 案例</h3> <p>接下来以案例解释上述工具在Babel转译过程的作用。</p> <ul><li><p>准备工作</p> <ul><li><p>待转译的源文件为 index.js</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这段源码包含了语法和 API 部分:</p> <ul><li><code>class</code> 为语法部分</li> <li><code>Promise</code> 为API部分</li></ul></li> <li><p>配置文件使用 <code>.babelrc</code></p></li> <li><p>转译产物文件为 <code>index-compiled.js</code></p></li> <li><p>使用命令行</p> <p>我们希望这段源码转为 ES5 版本，该怎么做呢？假设，用 Babel 命令行执行转译，通过 <code>.babelrc</code>配置 Babel，转译产物文件为 index-compiled.js。</p> <blockquote><p>npx babel index.js --config-file ./.babelrc --out-file index-compiled.js</p> <p>安装 node 或 npm 后，可直接使用 npx 唤起各类命令行执行</p></blockquote></li></ul></li> <li><p>不同配置的效果</p> <ul><li><p><code>.babelrc</code> 空配置</p> <p>转译后，<code>index-compiled.js</code> 的内容依然是源码的样子:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>使用 babel-preset-env 转译语法部分</p> <p>配置 <code>.babelrc</code>:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;@babel/preset-env&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>执行转译后，<code>index-compiled.js</code> 的内容为:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>instance <span class="token keyword">instanceof</span> <span class="token class-name">Constructor</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot call a class as a function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>转译产物有以下特点:</p> <ul><li>新增指令: <code>&quot;use strict&quot;</code></li> <li>语法转译: <code>Class</code> 转为了普通函数</li> <li>新增辅助函数: 新引入了工具方法 <code>_classCallCheck</code>，用于校验构造函数被调用的方式</li> <li>未引入API补丁: <code>Promise</code> 作为API，没有引入补丁</li></ul> <p>总结一下，只配置了 <code>babel-preset-env</code> 的情况下，语法部分被转译了，API 部分没有引入补丁，对于低版本运行环境可能有兼容性问题。</p></li> <li><p>使用babel-preset-env 的 <code>useBuiltIns: &quot;entry&quot;</code> 配置引入全量、全局的 API 补丁</p> <p>接下来修改 <code>.babelrc</code> 配置:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;useBuiltIns&quot;</span><span class="token operator">:</span> <span class="token string">&quot;entry&quot;</span><span class="token punctuation">,</span>
                <span class="token string-property property">&quot;corejs&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如上配置，<code>useBuiltIns</code> 为 <code>entry</code> 时，需要手动在源码添加 <code>import 'core-js'</code>:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token string">'core-js'</span>
<span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>转译产物为:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es.symbol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es.promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es.promise.finally&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span>

<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>可以看到，相对源码，转译产物特点如下:</p> <ul><li>全局、全量引入了 <code>core-js</code> 提供的各类API实现</li> <li>其他特点和仅配置了 <code>babel-preset-env</code> 的情况一致
<ul><li>新增指令: <code>&quot;use strict&quot;</code></li> <li>语法转译: <code>Class</code> 转为了普通函数</li> <li>新增辅助函数: 引入了工具方法 <code>_classCallCheck</code>，校验构造函数被调用的方式</li></ul></li></ul></li> <li><p>使用 babel-preset-env 的 <code>useBuiltIns: &quot;usage&quot;</code> 配置引入按需、全局的 API 补丁</p> <p>上面的例子中，<code>&quot;useBuiltIns&quot;: &quot;entry&quot;</code> 的方式缺点很明显:</p> <ul><li>全局引入了 API 实现</li> <li>全量引入了 API 实现，而源码中仅仅需要的是 <code>Promise</code> 的实现</li></ul> <p>我们先解决第二个问题，改全量为按需，这需要设置 babel-preset-env 的 <code>useBuiltIns</code> 配置项为 <code>usage</code>。</p> <p>修改 <code>.babelrc</code> 配置:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;useBuiltIns&quot;</span><span class="token operator">:</span> <span class="token string">&quot;usage&quot;</span><span class="token punctuation">,</span>
                <span class="token string-property property">&quot;corejs&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>对了，源码中不再需要手动引入 <code>core-js</code> 了，恢复一下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>转译后的代码:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es.object.to-string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es.promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> Constructor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_classCallCheck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>转译后的代码特点:</p> <ul><li>按需引入了全局的 Promise 实现</li> <li>其他特点和仅配置了 <code>babel-preset-env</code> 的情况一致
<ul><li>新增指令: <code>&quot;use strict&quot;</code></li> <li>语法转译: <code>Class</code> 转为了普通函数</li> <li>新增辅助函数: 引入了工具方法 <code>_classCallCheck</code>，校验构造函数被调用的方式</li></ul></li></ul></li> <li><p>使用 babel-plugin-transform-runtime 实现按需、局部变量形式引入 API 补丁</p> <p>上面的配置中，仍然有一个问题没有解决: <code>Promise</code> 的 API 实现仍然是全局引入的。</p> <p>引入全局的 <code>Promise</code> 实现，一般而言没什么问题，但对于工具库等场景的开发而言，污染全局变量会引起不可预知的问题，需要将 <code>Promise</code> 的兼容性实现改为局部变量。</p> <p>而 babel-preset-env 的 <code>&quot;useBuiltIns&quot;</code> 配置关注的是如何将 API 的实现以<strong>全局</strong>变量的形式引入转译产物。在此，需要使用 <code>babel-plugin-transform-runtime</code> 引入局部的 Promise 实现。并且，<code>babel-plugin-transform-runtime</code> 与 <code>babel-preset-env</code> 的 <code>useBuiltIns</code> 配置是互斥的，只能选一个配置。</p> <p>修改 <code>.babelrc</code> 配置:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;@babel/preset-env&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;@babel/plugin-transform-runtime&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;corejs&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>转译产物为:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime-corejs3/helpers/interopRequireDefault&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _promise <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime-corejs3/core-js-stable/promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _classCallCheck2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime-corejs3/helpers/classCallCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _classCallCheck2<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">_promise</span><span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>终于，我们看到:</p> <ul><li>Promise的API实现被以局部变量的形式引入</li> <li><code>_classCallCheck</code> 和 <code>Promise</code> 的实现均以 <code>require</code> 的形式引入，而不是硬编码</li> <li><code>_classCallCheck</code> 和 <code>Promise</code> 的实现由 <code>babel-runtime-corejs3</code> 提供，不再是 <code>babel-runtime</code> 的 helpers 提供</li></ul></li> <li><p>使用 babel-plugin-transform-runtime 除去重复的辅助代码</p> <p>细心的同学可能注意到，上例中，引入 <code>babel-plugin-transform-runtime</code> 后，<code>_classCallCheck</code> 这类工具方法被以第三方引用的方式定义，而非原来的硬编码。</p> <p><code>babel-plugin-transform-runtime</code> 确实可以解决辅助工具方法被硬编码带来的重复编码问题。</p> <p>如果 <code>.babelrc</code> 配置为:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string-property property">&quot;useBuiltIns&quot;</span><span class="token operator">:</span> <span class="token string">&quot;usage&quot;</span><span class="token punctuation">,</span>
                <span class="token string-property property">&quot;corejs&quot;</span><span class="token operator">:</span> <span class="token number">3</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
            <span class="token string">&quot;@babel/plugin-transform-runtime&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>那么，转译产物为:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es6.promise&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;core-js/modules/es6.object.to-string&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _classCallCheck2 <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/classCallCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">Base</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _classCallCheck2<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以看到，<code>_classCallCheck</code> 通过 <code>require</code> 的方式引入，而不再是硬编码的方式。</p></li></ul></li></ul> <h3 id="_8-1-3-总结"><a href="#_8-1-3-总结" class="header-anchor">#</a> 8.1.3 总结</h3> <p>总结一下，前面通过配置解决了上文中描述过的几个问题:</p> <ul><li>辅助方法如 <code>_classCallCheck</code> 被以硬编码的形式引入转译产物</li> <li>API 没有被转译</li> <li>API 被以全局引入补丁的方式转译</li></ul> <p>这里是关于配置的简单总结（伪代码）:</p> <table><thead><tr><th>配置组合</th> <th>语法部分</th> <th>API补丁是否引入</th> <th>API补丁副作用</th> <th>辅助函数引入方式</th></tr></thead> <tbody><tr><td><code>[babel-preset-env]</code></td> <td>执行转译</td> <td>无</td> <td>无</td> <td>硬编码</td></tr> <tr><td><code>[babel-preset-env, { useBuiltIns: entry, corejs: 2/3 }]</code></td> <td>执行转译</td> <td>全量、需源码中手动引入<code>core-js</code></td> <td>污染全局对象、原型链</td> <td>硬编码</td></tr> <tr><td><code>[babel-preset-env, { useBuiltIns: usage, corejs: 2/3 }]</code></td> <td>执行转译</td> <td>按需、自动引入<code>core-js</code></td> <td>污染全局对象、原型链</td> <td>硬编码</td></tr> <tr><td><code>[babel-preset-env] + [babel-plugin-transform-runtime]</code></td> <td>执行转译</td> <td>无</td> <td>无</td> <td>外部引用</td></tr> <tr><td><code>[babel-preset-env] + [babel-plugin-transform-runtime, { corejs: 2/3 }]</code></td> <td>执行转译</td> <td>按需、自动引入<code>core-js</code></td> <td>不污染全局对象、原型链（API以局部变量引入）</td> <td>外部引用</td></tr></tbody></table> <p>这样，就能根据需求灵活调整配置。</p> <h2 id="_8-2-core-js"><a href="#_8-2-core-js" class="header-anchor">#</a> 8.2 <code>core-js</code></h2> <h3 id="_8-2-1-简介"><a href="#_8-2-1-简介" class="header-anchor">#</a> 8.2.1 简介</h3> <p><code>core-js</code> 是 JavaScript 标准库 API 的补丁集，现在，它已支持 ECMAScript 的部分提案 API、标准 API，同时也支持部分 WEB 标准。</p> <p>比如，对于 <code>Array.isArray()</code> 方法，<code>core-js</code> 提供了补丁:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> toString <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>toString<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">classof</span><span class="token punctuation">(</span><span class="token parameter">it</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Array<span class="token punctuation">.</span>isArray <span class="token operator">=</span> Array<span class="token punctuation">.</span>isArray <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token function">isArray</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">classof</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'Array'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>core-js</code> 最初是作者为了满足自身项目需要开启的项目，提供一些补丁和工具函数，随后发布在社区，并越来越向标准化靠近，到现在，<code>core-js</code> 可以被认为是一个纯粹的标准库补丁集。</p> <p><code>core-js</code> 通常应用内置在 Babel 插件体系里，开发者以前较少用到，但它已经是前端开发的一个基础设施了。</p> <h3 id="_8-2-2-core-js-2与core-js-3"><a href="#_8-2-2-core-js-2与core-js-3" class="header-anchor">#</a> 8.2.2 core-js@2与core-js@3</h3> <p>截至 2021 年 2 月，<code>core-js</code> 广泛应用的有两个版本: <code>core-js@2</code> 和 <code>core-js@3</code>，其中 <code>core-js@2</code> 已经停止更新，建议使用 <code>core-js@3</code> 版本。</p> <blockquote><p>本身编写时，能看到 core-js@4 的一些注释了，也许本书出版的时候 core-js@4 已经发布</p></blockquote> <p>下表是 <code>core-js@2</code> 与 <code>core-js@3</code> 的部分区别:</p> <table><thead><tr><th></th> <th><code>core-js@2</code></th> <th><code>core-js@3</code></th></tr></thead> <tbody><tr><td>是否更新</td> <td>不再更新</td> <td>更新中</td></tr> <tr><td>性能</td> <td>包体积较大（~2M）</td> <td>包进行了拆分: core-js/core-js-pure/core-js-compat</td></tr> <tr><td>特性支持</td> <td></td> <td>在 @2 的基础上，删除一些过时特性<br>在 @2 的基础上，新增对 web 标准的支持</td></tr></tbody></table> <p>在此，我们主要了解 <code>core-js@3</code> 版本的使用和原理，下文中如不特殊标注版本，均被认为是 <code>core-js@3</code>。其与 <code>core-js@2</code> 的差异，书中也会介绍。</p> <p><code>core-js@3</code> 的特点:</p> <ul><li><p><code>core-js</code> 支持最新的 ECMAScript 标准</p></li> <li><p><code>core-js</code> 支持 ECMAScript 标准库提案</p></li> <li><p><code>core-js</code> 支持一些 WHATWG/W3C 标准</p></li> <li><p><code>core-js</code> 最大限度提供模块化定义，使之可按需使用</p></li> <li><p><code>core-js</code> 支持污染和不污染全局变量的能力</p></li> <li><p><code>core-js</code> 和 Babel 紧密集成，便于项目使用</p></li></ul> <h3 id="_8-2-3-core-js-3-子模块分类"><a href="#_8-2-3-core-js-3-子模块分类" class="header-anchor">#</a> 8.2.3 <code>core-js@3</code> 子模块分类</h3> <p><code>core-js@3</code> 是 monorepo 项目，基于 lerna 进行模块管理，其核心 package 包括:</p> <ol><li><code>core-js/packages/core-js/</code></li> <li><code>core-js/packages/core-js-builder/</code></li> <li><code>core-js/packages/core-js-bundle/</code></li> <li><code>core-js/packages/core-js-compat/</code></li> <li><code>core-js/packages/core-js-pure/</code></li></ol> <p>接下来将介绍上述模块。</p> <ul><li><p><code>core-js/packages/core-js/</code></p> <p>定义全局的补丁（~500KB，压缩并且 gzipped 处理后 40KB）。</p> <p>core-js 支持 ECMAScript 标准、ECMAScript 提案、一些 WEB 标准（WHATWG/W3C），也支持模块化。这些特点的实现，主要在 <code>core-js/packages/core-js/</code> 目录里。源码中有以下约定:</p> <ul><li>ECMAScript 标准中的 API，以 <code>es.xx.js</code> 命名，如 <code>es.array.every.js</code></li> <li>ECMAScript 提案中的 API，以 <code>esnext.xx.js</code> 命名，如 <code>esnext.map.of.js</code></li> <li>WEB 标准中的 API，以 <code>web.xx.js</code> 命名，如 <code>web.url-search-params.js</code></li></ul> <p>下表是 <code>core-js/packages/core-js</code> 各子模块的功能以及对各个标准的支持情况:</p> <table><thead><tr><th>目录/文件</th> <th>描述</th> <th>支持ES标准</th> <th>支持ES提案</th> <th>支持WEB标准</th></tr></thead> <tbody><tr><td>packages/core-js/index.js</td> <td>全部补丁，包括 ECMAScript 标准、ECMAScript 提案、WEB 标准</td> <td>√</td> <td>√</td> <td>√</td></tr> <tr><td>packages/core-js/es/</td> <td>进入 ECMAScript 标准的 API</td> <td>√</td> <td>√</td> <td>×</td></tr> <tr><td>packages/core-js/features/</td> <td>包含 <code>es/</code>、<code>web/</code>、<code>proposals/</code> 目录下的所有 API</td> <td>√</td> <td>√</td> <td>√ ?</td></tr> <tr><td>packages/core-js/stable/</td> <td>稳定的 API，包括 ECMAScript 标准、WEB 标准</td> <td>√</td> <td>×</td> <td>√</td></tr> <tr><td>packages/core-js/web/</td> <td>WEB 标准 API</td> <td>×</td> <td>×</td> <td>√</td></tr> <tr><td>packages/core-js/proposals/</td> <td><code>index.js</code> 指向 <code>stage/</code> 目录，间接指向 <code>stage-0/</code> 目录。目录内其他文件均为试验阶段的 ES API</td> <td>×</td> <td>√</td> <td>×</td></tr> <tr><td>packages/core-js/stage/</td> <td><code>index.js</code> 指向 <code>stage-0/</code> 目录，目录内其他文件分别指向 <code>stage0~4</code></td> <td>√</td> <td>√</td> <td>×</td></tr> <tr><td>packages/core-js/internals/</td> <td>内部使用的工具函数，含 API 具体实现，不用于对外服务</td> <td>√</td> <td>√</td> <td>√</td></tr> <tr><td>packages/core-js/modules/</td> <td>提供 API 最终定义；文件命名与当前支持的阶段和标准相关。</td> <td>√</td> <td>√</td> <td>√</td></tr></tbody></table></li> <li><p><code>core-js/packages/core-js-pure</code></p> <p>提供了不污染全局变量的补丁，即模块化的使用。和 core-js@2 中的 <code>core-js/library</code> 相当（~440KB）。</p> <p>举例:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 局部变量</span>
<span class="token keyword">import</span> from <span class="token keyword">from</span> <span class="token string">'core-js-pure/stable/array/from'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> flat <span class="token keyword">from</span> <span class="token string">'core-js-pure/stable/array/flat'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Set <span class="token keyword">from</span> <span class="token string">'core-js-pure/stable/set'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Promise <span class="token keyword">from</span> <span class="token string">'core-js-pure/stable/promise'</span><span class="token punctuation">;</span>

<span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">flat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p><code>core-js/packages/core-js-bundle</code></p> <p><code>core-js-bundle</code> 是一个完整的 <code>core-js</code> 打包后的版本，提供全局补丁定义。</p> <p>可以在浏览器环境使用:</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/core-js-bundle@3.16.2/minified.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>globalThis<span class="token punctuation">.</span>Array <span class="token operator">===</span> Array<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>也可以在 Node 环境使用:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'core-js-bundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>globalThis<span class="token punctuation">.</span>Array <span class="token operator">===</span> Array<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p><code>core-js/packages/core-js-compat</code></p> <p><code>core-js-compat</code> 提供了目标环境对应的 <code>core-js</code> 需要提供的功能模块。</p></li></ul> <h3 id="_8-2-3-core-js中的补丁"><a href="#_8-2-3-core-js中的补丁" class="header-anchor">#</a> 8.2.3 core-js中的补丁</h3> <p>这里介绍一下 <code>core-js</code> 中某些 API 的补丁。</p> <h3 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h3> <p><code>core-js</code> 内部提供了一个通用的工具方法（这里命名为 <code>$</code>），该方法定义在文件 <code>core-js/packages/core-js/internals/export.js</code>，类型定义如下。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>options<span class="token operator">:</span> object<span class="token punctuation">;</span> source<span class="token operator">:</span> object<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该方法提供了一种快捷方式，将补丁实现快速应用在目标对象上。</p> <p>比如，<code>core-js/packages/core-js/modules/es.object.is.js</code> 定义了 <code>Object.is</code> 方法的补丁，通用方法 <code>$</code> 是这样为 <code>Object</code> 对象添加 <code>is()</code> 方法的:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/export'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通用的工具方法 $</span>
<span class="token keyword">var</span> is <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/same-value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// `Object.is` method</span>
<span class="token comment">// https://tc39.es/ecma262/#sec-object.is</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'Object'</span><span class="token punctuation">,</span> <span class="token literal-property property">stat</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">is</span><span class="token operator">:</span> is
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>$</code> 方法中，<code>options</code> 对象是配置项，在该例中指的是 <code>{ target: 'Object', stat: true }</code>。<code>source</code> 对象描述了补丁的具体实现，在该例中指的是 <code>{ is: is }</code>。</p> <p>上述配置的目的是将 <code>is()</code> 方法添加到 <code>Object</code> 对象作为其静态方法: <code>Object.is()</code>。</p> <p>以下是 <code>options</code> 各配置项的含义:</p> <ul><li><p><code>target: string | undefined</code></p> <p>描述 <code>source</code> 中的属性名要添加到的目标对象。</p></li> <li><p><code>global: boolean</code></p> <p><code>source</code> 中的属性名要添加到的目标对象是否是全局对象。</p> <p>以 <code>es.parse-float.js</code> 为例:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/export'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> parseFloatImplementation <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/number-parse-float'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// `parseFloat` method</span>
<span class="token comment">// https://tc39.es/ecma262/#sec-parsefloat-string</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">global</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">forced</span><span class="token operator">:</span> parseFloat <span class="token operator">!=</span> parseFloatImplementation <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">parseFloat</span><span class="token operator">:</span> parseFloatImplementation
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>其配置的 <code>global: true</code> 意味着，<code>parseFloat</code> 会被添加到全局对象上。</p> <p>以 <code>es.object.keys.js</code> 为例:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// `Object.keys` method</span>
<span class="token comment">// https://tc39.es/ecma262/#sec-object.keys</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'Object'</span><span class="token punctuation">,</span> <span class="token literal-property property">stat</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">forced</span><span class="token operator">:</span> <span class="token constant">FAILS_ON_PRIMITIVES</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">keys</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token parameter">it</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">nativeKeys</span><span class="token punctuation">(</span><span class="token function">toObject</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其没有配置 <code>global: true</code>，且配置的 <code>stat: true</code>，意味着，<code>keys()</code> 方法被设置在了 <code>Object</code> 对象上，构成了 <code>Object.keys()</code> 方法。</p></li> <li><p><code>stat: boolean</code></p> <p><code>source</code> 对象中的属性名是否是 <code>target</code> 的静态属性/方法。</p></li> <li><p><code>proto: boolean</code></p> <p>是否添加到 <code>target</code> 描述的对象的 <code>prototype</code>上。</p> <p>例如，<code>es.array.copy-within.js</code> 的内容是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// `Array.prototype.copyWithin` method</span>
<span class="token comment">// https://tc39.es/ecma262/#sec-array.prototype.copywithin</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'Array'</span><span class="token punctuation">,</span> <span class="token literal-property property">proto</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">copyWithin</span><span class="token operator">:</span> copyWithin
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>copyWithin</code> 方法被设置到了 <code>Array.prototype.copyWithin</code>。</p></li> <li><p><code>real</code></p></li> <li><p><code>forced: boolean</code></p> <p>是否强制覆盖原生实现。</p></li> <li><p><code>bind</code></p></li> <li><p><code>wrap</code></p></li> <li><p><code>unsafe</code></p></li> <li><p><code>sham</code></p></li> <li><p><code>enumerable: boolean</code></p></li> <li><p><code>noTargetGet: boolean</code></p></li></ul> <h3 id="ecmascript标准的补丁"><a href="#ecmascript标准的补丁" class="header-anchor">#</a> ECMAScript标准的补丁</h3> <p>ECMAScript 标准涉及的特性比较多，笔者根据标准描述及 <code>core-js</code> 的文档/源码，整理了 ECMAScript 标准特性及其在 <code>core-js</code> 的实现路径。</p> <h4 id="ecmascript-object"><a href="#ecmascript-object" class="header-anchor">#</a> <code>ECMAScript: Object</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.object</code></td> <td><code>core-js(-pure)/es|stable|features/object</code></td></tr> <tr><td></td> <td><code>es.object.assign</code></td> <td><code>core-js(-pure)/es|stable|features/object/assign</code></td></tr> <tr><td></td> <td><code>es.object.is</code></td> <td><code>core-js(-pure)/es|stable|features/object/is</code></td></tr> <tr><td></td> <td><code>es.object.set-prototype-of</code></td> <td><code>core-js(-pure)/es|stable|features/object/set-prototype-of</code></td></tr> <tr><td></td> <td><code>es.object.get-prototype-of</code></td> <td><code>core-js(-pure)/es|stable|features/object/get-prototype-of</code></td></tr> <tr><td></td> <td><code>es.object.get-own-property-descriptor</code></td> <td><code>core-js(-pure)/es|stable|features/object/get-own-property-descriptor</code></td></tr> <tr><td></td> <td><code>es.object.get-own-property-descriptors</code></td> <td><code>core-js(-pure)/es|stable|features/object/get-own-property-descriptors</code></td></tr> <tr><td></td> <td><code>es.object.keys</code></td> <td><code>core-js(-pure)/es|stable|features/object/keys</code></td></tr> <tr><td></td> <td><code>es.object.values</code></td> <td><code>core-js(-pure)/es|stable|features/object/values</code></td></tr> <tr><td></td> <td><code>es.object.entries</code></td> <td><code>core-js(-pure)/es|stable|features/object/entries</code></td></tr> <tr><td></td> <td><code>es.object.get-own-property-names</code></td> <td><code>core-js(-pure)/es|stable|features/object/get-own-property-names</code></td></tr> <tr><td></td> <td><code>es.object.freeze</code></td> <td><code>core-js(-pure)/es|stable|features/object/freeze</code></td></tr> <tr><td></td> <td><code>es.object.from-entries</code></td> <td><code>core-js(-pure)/es|stable|features/object/from-entries</code></td></tr> <tr><td></td> <td><code>es.object.seal</code></td> <td><code>core-js(-pure)/es|stable|features/object/seal</code></td></tr> <tr><td></td> <td><code>es.object.prevent-extensions</code></td> <td><code>core-js(-pure)/es|stable|features/object/prevent-extensions</code></td></tr> <tr><td></td> <td><code>es.object.is-frozen</code></td> <td><code>core-js(-pure)/es|stable|features/object/is-frozen</code></td></tr> <tr><td></td> <td><code>es.object.is-sealed</code></td> <td><code>core-js(-pure)/es|stable|features/object/is-sealed</code></td></tr> <tr><td></td> <td><code>es.object.is-extensible</code></td> <td><code>core-js(-pure)/es|stable|features/object/is-extensible</code></td></tr> <tr><td></td> <td><code>es.object.to-string</code></td> <td><code>core-js/es|stable|features/object/to-string</code></td></tr> <tr><td></td> <td><code>es.object.create</code></td> <td><code>core-js(-pure)/es|stable|features/object/create</code></td></tr> <tr><td></td> <td><code>es.object.define-property</code></td> <td><code>core-js(-pure)/es|stable|features/object/define-property</code></td></tr> <tr><td></td> <td><code>es.object.define-properties</code></td> <td><code>core-js(-pure)/es|stable|features/object/define-properties</code></td></tr> <tr><td></td> <td><code>es.object.define-getter</code></td> <td><code>core-js(-pure)/es|stable|features/object/define-getter</code></td></tr> <tr><td></td> <td><code>es.object.define-setter</code></td> <td><code>core-js(-pure)/es|stable|features/object/define-setter</code></td></tr> <tr><td></td> <td><code>es.object.lookup-getter</code></td> <td><code>core-js(-pure)/es|stable|features/object/lookup-getter</code></td></tr> <tr><td></td> <td><code>es.object.lookup-setter</code></td> <td><code>core-js(-pure)/es|stable|features/object/lookup-setter</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-function"><a href="#ecmascript-function" class="header-anchor">#</a> <code>ECMAScript: Function</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.function</code></td> <td><code>core-js/es|stable|features/function</code></td></tr> <tr><td></td> <td><code>es.function.name</code></td> <td><code>core-js/es|stable|features/function/name</code></td></tr> <tr><td></td> <td><code>es.function.has-instance</code></td> <td><code>core-js/es|stable|features/function/has-instance</code></td></tr> <tr><td></td> <td><code>es.function.bind</code></td> <td><code>core-js/es|stable|features/function/bind</code><br><code>core-js/es|stable|features/function/virtual/bind</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-array"><a href="#ecmascript-array" class="header-anchor">#</a> <code>ECMAScript: Array</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.array</code></td> <td><code>core-js(-pure)/es|stable|features/array</code></td></tr> <tr><td></td> <td><code>es.array.from</code></td> <td><code>core-js(-pure)/es|stable|features/array/from</code></td></tr> <tr><td></td> <td><code>es.array.is-array</code></td> <td><code>core-js(-pure)/es|stable|features/array/is-array</code></td></tr> <tr><td></td> <td><code>es.array.of</code></td> <td><code>core-js(-pure)/es|stable|features/array/of</code></td></tr> <tr><td></td> <td><code>es.array.copy-within</code></td> <td><code>core-js(-pure)/es|stable|features/array/copy-within</code></td></tr> <tr><td></td> <td><code>es.array.fill</code></td> <td><code>core-js(-pure)/es|stable|features/array/fill</code></td></tr> <tr><td></td> <td><code>es.array.find</code></td> <td><code>core-js(-pure)/es|stable|features/array/find</code></td></tr> <tr><td></td> <td><code>es.array.find-index</code></td> <td><code>core-js(-pure)/es|stable|features/array/find-index</code></td></tr> <tr><td></td> <td><code>es.array.iterator</code></td> <td><code>core-js(-pure)/es|stable|features/array/iterator</code></td></tr> <tr><td></td> <td><code>es.array.includes</code></td> <td><code>core-js(-pure)/es|stable|features/array/includes</code></td></tr> <tr><td></td> <td><code>es.array.slice</code></td> <td><code>core-js(-pure)/es|stable|features/array/slice</code></td></tr> <tr><td></td> <td><code>es.array.join</code></td> <td><code>core-js(-pure)/es|stable|features/array/join</code></td></tr> <tr><td></td> <td><code>es.array.index-of</code></td> <td><code>core-js(-pure)/es|stable|features/array/index-of</code></td></tr> <tr><td></td> <td><code>es.array.last-index-of</code></td> <td><code>core-js(-pure)/es|stable|features/array/last-index-of</code></td></tr> <tr><td></td> <td><code>es.array.every</code></td> <td><code>core-js(-pure)/es|stable|features/array/virtual/every</code></td></tr> <tr><td></td> <td><code>es.array.some</code></td> <td><code>core-js(-pure)/es|stable|features/array/virtual/some</code></td></tr> <tr><td></td> <td><code>es.array.for-each</code></td> <td><code>core-js(-pure)/es|stable|features/array/for-each</code></td></tr> <tr><td></td> <td><code>es.array.map</code></td> <td><code>core-js(-pure)/es|stable|features/array/map</code></td></tr> <tr><td></td> <td><code>es.array.filter</code></td> <td><code>core-js(-pure)/es|stable|features/array/filter</code></td></tr> <tr><td></td> <td><code>es.array.reduce</code></td> <td><code>core-js(-pure)/es|stable|features/array/reduce</code></td></tr> <tr><td></td> <td><code>es.array.reduce-right</code></td> <td><code>core-js(-pure)/es|stable|features/array/reduce-right</code></td></tr> <tr><td></td> <td><code>es.array.reverse</code></td> <td><code>core-js(-pure)/es|stable|features/array/reverse</code></td></tr> <tr><td></td> <td><code>es.array.sort</code></td> <td><code>core-js(-pure)/es|stable|features/array/sort</code></td></tr> <tr><td></td> <td><code>es.array.flat</code></td> <td><code>core-js(-pure)/es|stable|features/array/flat</code></td></tr> <tr><td></td> <td><code>es.array.flat-map</code></td> <td><code>core-js(-pure)/es|stable|features/array/flat-map</code></td></tr> <tr><td></td> <td><code>es.array.unscopables.flat</code></td> <td>??</td></tr> <tr><td></td> <td><code>es.array.unscopables.flat-map</code></td> <td>??</td></tr> <tr><td></td> <td><code>es.array.at</code></td> <td><code>core-js(-pure)/es|stable|features/array/at</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-string-and-regexp"><a href="#ecmascript-string-and-regexp" class="header-anchor">#</a> <code>ECMASCript: String and RegExp</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.string</code></td> <td><code>core-js(-pure)/es|stable|features/string</code></td></tr> <tr><td></td> <td><code>es.string.from-code-point</code></td> <td><code>core-js(-pure)/es|stable|features/string/from-code-point</code></td></tr> <tr><td></td> <td><code>es.string.raw</code></td> <td><code>core-js(-pure)/es|stable|features/string/raw</code></td></tr> <tr><td></td> <td><code>es.string.iterator</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/iterator</code></td></tr> <tr><td></td> <td><code>es.string.split</code></td> <td><code>core-js/es|stable|features/string/split</code></td></tr> <tr><td></td> <td><code>es.string.code-point-at</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/code-point-at</code></td></tr> <tr><td></td> <td><code>es.string.ends-with</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/ends-with</code></td></tr> <tr><td></td> <td><code>es.string.includes</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/includes</code></td></tr> <tr><td></td> <td><code>es.string.repeat</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/repeat</code></td></tr> <tr><td></td> <td><code>es.string.pad-start</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/pad-start</code></td></tr> <tr><td></td> <td><code>es.string.pad-end</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/pad-end</code></td></tr> <tr><td></td> <td><code>es.string.starts-with</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/starts-with</code></td></tr> <tr><td></td> <td><code>es.string.trim</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/trim</code></td></tr> <tr><td></td> <td><code>es.string.trim-start</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/trim-start</code></td></tr> <tr><td></td> <td><code>es.string.trim-end</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/trim-end</code></td></tr> <tr><td></td> <td><code>es.string.match-all</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/match-all</code></td></tr> <tr><td></td> <td><code>es.string.replace-all</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/replace-all</code></td></tr> <tr><td></td> <td><code>es.string.at-alternative</code></td> <td>??</td></tr> <tr><td></td> <td><code>es.string.match</code></td> <td><code>core-js/es|stable|features/string/match</code></td></tr> <tr><td></td> <td><code>es.string.replace</code></td> <td><code>core-js/es|stable|features/string/replace</code></td></tr> <tr><td></td> <td><code>es.string.search</code></td> <td><code>core-js/es|stable|features/string/search</code></td></tr> <tr><td></td> <td><code>es.string.split</code></td> <td><code>core-js/es|stable|features/string/split</code></td></tr> <tr><td></td> <td><code>es.string.anchor</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/anchor</code></td></tr> <tr><td></td> <td><code>es.string.big</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/big</code></td></tr> <tr><td></td> <td><code>es.string.blink</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/blink</code></td></tr> <tr><td></td> <td><code>es.string.bold</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/bold</code></td></tr> <tr><td></td> <td><code>es.string.fixed</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/fixed</code></td></tr> <tr><td></td> <td><code>es.string.fontcolor</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/fontcolor</code></td></tr> <tr><td></td> <td><code>es.string.fontsize</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/fontsize</code></td></tr> <tr><td></td> <td><code>es.string.italics</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)(/virtual)/italics</code></td></tr> <tr><td></td> <td><code>es.string.link</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/link</code></td></tr> <tr><td></td> <td><code>es.string.small</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/small</code></td></tr> <tr><td></td> <td><code>es.string.strike</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/strike</code></td></tr> <tr><td></td> <td><code>es.string.sub</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/sub</code></td></tr> <tr><td></td> <td><code>es.string.sup</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/sup</code></td></tr> <tr><td></td> <td><code>es.string.substr</code></td> <td><code>core-js(-pure)/es|stable|features/string(/virtual)/substr</code></td></tr> <tr><td></td> <td><code>es.escape</code></td> <td><code>core-js/es|stable|features/escape</code></td></tr> <tr><td></td> <td><code>es.unescape</code></td> <td><code>core-js/es|stable|features/unescape</code></td></tr> <tr><td></td> <td><code>es.regexp</code></td> <td><code>core-js/es|stable|features/regexp</code></td></tr> <tr><td></td> <td><code>es.regexp.constructor</code></td> <td><code>core-js/es|stable|features/regexp/constructor</code></td></tr> <tr><td></td> <td><code>es.regexp.dot-all</code></td> <td><code>core-js/es|stable|features/regexp/dot-all</code></td></tr> <tr><td></td> <td><code>es.regexp.flags</code></td> <td><code>core-js(-pure)/es|stable|features/regexp/flags</code></td></tr> <tr><td></td> <td><code>es.regexp.sticky</code></td> <td><code>core-js/es|stable|features/regexp/sticky</code></td></tr> <tr><td></td> <td><code>es.regexp.test</code></td> <td><code>core-js/es|stable|features/regexp/test</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-number"><a href="#ecmascript-number" class="header-anchor">#</a> <code>ECMAScript: Number</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.number</code></td> <td><code>core-js(-pure)/es|stable|features/number</code></td></tr> <tr><td></td> <td><code>es.number.constructor</code></td> <td><code>core-js/es|stable|features/number/constructor</code></td></tr> <tr><td></td> <td><code>es.number.epsilon</code></td> <td><code>core-js(-pure)/es|stable|features/number/epsilon</code></td></tr> <tr><td></td> <td><code>es.number.is-finite</code></td> <td><code>core-js(-pure)/es|stable|features/number/is-finite</code></td></tr> <tr><td></td> <td><code>es.number.is-integer</code></td> <td><code>core-js(-pure)/es|stable|features/number/is-integer</code></td></tr> <tr><td></td> <td><code>es.number.is-nan</code></td> <td><code>core-js(-pure)/es|stable|features/number/is-nan</code></td></tr> <tr><td></td> <td><code>es.number.is-safe-integer</code></td> <td><code>core-js(-pure)/es|stable|features/number/is-safe-integer</code></td></tr> <tr><td></td> <td><code>es.number.max-safe-integer</code></td> <td><code>core-js(-pure)/es|stable|features/number/max-safe-integer</code></td></tr> <tr><td></td> <td><code>es.number.min-safe-integer</code></td> <td><code>core-js(-pure)/es|stable|features/number/min-safe-integer</code></td></tr> <tr><td></td> <td><code>es.number.parse-float</code></td> <td><code>core-js(-pure)/es|stable|features/parse-float</code></td></tr> <tr><td></td> <td><code>es.number.parse-int</code></td> <td><code>core-js(-pure)/es|stable|features/parse-int</code></td></tr> <tr><td></td> <td><code>es.number.to-fixed</code></td> <td><code>core-js(-pure)/es|stable|features/number/to-fixed</code></td></tr> <tr><td></td> <td><code>es.number.to-precision</code></td> <td><code>core-js(-pure)/es|stable|features/number/to-precision</code></td></tr> <tr><td></td> <td><code>es.parse-int</code></td> <td><code>core-js(-pure)/es|stable|features/parse-int</code></td></tr> <tr><td></td> <td><code>es.parse-float</code></td> <td><code>core-js(-pure)/es|stable|features/parse-float</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-math"><a href="#ecmascript-math" class="header-anchor">#</a> <code>ECMAScript: Math</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.math</code></td> <td><code>core-js(-pure)/es|stable|features/math</code></td></tr> <tr><td></td> <td><code>es.math.acosh</code></td> <td><code>core-js(-pure)/es|stable|features/math/acosh</code></td></tr> <tr><td></td> <td><code>es.math.asinh</code></td> <td><code>core-js(-pure)/es|stable|features/math/asinh</code></td></tr> <tr><td></td> <td><code>es.math.atanh</code></td> <td><code>core-js(-pure)/es|stable|features/math/atanh</code></td></tr> <tr><td></td> <td><code>es.math.cbrt</code></td> <td><code>core-js(-pure)/es|stable|features/math/cbrt</code></td></tr> <tr><td></td> <td><code>es.math.clz32</code></td> <td><code>core-js(-pure)/es|stable|features/math/clz32</code></td></tr> <tr><td></td> <td><code>es.math.cosh</code></td> <td><code>core-js(-pure)/es|stable|features/math/cosh</code></td></tr> <tr><td></td> <td><code>es.math.expm1</code></td> <td><code>core-js(-pure)/es|stable|features/math/expm1</code></td></tr> <tr><td></td> <td><code>es.math.fround</code></td> <td><code>core-js(-pure)/es|stable|features/math/fround</code></td></tr> <tr><td></td> <td><code>es.math.hypot</code></td> <td><code>core-js(-pure)/es|stable|features/math/hypot</code></td></tr> <tr><td></td> <td><code>es.math.imul</code></td> <td><code>core-js(-pure)/es|stable|features/math/imul</code></td></tr> <tr><td></td> <td><code>es.math.log10</code></td> <td><code>core-js(-pure)/es|stable|features/math/log10</code></td></tr> <tr><td></td> <td><code>es.math.log1p</code></td> <td><code>core-js(-pure)/es|stable|features/math/log1p</code></td></tr> <tr><td></td> <td><code>es.math.log2</code></td> <td><code>core-js(-pure)/es|stable|features/math/log2</code></td></tr> <tr><td></td> <td><code>es.math.sign</code></td> <td><code>core-js(-pure)/es|stable|features/math/sign</code></td></tr> <tr><td></td> <td><code>es.math.sinh</code></td> <td><code>core-js(-pure)/es|stable|features/math/sinh</code></td></tr> <tr><td></td> <td><code>es.math.tanh</code></td> <td><code>core-js(-pure)/es|stable|features/math/tanh</code></td></tr> <tr><td></td> <td><code>es.math.trunc</code></td> <td><code>core-js(-pure)/es|stable|features/math/trunc</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-date"><a href="#ecmascript-date" class="header-anchor">#</a> <code>ECMAScript: Date</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.date</code></td> <td><code>core-js/es|stable|features/date</code></td></tr> <tr><td></td> <td><code>es.date.to-string</code></td> <td><code>core-js/es|stable|features/date/to-string</code></td></tr> <tr><td></td> <td><code>es.date.now</code></td> <td><code>core-js(-pure)/es|stable|features/date/now</code></td></tr> <tr><td></td> <td><code>es.date.to-iso-string</code></td> <td><code>core-js(-pure)/es|stable|features/date/to-iso-string</code></td></tr> <tr><td></td> <td><code>es.date.to-json</code></td> <td><code>core-js(-pure)/es|stable|features/date/to-json</code></td></tr> <tr><td></td> <td><code>es.date.to-primitive</code></td> <td><code>core-js(-pure)/es|stable|features/date/to-primitive</code></td></tr> <tr><td></td> <td><code>es.date.get-year</code></td> <td><code>core-js(-pure)/es|stable|features/date/get-year</code></td></tr> <tr><td></td> <td><code>es.date.set-year</code></td> <td><code>core-js(-pure)/es|stable|features/date/set-year</code></td></tr> <tr><td></td> <td><code>es.date.to-gmt-string</code></td> <td><code>core-js(-pure)/es|stable|features/date/to-gmt-string</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-promise"><a href="#ecmascript-promise" class="header-anchor">#</a> <code>ECMAScript: Promise</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.aggregate-error</code></td> <td><code>core-js(-pure)/es|stable|features/aggregate-error</code></td></tr> <tr><td></td> <td><code>es.promise</code></td> <td><code>core-js(-pure)/es|stable|features/promise</code></td></tr> <tr><td></td> <td><code>es.promise.all-settled</code></td> <td><code>core-js(-pure)/es|stable|features/promise/all-settled</code></td></tr> <tr><td></td> <td><code>es.promise.any</code></td> <td><code>core-js(-pure)/es|stable|features/promise/any</code></td></tr> <tr><td></td> <td><code>es.promise.finally</code></td> <td><code>core-js(-pure)/es|stable|features/promise/finally</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-symbol"><a href="#ecmascript-symbol" class="header-anchor">#</a> <code>ECMAScript: Symbol</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.symbol</code></td> <td><code>core-js(-pure)/es|stable|features/symbol</code></td></tr> <tr><td></td> <td><code>es.symbol.async-iterator</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/async-iterator</code></td></tr> <tr><td></td> <td><code>es.symbol.description</code></td> <td><code>core-js/es|stable|features/symbol/description</code></td></tr> <tr><td></td> <td><code>es.symbol.has-instance</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/has-instance</code></td></tr> <tr><td></td> <td><code>es.symbol.is-concat-spreadable</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/is-concat-spreadable</code></td></tr> <tr><td></td> <td><code>es.symbol.iterator</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/iterator</code></td></tr> <tr><td></td> <td><code>es.symbol.match</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/match</code></td></tr> <tr><td></td> <td><code>es.symbol.replace</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/replace</code></td></tr> <tr><td></td> <td><code>es.symbol.search</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/search</code></td></tr> <tr><td></td> <td><code>es.symbol.species</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/species</code></td></tr> <tr><td></td> <td><code>es.symbol.split</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/split</code></td></tr> <tr><td></td> <td><code>es.symbol.to-primitive</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/to-primitive</code></td></tr> <tr><td></td> <td><code>es.symbol.to-string-tag</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/to-string-tag</code></td></tr> <tr><td></td> <td><code>es.symbol.unscopables</code></td> <td><code>core-js(-pure)/es|stable|features/symbol/unscopables</code></td></tr> <tr><td></td> <td></td> <td><code>core-js(-pure)/es|stable|features/symbol/for</code></td></tr> <tr><td></td> <td></td> <td><code>core-js(-pure)/es|stable|features/symbol/key-for</code></td></tr> <tr><td></td> <td></td> <td><code>core-js(-pure)/es|stable|features/object/get-own-property-symbols</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-collections"><a href="#ecmascript-collections" class="header-anchor">#</a> <code>ECMAScript: Collections</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td>Map</td> <td><code>es.map</code></td> <td><code>core-js(-pure)/es|stable|features/map</code></td></tr> <tr><td>Set</td> <td><code>es.set</code></td> <td><code>core-js(-pure)/es|stable|features/set</code></td></tr> <tr><td>WeakMap</td> <td><code>es.weak-map</code></td> <td><code>core-js(-pure)/es|stable|features/weak-map</code></td></tr> <tr><td>WeakSet</td> <td><code>es.weak-set</code></td> <td><code>core-js(-pure)/es|stable|features/weak-set</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-typed-arrays"><a href="#ecmascript-typed-arrays" class="header-anchor">#</a> <code>ECMAScript: Typed Arrays</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.array-buffer</code></td> <td><code>core-js/es|stable|features/array-buffer</code></td></tr> <tr><td></td> <td><code>es.array-buffer.constructor</code></td> <td><code>core-js/es|stable|features/array-buffer/constructor</code></td></tr> <tr><td></td> <td><code>es.array-buffer.is-view</code></td> <td><code>core-js/es|stable|features/array-buffer/is-view</code></td></tr> <tr><td></td> <td><code>es.array-buffer.slice</code></td> <td><code>core-js/es|stable|features/array-buffer/slice</code></td></tr> <tr><td></td> <td><code>es.data-view</code></td> <td><code>core-js/es|stable|features/data-view</code></td></tr> <tr><td></td> <td><code>es.typed-array</code></td> <td><code>core-js/es|stable|features/typed-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.int8-array</code></td> <td><code>core-js/es|stable|features/typed-array/int8-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.uint8-array</code></td> <td><code>core-js/es|stable|features/typed-array/uint8-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.uint8-clamped-array</code></td> <td><code>core-js/es|stable|features/typed-array/uint8-clamped-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.int16-array</code></td> <td><code>core-js/es|stable|features/typed-array/int16-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.uint16-array</code></td> <td><code>core-js/es|stable|features/typed-array/uint16-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.int32-array</code></td> <td><code>core-js/es|stable|features/typed-array/int32-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.uint32-array</code></td> <td><code>core-js/es|stable|features/typed-array/uint32-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.float32-array</code></td> <td><code>core-js/es|stable|features/typed-array/float32-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.float64-array</code></td> <td><code>core-js/es|stable|features/typed-array/float64-array</code></td></tr> <tr><td></td> <td><code>es.typed-array.copy-within</code></td> <td><code>core-js/es|stable|features/typed-array/copy-within</code></td></tr> <tr><td></td> <td><code>es.typed-array.every</code></td> <td><code>core-js/es|stable|features/typed-array/every</code></td></tr> <tr><td></td> <td><code>es.typed-array.fill</code></td> <td><code>core-js/es|stable|features/typed-array/fill</code></td></tr> <tr><td></td> <td><code>es.typed-array.filter</code></td> <td><code>core-js/es|stable|features/typed-array/filter</code></td></tr> <tr><td></td> <td><code>es.typed-array.find</code></td> <td><code>core-js/es|stable|features/typed-array/find</code></td></tr> <tr><td></td> <td><code>es.typed-array.find-index</code></td> <td><code>core-js/es|stable|features/typed-array/find-index</code></td></tr> <tr><td></td> <td><code>es.typed-array.for-each</code></td> <td><code>core-js/es|stable|features/typed-array/for-each</code></td></tr> <tr><td></td> <td><code>es.typed-array.from</code></td> <td><code>core-js/es|stable|features/typed-array/from</code></td></tr> <tr><td></td> <td><code>es.typed-array.includes</code></td> <td><code>core-js/es|stable|features/typed-array/includes</code></td></tr> <tr><td></td> <td><code>es.typed-array.index-of</code></td> <td><code>core-js/es|stable|features/typed-array/index-of</code></td></tr> <tr><td></td> <td><code>es.typed-array.iterator</code></td> <td><code>core-js/es|stable|features/typed-array/iterator</code></td></tr> <tr><td></td> <td><code>es.typed-array.last-index-of</code></td> <td><code>core-js/es|stable|features/typed-array/last-index-of</code></td></tr> <tr><td></td> <td><code>es.typed-array.map</code></td> <td><code>core-js/es|stable|features/typed-array/map</code></td></tr> <tr><td></td> <td><code>es.typed-array.of</code></td> <td><code>core-js/es|stable|features/typed-array/of</code></td></tr> <tr><td></td> <td><code>es.typed-array.reduce</code></td> <td><code>core-js/es|stable|features/typed-array/reduce</code></td></tr> <tr><td></td> <td><code>es.typed-array.reduce-right</code></td> <td><code>core-js/es|stable|features/typed-array/reduce-right</code></td></tr> <tr><td></td> <td><code>es.typed-array.reverse</code></td> <td><code>core-js/es|stable|features/typed-array/reverse</code></td></tr> <tr><td></td> <td><code>es.typed-array.set</code></td> <td><code>core-js/es|stable|features/typed-array/set</code></td></tr> <tr><td></td> <td><code>es.typed-array.slice</code></td> <td><code>core-js/es|stable|features/typed-array/slice</code></td></tr> <tr><td></td> <td><code>es.typed-array.some</code></td> <td><code>core-js/es|stable|features/typed-array/some</code></td></tr> <tr><td></td> <td><code>es.typed-array.sort</code></td> <td><code>core-js/es|stable|features/typed-array/sort</code></td></tr> <tr><td></td> <td><code>es.typed-array.subarray</code></td> <td><code>core-js/es|stable|features/typed-array/subarray</code></td></tr> <tr><td></td> <td><code>es.typed-array.to-locale-string</code></td> <td><code>core-js/es|stable|features/typed-array/to-locale-string</code></td></tr> <tr><td></td> <td><code>es.typed-array.to-string</code></td> <td><code>core-js/es|stable|features/typed-array/to-string</code></td></tr> <tr><td></td> <td><code>es.typed-array.at</code></td> <td><code>core-js/es|stable|features/typed-array/at</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-reflect"><a href="#ecmascript-reflect" class="header-anchor">#</a> <code>ECMAScript: Reflect</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.reflect</code></td> <td><code>core-js(-pure)/es|stable|features/reflect</code></td></tr> <tr><td></td> <td><code>es.reflect.apply</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/apply</code></td></tr> <tr><td></td> <td><code>es.reflect.construct</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/construct</code></td></tr> <tr><td></td> <td><code>es.reflect.define-property</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/define-property</code></td></tr> <tr><td></td> <td><code>es.reflect.delete-property</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/delete-property</code></td></tr> <tr><td></td> <td><code>es.reflect.get</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/get</code></td></tr> <tr><td></td> <td><code>es.reflect.get-own-property-descriptor</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/get-own-property-descriptor</code></td></tr> <tr><td></td> <td><code>es.reflect.get-prototype-of</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/get-prototype-of</code></td></tr> <tr><td></td> <td><code>es.reflect.has</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/has</code></td></tr> <tr><td></td> <td><code>es.reflect.is-extensible</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/is-extensible</code></td></tr> <tr><td></td> <td><code>es.reflect.own-keys</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/own-keys</code></td></tr> <tr><td></td> <td><code>es.reflect.prevent-extensions</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/prevent-extensions</code></td></tr> <tr><td></td> <td><code>es.reflect.set</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/set</code></td></tr> <tr><td></td> <td><code>es.reflect.set-prototype-of</code></td> <td><code>core-js(-pure)/es|stable|features/reflect/set-prototype-of</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-json"><a href="#ecmascript-json" class="header-anchor">#</a> <code>ECMAScript: JSON</code></h4> <ul><li><p>特例列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.json.to-string-tag</code></td> <td><code>core-js(-pure)/es|stable|features/json/to-string-tag</code></td></tr> <tr><td></td> <td><code>es.json.stringify</code></td> <td><code>core-js(-pure)/es|stable|features/json/stringify</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="ecmascript-globalthis"><a href="#ecmascript-globalthis" class="header-anchor">#</a> <code>ECMAScript: globalThis</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>es.global-this</code></td> <td><code>core-js(-pure)/es|stable|features/global-this</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>文件 <code>core-js/packages/core-js/internals/global.js</code> 定义了全局对象的实现，代码如下:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">check</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">it</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> it <span class="token operator">&amp;&amp;</span> it<span class="token punctuation">.</span>Math <span class="token operator">==</span> Math <span class="token operator">&amp;&amp;</span> it<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// https://github.com/zloirock/core-js/issues/86#issuecomment-115759028</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span>
    <span class="token comment">// eslint-disable-next-line es/no-global-this -- safe</span>
    <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> globalThis <span class="token operator">==</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> globalThis<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">==</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token comment">// eslint-disable-next-line no-restricted-globals -- safe</span>
    <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> self <span class="token operator">==</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> self<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> global <span class="token operator">==</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> global<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token comment">// eslint-disable-next-line no-new-func -- fallback</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">Function</span><span class="token punctuation">(</span><span class="token string">'return this'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>可以看到，定义全局对象的过程有以下特点:</p> <ul><li><p>判断全局对象的先后顺序</p> <p>依次是: <code>globalThis</code>、<code>window</code>、<code>self</code>、<code>global</code>、自定义方法获取。</p></li> <li><p>自定义方法获取全局对象</p> <p>用立即执行函数获取全局对象，优先使用 <code>(function () { return this; })()</code>，其次使用 <code>Function('return this')()</code>。</p></li> <li><p>判断全局对象是否有效</p> <p><code>check</code> 函数用于校验对象是否是有效的全局对象，判断该对象的 <code>Math</code> 属性是否和全局的 <code>Math</code> 变量一致。</p></li></ul></li></ul> <h3 id="ecmascript提案的补丁"><a href="#ecmascript提案的补丁" class="header-anchor">#</a> ECMAScript提案的补丁</h3> <h4 id="stage-4-proposals"><a href="#stage-4-proposals" class="header-anchor">#</a> <code>Stage 4 proposals</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td><code>globalThis</code></td> <td><code>es.global-this</code></td> <td><code>core-js/proposals/global-this</code><br><code>core-js(-pure)/es|stable|features/global-this</code></td></tr> <tr><td><code>String#matchAll</code></td> <td><code>es.string.match-all</code></td> <td><code>core-js/proposals/string-match-all</code><br><code>core-js/es|stable|features/string/match-all</code></td></tr> <tr><td><code>String#replaceAll</code></td> <td><code>es.string.replace-all</code></td> <td><code>core-js/proposals/string-replace-all</code><br><code>core-js/es|stable|features/string/replace-all</code></td></tr> <tr><td><code>Promise.allSettled</code></td> <td><code>es.promise.all-settled</code></td> <td><code>core-js/proposals/promise-all-settled</code><br><code>core-js(-pure)/es|stable|features/promise/all-settled</code></td></tr> <tr><td><code>Promise.any</code></td> <td><code>es.promise.any</code></td> <td><code>core-js/proposals/promise-any</code><br><code>core-js(-pure)/es|stable|features/promise/any</code></td></tr> <tr><td><code>Promise.any</code></td> <td><code>es.aggregate-error</code></td> <td><code>core-js(-pure)/es|stable|features/aggregate-error</code></td></tr> <tr><td><code>Object.prototype.hasOwnProperty</code></td> <td><code>es.object.has-own</code></td> <td><code>core-js/proposals/accessible-object-hasownproperty</code><br><code>core-js(-pure)/es|stable|features/object/has-own</code></td></tr> <tr><td></td> <td><code>es.array.at</code></td> <td></td></tr> <tr><td></td> <td><code>es.string.at-alternative</code></td> <td></td></tr> <tr><td>Relative indexing method</td> <td></td> <td><code>core-js/proposals/relative-indexing-method</code></td></tr> <tr><td>Relative indexing method</td> <td><code>es.typed-array.at</code></td> <td><code>core-js(-pure)/es|stable|features/array/at</code></td></tr> <tr><td>Relative indexing method</td> <td></td> <td><code>core-js(-pure)/es|stable|features/string/at</code></td></tr> <tr><td>Relative indexing method</td> <td><code>es.typed-array.at</code></td> <td><code>core-js(-pure)/es|stable|features/typed-array/at</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="stage-3-proposals"><a href="#stage-3-proposals" class="header-anchor">#</a> <code>Stage 3 proposals</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>esnext.array.find-last</code></td> <td><code>core-js(-pure)/features(/virtual)/array/find-last</code></td></tr> <tr><td></td> <td><code>esnext.array.find-last-index</code></td> <td><code>core-js(-pure)/features(/virtual)/array/find-last-index</code></td></tr> <tr><td></td> <td><code>esnext.typed-array.find-last</code></td> <td><code>core-js/features/typed-array/find-last</code></td></tr> <tr><td></td> <td><code>esnext.typed-array.find-last-index</code></td> <td><code>core-js/features/typed-array/find-last-index</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="stage-2-proposals"><a href="#stage-2-proposals" class="header-anchor">#</a> <code>Stage 2 proposals</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td>Iterator helpers</td> <td></td> <td><code>core-js/proposals/iterator-helpers</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.constructor</code></td> <td></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.as-indexed-pairs</code></td> <td><code>core-js(-pure)/features/async-iterator/as-indexed-pairs</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.drop</code></td> <td><code>core-js(-pure)/features/async-iterator/drop</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.every</code></td> <td><code>core-js(-pure)/features/async-iterator/every</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.filter</code></td> <td><code>core-js(-pure)/features/async-iterator/filter</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.find</code></td> <td><code>core-js(-pure)/features/async-iterator/find</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.flat-map</code></td> <td><code>core-js(-pure)/features/async-iterator/flat-map</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.for-each</code></td> <td><code>core-js(-pure)/features/async-iterator/for-each</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.from</code></td> <td><code>core-js(-pure)/features/async-iterator/from</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.map</code></td> <td><code>core-js(-pure)/features/async-iterator/map</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.reduce</code></td> <td><code>core-js(-pure)/features/async-iterator/reduce</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.some</code></td> <td><code>core-js(-pure)/features/async-iterator/some</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.take</code></td> <td><code>core-js(-pure)/features/async-iterator/take</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.async-iterator.to-array</code></td> <td><code>core-js(-pure)/features/async-iterator/to-array</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.constructor</code></td> <td></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.as-indexed-pairs</code></td> <td><code>core-js(-pure)/features/iterator/as-indexed-pairs</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.drop</code></td> <td><code>core-js(-pure)/features/iterator/drop</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.every</code></td> <td><code>core-js(-pure)/features/iterator/every</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.filter</code></td> <td><code>core-js(-pure)/features/iterator/filter</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.find</code></td> <td><code>core-js(-pure)/features/iterator/find</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.flat-map</code></td> <td><code>core-js(-pure)/features/iterator/flat-map</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.for-each</code></td> <td><code>core-js(-pure)/features/iterator/for-each</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.from</code></td> <td><code>core-js(-pure)/features/iterator/from</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.map</code></td> <td><code>core-js(-pure)/features/iterator/map</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.reduce</code></td> <td><code>core-js(-pure)/features/iterator/reduce</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.some</code></td> <td><code>core-js(-pure)/features/iterator/some</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.take</code></td> <td><code>core-js(-pure)/features/iterator/take</code></td></tr> <tr><td>Iterator helpers</td> <td><code>esnext.iterator.to-array</code></td> <td><code>core-js(-pure)/features/iterator/to-array</code></td></tr> <tr><td>esnext.set.difference`</td> <td></td> <td></td></tr> <tr><td>New Set methods</td> <td></td> <td><code>core-js/proposals/set-methods</code></td></tr> <tr><td>New Set methods</td> <td><code>esnext.set.intersection</code></td> <td><code>core-js(-pure)/features/set/intersection</code></td></tr> <tr><td>New Set methods</td> <td><code>esnext.set.is-disjoint-from</code></td> <td><code>core-js(-pure)/features/set/is-disjoint-from</code></td></tr> <tr><td>New Set methods</td> <td><code>esnext.set.is-subset-of</code></td> <td><code>core-js(-pure)/features/set/is-subset-of</code></td></tr> <tr><td>New Set methods</td> <td><code>esnext.set.is-superset-of</code></td> <td><code>core-js(-pure)/features/set/is-superset-of</code></td></tr> <tr><td>New Set methods</td> <td><code>esnext.set.symmetric-difference</code></td> <td><code>core-js(-pure)/features/set/symmetric-difference</code></td></tr> <tr><td>New Set methods</td> <td><code>esnext.set.union</code></td> <td><code>core-js(-pure)/features/set/union</code></td></tr> <tr><td>Map.prototype.emplace</td> <td><code>esnext.map.emplace</code></td> <td><code>core-js(-pure)/features/map/emplace</code></td></tr> <tr><td>Map.prototype.emplace</td> <td><code>esnext.weak-map.emplace</code></td> <td><code>core-js(-pure)/features/weak-map/emplace</code></td></tr> <tr><td>Array.isTemplateObject</td> <td><code>esnext.array.is-template-object</code></td> <td><code>core-js/proposals/array-is-template-object</code><br><code>core-js(-pure)/features/array/is-template-object</code></td></tr> <tr><td></td> <td><code>esnext.symbol.dispose</code></td> <td><code>core-js(-pure)/features/symbol/dispose</code></td></tr> <tr><td></td> <td><code>esnext.symbol.async-dispose</code></td> <td><code>core-js(-pure)/features/symbol/async-dispose</code></td></tr> <tr><td></td> <td><code>esnext.symbol.metadata</code></td> <td><code>core-js/proposals/decorators</code><br><code>core-js(-pure)/features/symbol/metadata</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="stage-1-proposals"><a href="#stage-1-proposals" class="header-anchor">#</a> <code>Stage 1 proposals</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>esnext.observable</code></td> <td><code>core-js/proposals/observable</code><br><code>core-js(-pure)/features/observable</code></td></tr> <tr><td></td> <td><code>esnext.symbol.observable</code></td> <td><code>core-js(-pure)/features/symbol/observable</code></td></tr> <tr><td></td> <td><code>esnext.set.add-all</code></td> <td><code>core-js(-pure)/features/set/add-all</code></td></tr> <tr><td></td> <td><code>esnext.set.delete-all</code></td> <td><code>core-js(-pure)/features/set/delete-all</code></td></tr> <tr><td></td> <td><code>esnext.set.every</code></td> <td><code>core-js(-pure)/features/set/every</code></td></tr> <tr><td></td> <td><code>esnext.set.filter</code></td> <td><code>core-js(-pure)/features/set/filter</code></td></tr> <tr><td></td> <td><code>esnext.set.find</code></td> <td><code>core-js(-pure)/features/set/find</code></td></tr> <tr><td></td> <td><code>esnext.set.join</code></td> <td><code>core-js(-pure)/features/set/join</code></td></tr> <tr><td></td> <td><code>esnext.set.map</code></td> <td><code>core-js(-pure)/features/set/map</code></td></tr> <tr><td></td> <td><code>esnext.set.reduce</code></td> <td><code>core-js(-pure)/features/set/reduce</code></td></tr> <tr><td></td> <td><code>esnext.set.some</code></td> <td><code>core-js(-pure)/features/set/some</code></td></tr> <tr><td></td> <td><code>esnext.map.delete-all</code></td> <td><code>core-js(-pure)/features/map/delete-all</code></td></tr> <tr><td></td> <td><code>esnext.map.every</code></td> <td><code>core-js(-pure)/features/map/every</code></td></tr> <tr><td></td> <td><code>esnext.map.filter</code></td> <td><code>core-js(-pure)/features/map/filter</code></td></tr> <tr><td></td> <td><code>esnext.map.find</code></td> <td><code>core-js(-pure)/features/map/find</code></td></tr> <tr><td></td> <td><code>esnext.map.find-key</code></td> <td><code>core-js(-pure)/features/map/find-key</code></td></tr> <tr><td></td> <td><code>esnext.map.group-by</code></td> <td><code>core-js(-pure)/features/map/group-by</code></td></tr> <tr><td></td> <td><code>esnext.map.includes</code></td> <td><code>core-js(-pure)/features/map/includes</code></td></tr> <tr><td></td> <td><code>esnext.map.key-by</code></td> <td><code>core-js(-pure)/features/map/key-by</code></td></tr> <tr><td></td> <td><code>esnext.map.key-of</code></td> <td><code>core-js(-pure)/features/map/key-of</code></td></tr> <tr><td></td> <td><code>esnext.map.map-keys</code></td> <td><code>core-js(-pure)/features/map/map-keys</code></td></tr> <tr><td></td> <td><code>esnext.map.map-values</code></td> <td><code>core-js(-pure)/features/map/map-values</code></td></tr> <tr><td></td> <td><code>esnext.map.merge</code></td> <td><code>core-js(-pure)/features/map/merge</code></td></tr> <tr><td></td> <td><code>esnext.map.reduce</code></td> <td><code>core-js(-pure)/features/map/reduce</code></td></tr> <tr><td></td> <td><code>esnext.map.some</code></td> <td><code>core-js(-pure)/features/map/some</code></td></tr> <tr><td></td> <td><code>esnext.map.update</code></td> <td><code>core-js(-pure)/features/map/update</code></td></tr> <tr><td></td> <td><code>esnext.weak-set.add-all</code></td> <td><code>core-js(-pure)/features/weak-set/add-all</code></td></tr> <tr><td></td> <td><code>esnext.weak-set.delete-all</code></td> <td><code>core-js(-pure)/features/weak-set/delete-all</code></td></tr> <tr><td></td> <td><code>esnext.weak-map.delete-all</code></td> <td><code>core-js(-pure)/features/weak-map/delete-all</code></td></tr> <tr><td></td> <td><code>esnext.set.of</code></td> <td><code>core-js(-pure)/features/weak-set/of</code></td></tr> <tr><td></td> <td><code>esnext.set.from</code></td> <td><code>core-js(-pure)/features/weak-set/from</code></td></tr> <tr><td></td> <td><code>esnext.map.of</code></td> <td><code>core-js(-pure)/features/weak-map/of</code></td></tr> <tr><td></td> <td><code>esnext.map.from</code></td> <td><code>core-js(-pure)/features/weak-map/from</code></td></tr> <tr><td></td> <td><code>esnext.weak-set.of</code></td> <td><code>core-js(-pure)/features/weak-set/of</code></td></tr> <tr><td></td> <td><code>esnext.weak-set.from</code></td> <td><code>core-js(-pure)/features/weak-set/from</code></td></tr> <tr><td></td> <td><code>esnext.weak-map.of</code></td> <td><code>core-js(-pure)/features/weak-map/of</code></td></tr> <tr><td></td> <td><code>esnext.weak-map.from</code></td> <td><code>core-js(-pure)/features/weak-map/from</code></td></tr> <tr><td></td> <td><code>esnext.composite-key</code></td> <td><code>core-js/proposals/keys-composition</code><br><code>core-js(-pure)/features/composite-key</code></td></tr> <tr><td></td> <td><code>esnext.composite-symbol</code></td> <td><code>core-js(-pure)/features/composite-symbol</code></td></tr> <tr><td></td> <td><code>esnext.array.filter-reject</code></td> <td><code>core-js(-pure)/features/weak-set/from</code></td></tr> <tr><td></td> <td><code>esnext.esnext.array.filter-reject</code></td> <td><code>core-js/proposals/array-filtering</code><br><code>core-js(-pure)/features/array(/virtual)/filter-reject</code></td></tr> <tr><td></td> <td><code>esnext.typed-array.filter-reject</code></td> <td><code>core-js/features/typed-array/filter-reject</code></td></tr> <tr><td></td> <td><code>esnext.array.group-by</code></td> <td><code>core-js/proposals/array-grouping</code><br><code>core-js(-pure)/features/array(/virtual)/group-by</code></td></tr> <tr><td></td> <td><code>esnext.typed-array.group-by</code></td> <td><code>core-js/features/typed-array/group-by</code></td></tr> <tr><td></td> <td><code>esnext.array.unique-by</code></td> <td><code>core-js/proposals/array-unique</code><br><code>core-js(-pure)/features/array(/virtual)/unique-by</code></td></tr> <tr><td></td> <td><code>esnext.typed-array.unique-by</code></td> <td><code>core-js/features/typed-array/unique-by</code></td></tr> <tr><td></td> <td><code>esnext.array.last-item</code></td> <td><code>core-js/proposals/array-last</code><br><code>core-js/features/array/last-item</code></td></tr> <tr><td></td> <td><code>esnext.array.last-index</code></td> <td><code>core-js/features/array/last-index</code></td></tr> <tr><td></td> <td><code>esnext.number.range</code></td> <td><code>core-js/proposals/number-range</code><br><code>core-js(-pure)/features/bigint/range</code></td></tr> <tr><td></td> <td><code>esnext.bigint.range</code></td> <td><code>core-js(-pure)/features/number/range</code></td></tr> <tr><td></td> <td><code>esnext.number.from-string</code></td> <td><code>core-js/proposals/number-from-string</code><br><code>core-js(-pure)/features/number/from-string</code></td></tr> <tr><td></td> <td><code>esnext.math.clamp</code></td> <td><code>core-js(-pure)/features/math/clamp</code></td></tr> <tr><td></td> <td><code>esnext.math.deg-per-rad</code></td> <td><code>core-js(-pure)/features/math/deg-per-rad</code></td></tr> <tr><td></td> <td><code>esnext.math.degrees</code></td> <td><code>core-js(-pure)/features/math/degrees</code></td></tr> <tr><td></td> <td><code>esnext.math.fscale</code></td> <td><code>core-js(-pure)/features/math/fscale</code></td></tr> <tr><td></td> <td><code>esnext.math.rad-per-deg</code></td> <td><code>core-js(-pure)/features/math/rad-per-deg</code></td></tr> <tr><td></td> <td><code>esnext.math.radians</code></td> <td><code>core-js(-pure)/features/math/radians</code></td></tr> <tr><td></td> <td><code>esnext.math.scale</code></td> <td><code>core-js(-pure)/features/math/scale</code></td></tr> <tr><td></td> <td><code>esnext.math.signbit</code></td> <td><code>core-js/proposals/math-signbit</code><br><code>core-js(-pure)/features/math/signbit</code></td></tr> <tr><td></td> <td><code>esnext.string.code-points</code></td> <td><code>core-js/proposals/string-code-points</code><br><code>core-js(-pure)/features/string/code-points</code></td></tr> <tr><td></td> <td><code>esnext.symbol.matcher</code></td> <td><code>core-js/proposals/pattern-matching</code><br><code>core-js(-pure)/features/symbol/matcher</code></td></tr> <tr><td></td> <td><code>esnext.math.seeded-prng</code></td> <td><code>core-js/proposals/seeded-random</code><br><code>core-js(-pure)/features/math/seeded-prng</code></td></tr> <tr><td></td> <td></td> <td><code>core-js/proposals/object-iteration</code></td></tr> <tr><td></td> <td><code>esnext.object.iterate-keys</code></td> <td><code>core-js(-pure)/features/object/iterate-keys</code></td></tr> <tr><td></td> <td><code>esnext.object.iterate-values</code></td> <td><code>core-js(-pure)/features/object/iterate-values</code></td></tr> <tr><td></td> <td><code>esnext.object.iterate-entries</code></td> <td><code>core-js(-pure)/features/object/iterate-entries</code></td></tr> <tr><td></td> <td><code>esnext.promise.try</code></td> <td><code>core-js/proposals/promise-try</code><br><code>core-js(-pure)/features/promise/try</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="stage-0-proposals"><a href="#stage-0-proposals" class="header-anchor">#</a> <code>Stage 0 proposals</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>URL</code></td> <td></td></tr> <tr><td></td> <td><code>esnext.string.at</code></td> <td><code>core-js/proposals/string-at</code><br><code>core-js(-pure)/features/string/at</code><br><code>core-js(-pure)/features/string/virtual/</code></td></tr> <tr><td></td> <td></td> <td><code>core-js/proposals/efficient-64-bit-arithmetic</code></td></tr> <tr><td></td> <td><code>esnext.math.iaddh</code></td> <td><code>core-js(-pure)/features/math/iaddh</code></td></tr> <tr><td></td> <td><code>esnext.math.isubh</code></td> <td><code>core-js(-pure)/features/math/isubh</code></td></tr> <tr><td></td> <td><code>esnext.math.imulh</code></td> <td><code>core-js(-pure)/features/math/imulh</code></td></tr> <tr><td></td> <td><code>esnext.math.umulh</code></td> <td><code>core-js(-pure)/features/math/umulh</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h4 id="pre-stage-0-proposals"><a href="#pre-stage-0-proposals" class="header-anchor">#</a> <code>Pre-stage 0 proposals</code></h4> <ul><li><p>特性列表</p> <table><thead><tr><th>分类</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td></td> <td><code>core-js/proposals/reflect-metadata</code></td></tr> <tr><td></td> <td><code>esnext.reflect.define-metadata</code></td> <td><code>core-js(-pure)/features/reflect/define-metadata</code></td></tr> <tr><td></td> <td><code>esnext.reflect.delete-metadata</code></td> <td><code>core-js(-pure)/features/reflect/delete-metadata</code></td></tr> <tr><td></td> <td><code>esnext.reflect.get-metadata</code></td> <td><code>core-js(-pure)/features/reflect/get-metadata</code></td></tr> <tr><td></td> <td><code>esnext.reflect.get-metadata-keys</code></td> <td><code>core-js(-pure)/features/reflect/get-metadata-keys</code></td></tr> <tr><td></td> <td><code>esnext.reflect.get-own-metadata</code></td> <td><code>core-js(-pure)/features/reflect/get-own-metadata</code></td></tr> <tr><td></td> <td><code>esnext.reflect.get-own-metadata-keys</code></td> <td><code>core-js(-pure)/features/reflect/get-own-metadata-keys</code></td></tr> <tr><td></td> <td><code>esnext.reflect.has-metadata</code></td> <td><code>core-js(-pure)/features/reflect/has-metadata</code></td></tr> <tr><td></td> <td><code>esnext.reflect.has-own-metadata</code></td> <td><code>core-js(-pure)/features/reflect/has-own-metadata</code></td></tr> <tr><td></td> <td><code>esnext.reflect.metadata</code></td> <td><code>core-js(-pure)/features/reflect/metadata</code></td></tr></tbody></table></li> <li><p>重点实现</p> <p>TODO</p></li></ul> <h3 id="web-标准-api-的补丁"><a href="#web-标准-api-的补丁" class="header-anchor">#</a> WEB 标准 API 的补丁</h3> <h4 id="特性列表"><a href="#特性列表" class="header-anchor">#</a> 特性列表</h4> <table><thead><tr><th>分类</th> <th>模块</th> <th>特性</th> <th>路径</th></tr></thead> <tbody><tr><td></td> <td><code>web.timers</code></td> <td><code>setTimeout</code></td> <td><code>core-js(-pure)/stable|features/set-timeout</code></td></tr> <tr><td></td> <td><code>web.timers</code></td> <td><code>setInterval</code></td> <td><code>core-js(-pure)/stable|features/set-interval</code></td></tr> <tr><td></td> <td><code>web.immediate</code></td> <td><code>setImmediate</code></td> <td><code>core-js(-pure)/stable|features/set-immediate</code></td></tr> <tr><td></td> <td><code>web.immediate</code></td> <td><code>clearImmediate</code></td> <td><code>core-js(-pure)/stable|features/clear-immediate</code></td></tr> <tr><td></td> <td><code>web.queue-microtask</code></td> <td><code>queueMicrotask</code></td> <td><code>core-js/web/queue-microtask</code><br><code>core-js(-pure)/stable|features/queue-microtask</code></td></tr> <tr><td></td> <td><code>web.url</code></td> <td></td> <td></td></tr> <tr><td></td> <td><code>web.url.to-json</code></td> <td></td> <td></td></tr> <tr><td></td> <td><code>web.url-search-params</code></td> <td></td> <td></td></tr> <tr><td></td> <td><code>web.dom-collections.iterator</code></td> <td></td> <td></td></tr> <tr><td></td> <td><code>web.dom-collections.for-each</code></td> <td></td> <td></td></tr> <tr><td></td> <td><code>web.dom-collections.iterator</code></td> <td></td> <td><code>core-js(-pure)/stable|features/dom-collections/iterator</code></td></tr> <tr><td></td> <td><code>web.dom-collections.for-each</code></td> <td></td> <td><code>core-js/stable|features/dom-collections/for-each</code></td></tr> <tr><td></td> <td></td> <td></td> <td><code>core-js-pure/es|stable|features/is-iterable</code></td></tr> <tr><td></td> <td></td> <td></td> <td><code>core-js-pure/es|stable|features/get-iterator</code></td></tr> <tr><td></td> <td></td> <td></td> <td><code>core-js-pure/es|stable|features/get-iterator-method</code></td></tr></tbody></table> <p>core-js 中和 WEB 标准相关的 API 实现，定义在 <code>core-js/packages/core-js/web/</code> 目录下，并实现了以下 API:</p> <h4 id="dom-collections"><a href="#dom-collections" class="header-anchor">#</a> dom-collections</h4> <ul><li><p>介绍</p> <p>dom-collections 表示 HTML 中获取 DOM 节点集的一系列方法。</p> <p>下表是文件 <code>core-js/packages/core-js/internals/dom-iterables.js</code> 列举的 dom-collections:</p> <table><thead><tr><th>dom-collection</th> <th>作用</th></tr></thead> <tbody><tr><td><code>CSSRuleList</code></td> <td></td></tr> <tr><td><code>CSSStyleDeclaration</code></td> <td></td></tr> <tr><td><code>CSSValueList</code></td> <td></td></tr> <tr><td><code>ClientRectList</code></td> <td></td></tr> <tr><td><code>DOMRectList</code></td> <td></td></tr> <tr><td><code>DOMStringList</code></td> <td></td></tr> <tr><td><code>DOMTokenList</code></td> <td></td></tr> <tr><td><code>DataTransferItemList</code></td> <td></td></tr> <tr><td><code>FileList</code></td> <td></td></tr> <tr><td><code>HTMLAllCollection</code></td> <td></td></tr> <tr><td><code>HTMLCollection</code></td> <td></td></tr> <tr><td><code>HTMLFormElement</code></td> <td></td></tr> <tr><td><code>HTMLSelectElement</code></td> <td></td></tr> <tr><td><code>MediaList</code></td> <td></td></tr> <tr><td><code>MimeTypeArray</code></td> <td></td></tr> <tr><td><code>NamedNodeMap</code></td> <td></td></tr> <tr><td><code>NodeList</code></td> <td></td></tr> <tr><td><code>PaintRequestList</code></td> <td></td></tr> <tr><td><code>Plugin</code></td> <td></td></tr> <tr><td><code>PluginArray</code></td> <td></td></tr> <tr><td><code>SVGLengthList</code></td> <td></td></tr> <tr><td><code>SVGNumberList</code></td> <td></td></tr> <tr><td><code>SVGPathSegList</code></td> <td></td></tr> <tr><td><code>SVGPointList</code></td> <td></td></tr> <tr><td><code>SVGStringList</code></td> <td></td></tr> <tr><td><code>SVGTransformList</code></td> <td></td></tr> <tr><td><code>SourceBufferList</code></td> <td></td></tr> <tr><td><code>StyleSheetList</code></td> <td></td></tr> <tr><td><code>TextTrackCueList</code></td> <td></td></tr> <tr><td><code>TextTrackList</code></td> <td></td></tr> <tr><td><code>TouchList</code></td> <td></td></tr></tbody></table></li> <li><p>补丁</p> <p>core-js 为上述 dom-collection 方法添加了一系列补丁，目的是为其确保实现了 <code>for-each/iterator</code> 系列方法:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../modules/web.dom-collections.for-each'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 确保 for-each 实现</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../modules/web.dom-collections.iterator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 确保 iterator 实现</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> path<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p>for-each</p> <p>core-js 在文件 <code>core-js/packages/core-js/internals/array-iteration.js</code> 定义了和数组相关的多个方法的补丁，总体来说，<code>forEach/map/filter/some/every/find/findIndex/filterOut</code> 均用 <code>for</code> 循环实现。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> global <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/global'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 全局对象</span>
<span class="token keyword">var</span> DOMIterables <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/dom-iterables'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> forEach <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/array-for-each'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// core-js 自身实现的 forEach</span>
<span class="token keyword">var</span> createNonEnumerableProperty <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/create-non-enumerable-property'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// COLLECTION_NAME: CSSRuleList/CSSStyleDeclaration/CSSValueList/...</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> <span class="token constant">COLLECTION_NAME</span> <span class="token keyword">in</span> DOMIterables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> Collection <span class="token operator">=</span> global<span class="token punctuation">[</span><span class="token constant">COLLECTION_NAME</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> CollectionPrototype <span class="token operator">=</span> Collection <span class="token operator">&amp;&amp;</span> <span class="token class-name">Collection</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
    <span class="token comment">// some Chrome versions have non-configurable methods on DOMTokenList</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CollectionPrototype <span class="token operator">&amp;&amp;</span> CollectionPrototype<span class="token punctuation">.</span>forEach <span class="token operator">!==</span> forEach<span class="token punctuation">)</span> <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">createNonEnumerableProperty</span><span class="token punctuation">(</span>CollectionPrototype<span class="token punctuation">,</span> <span class="token string">'forEach'</span><span class="token punctuation">,</span> forEach<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CollectionPrototype<span class="token punctuation">.</span>forEach <span class="token operator">=</span> forEach<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>从源码可以看出，core-js 会给浏览器支持的 dom-collections API，以 <code>Object.defineProperty</code> 或直接赋值的方式提供 <code>forEach</code> 方法实现。</p></li> <li><p>iterator</p> <p>core-js 在 <code>core-js/packages/core-js/modules/web.dom-collections.iterator.js</code> 文件定义了对 iterator 的实现。</p> <p>TODO</p></li></ul></li></ul> <h4 id="immediate"><a href="#immediate" class="header-anchor">#</a> immediate</h4> <ul><li><p>immediate介绍</p> <p>TODO</p></li> <li><p>兼容性判断</p> <p>core-js 提供了 <code>setImmediate/clearImmediate</code> 的兼容性实现。</p> <p>在文件 <code>core-js/packages/core-js/modules/web.immediate.js</code> 中可以看到，在实现 <code>setImmediate</code> 时，做出了以下处理:</p> <ul><li><p>如果 <code>setImmediate/clearImmediate</code> 均已被支持，则不再处理</p></li> <li><p>如果 <code>setImmediate/clearImmediate</code> 有任何一个没有被支持，则手动实现 <code>setImmediate/clearImmediate</code>，并赋值到全局对象</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token constant">FORCED</span> <span class="token operator">=</span> <span class="token operator">!</span>global<span class="token punctuation">.</span>setImmediate <span class="token operator">||</span> <span class="token operator">!</span>global<span class="token punctuation">.</span>clearImmediate<span class="token punctuation">;</span>

<span class="token comment">// http://w3c.github.io/setImmediate/</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">global</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">bind</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">forced</span><span class="token operator">:</span> <span class="token constant">FORCED</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// `setImmediate` method</span>
    <span class="token comment">// http://w3c.github.io/setImmediate/#si-setImmediate</span>
    <span class="token literal-property property">setImmediate</span><span class="token operator">:</span> task<span class="token punctuation">.</span>set<span class="token punctuation">,</span>
    <span class="token comment">// `clearImmediate` method</span>
    <span class="token comment">// http://w3c.github.io/setImmediate/#si-clearImmediate</span>
    <span class="token literal-property property">clearImmediate</span><span class="token operator">:</span> task<span class="token punctuation">.</span>clear
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ul></li> <li><p>补丁</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> i<span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 fn 推入队列</span>
    queue<span class="token punctuation">[</span><span class="token operator">++</span>counter<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">?</span> fn <span class="token operator">:</span> <span class="token function">Function</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 将当前处理逻辑的索引注册到待执行函数</span>
    <span class="token comment">// 待执行函数根据不同环境有不同实现</span>
    <span class="token function">defer</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 返回数字形式的“句柄”</span>
    <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function-variable function">clear</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">clearImmediate</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> queue<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>通过自定义的 <code>setImmediate</code> 方法，做到了:</p> <ul><li>维护一个执行队列，按顺序执行处理逻辑，用 <code>queue</code> 数组维护</li> <li>将当前处理逻辑的索引注册到待执行函数，用 <code>defer</code> 方法实现，<code>defer</code> 会根据不同环境有不同的实现</li> <li>最终返回数字形式的“句柄”</li></ul> <p>defer 的实现依据以下先后顺序:</p> <ul><li><code>process.nextTick</code>: 如果是 Node 环境</li> <li><code>Dispatch.now</code>: 如果是 Sphere 游戏引擎环境</li> <li><code>MessageChannel</code>: 如果不是 iOS 环境，且支持 MessageChannel</li> <li><code>postMessage</code>: 如果支持 postMessage</li> <li><code>createElement('script')</code> 的 <code>onreadystatechange</code> 事件</li> <li><code>setTimeout</code></li></ul></li></ul> <h4 id="queue-microtask"><a href="#queue-microtask" class="header-anchor">#</a> queue-microtask</h4> <ul><li><p>介绍</p> <p>https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide</p></li> <li><p>补丁</p> <p>TODO</p></li></ul> <h4 id="timers"><a href="#timers" class="header-anchor">#</a> timers</h4> <ul><li><p>介绍</p> <p>timers 指的就是 <code>setTimeout/setInterval</code>，二者的使用方式如下:</p> <ul><li><code>setTimeout(handler[, delay, arg1, arg2, ...])</code></li> <li><code>setInterval(handler, delay, [arg1, arg2, ...])</code></li></ul></li> <li><p>补丁</p> <p>core-js 对 timers 的补丁位于 <code>core-js/packages/core-js/modules/web.timers.js</code>，IE9 及以下版本会强制使用 core-js 自定义的实现。</p> <p>实现代码:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/export'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> global <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/global'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> userAgent <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/engine-user-agent'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> slice <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">MSIE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">MSIE .\.</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- dirty ie9- check</span>

<span class="token keyword">var</span> <span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">scheduler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>handler<span class="token punctuation">,</span> timeout <span class="token comment">/* , ...arguments */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> boundArgs <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> args <span class="token operator">=</span> boundArgs <span class="token operator">?</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">scheduler</span><span class="token punctuation">(</span>
            boundArgs 
            <span class="token operator">?</span> 
            <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">?</span> handler <span class="token operator">:</span> <span class="token function">Function</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
            <span class="token operator">:</span> 
            handler<span class="token punctuation">,</span> 
        
            timeout
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ie9- setTimeout &amp; setInterval additional parameters fix</span>
<span class="token comment">// https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#timers</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">global</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">bind</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">forced</span><span class="token operator">:</span> <span class="token constant">MSIE</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// `setTimeout` method</span>
    <span class="token comment">// https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#dom-settimeout</span>
    <span class="token literal-property property">setTimeout</span><span class="token operator">:</span> <span class="token function">wrap</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// `setInterval` method</span>
    <span class="token comment">// https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#dom-setinterval</span>
    <span class="token literal-property property">setInterval</span><span class="token operator">:</span> <span class="token function">wrap</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span>setInterval<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>可以看到，如果传入的 <code>handler</code> 不是函数，则用 <code>Function(handler)).apply(this, args)</code> 的方式调用</p></li></ul> <h4 id="url"><a href="#url" class="header-anchor">#</a> url</h4> <p>core-js 对 url 的兼容性支持体现在三个子功能: <code>URL</code> 构造函数、<code>URL.prototype.toJSON</code>、<code>URLSearchParams</code> 构造函数。</p> <ul><li><p>对WAHTWG标准的兼容性判断</p> <p><code>core-js/packages/core-js/internals/native-url.js</code> 文件描述了如何判断运行环境是否支持标准的 <code>URLSearchParams</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> fails <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/fails'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> wellKnownSymbol <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/well-known-symbol'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">IS_PURE</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/is-pure'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token constant">ITERATOR</span> <span class="token operator">=</span> <span class="token function">wellKnownSymbol</span><span class="token punctuation">(</span><span class="token string">'iterator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回值描述了宿主环节是否已支持 URLSearchParams</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">fails</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'b?a=1&amp;b=2&amp;c=3'</span><span class="token punctuation">,</span> <span class="token string">'http://a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> searchParams <span class="token operator">=</span> url<span class="token punctuation">.</span>searchParams<span class="token punctuation">;</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    url<span class="token punctuation">.</span>pathname <span class="token operator">=</span> <span class="token string">'c%20d'</span><span class="token punctuation">;</span>
    searchParams<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        searchParams<span class="token punctuation">[</span><span class="token string">'delete'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">+=</span> key <span class="token operator">+</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">IS_PURE</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>url<span class="token punctuation">.</span>toJSON<span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token operator">!</span>searchParams<span class="token punctuation">.</span>sort
        <span class="token operator">||</span> url<span class="token punctuation">.</span>href <span class="token operator">!==</span> <span class="token string">'http://a/c%20d?a=1&amp;c=3'</span>
        <span class="token operator">||</span> searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'3'</span>
        <span class="token operator">||</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token string">'?a=1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'a=1'</span>
        <span class="token operator">||</span> <span class="token operator">!</span>searchParams<span class="token punctuation">[</span><span class="token constant">ITERATOR</span><span class="token punctuation">]</span>
        <span class="token comment">// throws in Edge</span>
        <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'https://a@b'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>username <span class="token operator">!==</span> <span class="token string">'a'</span>
        <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span><span class="token string">'a=b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'b'</span>
        <span class="token comment">// not punycoded in Edge</span>
        <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'http://тест'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>host <span class="token operator">!==</span> <span class="token string">'xn--e1aybc'</span>
        <span class="token comment">// not escaped in Chrome 62-</span>
        <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'http://a#б'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hash <span class="token operator">!==</span> <span class="token string">'#%D0%B1'</span>
        <span class="token comment">// fails in Chrome 66-</span>
        <span class="token operator">||</span> result <span class="token operator">!==</span> <span class="token string">'a1c3'</span>
        <span class="token comment">// throws in Safari</span>
        <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'http://x'</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">.</span>host <span class="token operator">!==</span> <span class="token string">'x'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p><code>fails</code> 方法接收一个执行函数，并在内部使用 <code>try...catch...</code> 执行该函数，若执行失败（有报错情况），<code>fails()</code> 方法返回 <code>true</code>，否则返回 <code>false</code>，这是 <code>fails()</code> 方法的实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exec</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果运行时环境不支持标准的 <code>url</code> 定义，core-js 会提供自己的 API 实现 <code>url</code> 的一些特性，如:</p> <ul><li><code>URL</code> 构造函数的补丁定义在文件 <code>core-js/packages/core-js/modules/web.url.js</code></li> <li><code>URLSearchParams</code> 的补丁定义在文件 <code>core-js/packages/core-js/modules/web.url-search-params.js</code></li></ul></li> <li><p>对 url 的统一处理</p> <p><code>core-js/packages/core-js/web/url.js</code> 文件提供了对 url 各个特征的处理:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../modules/web.url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../modules/web.url.to-json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../modules/web.url-search-params'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>web.url.js</code> 文件提供了基于 WHATWG 标准的各个特征的实现。</p> <p><code>web.url.to-json</code> 提供了 <code>URL.prototype.toJSON</code> 的实现。</p> <p><code>web.url-search-params</code> 提供了 <code>URLSearchParams</code> 的实现。</p></li> <li><p><code>URL</code> 构造函数</p> <p>TODO</p></li> <li><p><code>URLSearchParams</code></p> <ul><li><p>介绍</p> <p><code>URLSearchParams</code> 接口定义了一些实用的方法来处理 URL 的查询字符串，比如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> paramsString <span class="token operator">=</span> <span class="token string">&quot;q=URLUtils.searchParams&amp;topic=api&quot;</span>
<span class="token keyword">var</span> searchParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>paramsString<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> p <span class="token keyword">of</span> searchParams<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token comment">// [ 'q', 'URLUtils.searchParams' ]，[ 'topic', 'api' ]</span>

searchParams<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;api&quot;</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
searchParams<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;api&quot;]</span>
searchParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
searchParams<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;webdev&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchParams<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;q=URLUtils.searchParams&amp;topic=api&amp;topic=webdev&quot;</span>
searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;More webdev&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchParams<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;q=URLUtils.searchParams&amp;topic=More+webdev&quot;</span>
searchParams<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchParams<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;q=URLUtils.searchParams&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>根据WHATWG的标准，core-js提供了不满足该标准的运行环境下的补丁。</p></li> <li><p>补丁</p> <p>TODO</p></li></ul></li> <li><p><code>URL.prototype.toJSON</code></p> <p>有独立的文件 <code>core-js/packages/core-js/modules/web.url.to-json.js</code> 描述了该实现:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../internals/export'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// `URL.prototype.toJSON` method</span>
<span class="token comment">// https://url.spec.whatwg.org/#dom-url-tojson</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'URL'</span><span class="token punctuation">,</span> <span class="token literal-property property">proto</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">toJSON</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">URL</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到，<code>toJSON</code> 的实现和 <code>toString</code> 一致，注意，这里并没有涉及兼容性的处理，是因为 <code>toString</code> 方法在此之前已经被兼容性处理过了。</p> <p>不过，由于 <code>web.url.js</code> 也提供了 <code>toJSON</code> 的实现，这一步并没有必要了。</p></li></ul> <h3 id="缺失的补丁"><a href="#缺失的补丁" class="header-anchor">#</a> 缺失的补丁</h3> <ul><li><p><code>BigInt</code></p> <ul><li><p>介绍</p> <p>TODO</p></li> <li><p>补丁缺失的原因</p> <p>TODO</p></li></ul></li> <li><p><code>Proxy</code></p> <ul><li><p>介绍</p> <p>TODO</p></li> <li><p>补丁缺失的原因</p> <p>TODO</p></li></ul></li> <li><p><code>String#normalize</code></p> <ul><li><p>介绍</p> <p>TODO</p></li> <li><p>补丁缺失的原因</p> <p>TODO</p></li></ul></li> <li><p><code>Intl</code></p> <ul><li><p>介绍</p> <p>TODO</p></li> <li><p>补丁缺失的原因</p> <p>TODO</p></li></ul></li> <li><p><code>window.fetch</code></p> <ul><li><p>介绍</p> <p>TODO</p></li> <li><p>补丁缺失的原因</p> <p>TODO</p></li></ul></li></ul> <h2 id="_8-3-regenerator-runtime"><a href="#_8-3-regenerator-runtime" class="header-anchor">#</a> 8.3 regenerator-runtime</h2> <p>资料: https://segmentfault.com/a/1190000023701257</p> <h3 id="_8-3-1-generator对象"><a href="#_8-3-1-generator对象" class="header-anchor">#</a> 8.3.1 Generator对象</h3> <p>Generator 指的是生成器对象，该对象由 generator 函数返回，Generator 对象符合可迭代协议和迭代器协议。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// generator 函数</span>
    <span class="token keyword">yield</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token string">'b'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;Generaotr 对象 {}&quot;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: &quot;a&quot;, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: &quot;b&quot;, done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: undefined, done: true }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="迭代协议"><a href="#迭代协议" class="header-anchor">#</a> 迭代协议</h3> <p>https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Iteration_protocols#iterable</p> <p>作为 ECMAScript 2015 的一组补充规范，迭代协议并不是新的内置实现或语法，而是协议。这些协议可以被任何遵循某些约定的对象来实现。</p> <p>迭代协议具体分为两个协议: 可迭代协议和迭代器协议。</p> <h3 id="可迭代协议"><a href="#可迭代协议" class="header-anchor">#</a> 可迭代协议</h3> <p>可迭代协议允许 JavaScript 对象设置自身的迭代行为。比如在 <code>for...of</code> 结构中，对象的哪些值可以被遍历到。</p> <p>要成为可迭代对象，一个对象必须实现 <code>@@iterator</code> 方法。这意味着对象（或者其原型链上的某个对象）必须有一个键为 <code>@@iterator</code> 的属性，可通过常量 <code>Symbol.iterator</code> 访问该属性，示例:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><p>内置可迭代协议的对象</p> <p>目前所有的内置可迭代对象如下: <code>String</code>、<code>Array</code>、<code>TypedArray</code>、<code>Map</code> 和 <code>Set</code>，它们的原型对象都实现了 <code>@@iterator</code> 方法。</p> <p>比如 <code>String</code> 关于 <code>@@iterator</code> 方法的示例:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> someString <span class="token operator">=</span> <span class="token string">&quot;hi&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">typeof</span> someString<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// &quot;function&quot;</span>

<span class="token keyword">const</span> iterator <span class="token operator">=</span> someString<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iterator <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>    <span class="token comment">// &quot;[object String Iterator]&quot;</span>

iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// { value: &quot;h&quot;, done: false }</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// { value: &quot;i&quot;, done: false }</span>
iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// { value: undefined, done: true }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>展开语法（<code>...</code>）内部也实现了可迭代协议:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token operator">...</span>someString<span class="token punctuation">]</span> <span class="token comment">// [&quot;h&quot;, &quot;i&quot;]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>自定义可迭代对象</p> <p>对象也可以通过提供自己的 <code>@@iterator</code> 方法，重新定义迭代行为:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 必须构造 String 对象以避免字符串字面量 auto-boxing</span>
<span class="token keyword">const</span> someString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
someString<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token comment">// 只返回一次元素，字符串 &quot;bye&quot;，的迭代器对象</span>
        <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_first <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;bye&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">_first</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token operator">...</span>someString<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;bye&quot;]</span>
someString <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span> <span class="token comment">// &quot;hi&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> myIterable <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
myIterable<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token operator">...</span>myIterable<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [1, 2, 3]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>接受可迭代对象的内置 API</p> <p>很多 API 接受可迭代对象作为参数，例如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">[</span>iterable<span class="token punctuation">]</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span>
Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>iterable<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>需要可迭代对象的语法</p> <p>一些语句和表达式需要可迭代对象，比如 <code>for...of</code> 循环、展开语法、<code>yield*</code>，和解构赋值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> value <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// &quot;a&quot;</span>
<span class="token comment">// &quot;b&quot;</span>
<span class="token comment">// &quot;c&quot;</span>

<span class="token punctuation">[</span><span class="token operator">...</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">yield</span><span class="token operator">*</span> <span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { value: &quot;a&quot;, done: false }</span>

<span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a <span class="token comment">// &quot;a&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li></ul> <h3 id="迭代器协议"><a href="#迭代器协议" class="header-anchor">#</a> 迭代器协议</h3> <ul><li><p>什么是迭代器</p> <p>在 JavaScript 中，迭代器是一个对象，它定义一个序列，并在序列终止时可能返回一个返回值。</p> <p>迭代器协议描述了一个迭代器需要长什么样子，或者说有什么功能:</p> <ul><li><p>迭代器对象需实现了一个 <code>next()</code> 方法</p></li> <li><p><code>next()</code> 方法必须返回一个对象，该对象应当有两个属性: <code>done</code> 和 <code>value</code></p></li> <li><p><code>done</code> 和 <code>value</code> 需要满足如下语义:</p> <ul><li><p><code>done(boolean)</code></p> <p>如果迭代器可以产生序列中的下一个值，则为 <code>false</code>。</p> <p>如果迭代器已将序列迭代完毕，则为 <code>true</code>。这种情况下，<code>value</code> 是可选的，如果它依然存在，即为迭代结束之后的默认返回值。</p></li> <li><p><code>value(any)</code></p> <p>迭代器返回的任何 JavaScript 值。<code>done</code> 为 <code>true</code> 时可省略。</p></li></ul></li></ul></li> <li><p>迭代器示例</p> <p>简单迭代器</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeIterator</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> nextIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> nextIndex <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">value</span><span class="token operator">:</span> array<span class="token punctuation">[</span>nextIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">makeIterator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'哟'</span><span class="token punctuation">,</span> <span class="token string">'呀'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '哟'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '呀'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>无穷迭代器</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">idMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">value</span><span class="token operator">:</span> index<span class="token operator">++</span><span class="token punctuation">,</span>
            <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> it <span class="token operator">=</span> <span class="token function">idMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '0'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '1'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '2'</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>使用生成器</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">makeSimpleGenerator</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> nextIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>nextIndex <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> array<span class="token punctuation">[</span>nextIndex<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> gen <span class="token operator">=</span> <span class="token function">makeSimpleGenerator</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'哟'</span><span class="token punctuation">,</span> <span class="token string">'呀'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '哟'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '呀'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span>



<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">idMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> index<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> gen <span class="token operator">=</span> <span class="token function">idMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '0'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '1'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '2'</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>ES2015 类 class 中的迭代器</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">SimpleClass</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Use a new index for each iterator. This makes multiple</span>
        <span class="token comment">// iterations over the iterable safe for non-trivial cases,</span>
        <span class="token comment">// such as use of break or nested looping over the same iterable.</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> simple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleClass</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> val <span class="token keyword">of</span> simple<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>   <span class="token comment">//'1' '2' '3' '4' '5'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div></li></ul> <h3 id="生成器对象到底是一个迭代器-还是一个可迭代对象"><a href="#生成器对象到底是一个迭代器-还是一个可迭代对象" class="header-anchor">#</a> 生成器对象到底是一个迭代器，还是一个可迭代对象？</h3> <p>生成器对象既是迭代器，也是可迭代对象:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">aGeneratorObject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typeof</span> aGeneratorObject<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token comment">// 返回&quot;function&quot;, 因为有一个next方法，所以这是一个迭代器</span>

<span class="token keyword">typeof</span> aGeneratorObject<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 返回&quot;function&quot;, 因为有一个@@iterator方法，所以这是一个可迭代对象</span>

aGeneratorObject<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> aGeneratorObject<span class="token punctuation">;</span>
<span class="token comment">// 返回true, 因为@@iterator方法返回自身（即迭代器），所以这是一个格式良好的可迭代对象</span>

<span class="token punctuation">[</span><span class="token operator">...</span>aGeneratorObject<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 返回[1, 2, 3]</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Symbol<span class="token punctuation">.</span>iterator <span class="token keyword">in</span> aGeneratorObject<span class="token punctuation">)</span>
<span class="token comment">// 返回true, 因为@@iterator方法是aGeneratorObject的一个属性</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_8-3-2-babel-对-generator-函数的转译"><a href="#_8-3-2-babel-对-generator-函数的转译" class="header-anchor">#</a> 8.3.2 Babel 对 generator 函数的转译</h3> <p>并不是所有运行环境都支持 generator 语法的，对于这些环境，Babel 可以将其转译为 ES5 版本，其中，babel-preset-env 和 babel-plugin-transform-runtime 均与 generator 函数转译相关。</p> <p>例如，待转译的源码为:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token string">'b'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在不同的 Babel 配置下，有不同的转译结果。</p> <ul><li><p>只配置 babel-preset-env</p> <p>Babel 转译配置如下:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">&quot;@babel/preset-env&quot;</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>源码会被转译为:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _marked <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span>regeneratorRuntime<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">gen$</span><span class="token punctuation">(</span><span class="token parameter">_context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>_context<span class="token punctuation">.</span>prev <span class="token operator">=</span> _context<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">'a'</span><span class="token punctuation">;</span>

                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">'b'</span><span class="token punctuation">;</span>

                <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token string">&quot;end&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> _context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> _marked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></li> <li><p>新增 babel-plugin-transform-runtime</p> <p>如果 Babel 的转译配置增加 <code>babel-plugin-transform-runtime</code> 插件:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">&quot;@babel/plugin-transform-runtime&quot;</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">&quot;@babel/preset-env&quot;</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>源码会被转译为:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _interopRequireDefault <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/helpers/interopRequireDefault&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _regenerator <span class="token operator">=</span> <span class="token function">_interopRequireDefault</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/runtime/regenerator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _marked <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span>_regenerator<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _regenerator<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">gen$</span><span class="token punctuation">(</span><span class="token parameter">_context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>_context<span class="token punctuation">.</span>prev <span class="token operator">=</span> _context<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">'a'</span><span class="token punctuation">;</span>

                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">'b'</span><span class="token punctuation">;</span>

                <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token string">&quot;end&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> _context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> _marked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div></li></ul> <h3 id="_8-3-3-regenerator-runtime-源码解析"><a href="#_8-3-3-regenerator-runtime-源码解析" class="header-anchor">#</a> 8.3.3 regenerator-runtime 源码解析</h3> <p>对于源码:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token string">'a'</span><span class="token punctuation">;</span>
    <span class="token keyword">yield</span> <span class="token string">'b'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在只配置 <code>babel-preset-env</code> 时，转译结果是:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _marked <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span>regeneratorRuntime<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">gen$</span><span class="token punctuation">(</span><span class="token parameter">_context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>_context<span class="token punctuation">.</span>prev <span class="token operator">=</span> _context<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">'a'</span><span class="token punctuation">;</span>

                <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">'b'</span><span class="token punctuation">;</span>

                <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token string">&quot;end&quot;</span><span class="token operator">:</span>
                <span class="token keyword">return</span> _context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> _marked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>单独看转译结果，有 2 个问题:</p> <ul><li>这个转译结果并不能独立运行起来，它依赖了一个全局变量 <code>regeneratorRuntime</code></li> <li>转译后代码的运行逻辑是怎样的，比如 <code>regeneratorRuntime.wrap</code>、<code>regeneratorRuntime.mark</code> 都是什么意思</li></ul> <p>首先，需确认下，转移后代码中的 <code>regeneratorRuntime</code> 来自 <code>babel-runtime</code> 包，<code>babel-runtime</code> 包又依赖了 <code>regenerator-runtime</code>，即依赖关系是:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>babel-preset-env -&gt; babel-runtime -&gt; regenerator-runtime
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>regenerator-runtime</code> 工具包是 Facebook 公司推出的用 ES5 写法运行 ES6 的 generator 函数的辅助工具，其目录主要结构为:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>regenerator
├─ README.md
├─ bin
├─ main.js
├─ packages
│    ├─ preset
│    ├─ runtime
│    └─ transform
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>regeneratorRuntime</code> 定义在文件 <code>regenerator/packages/runtime/runtime.js</code>，具体的，<code>regeneratorRuntime</code> 有如下功能:</p> <ul><li>将 <code>regeneratorRuntime</code> 挂载到全局</li> <li>定义 <code>regeneratorRuntime.mark</code></li> <li>定义 <code>regeneratorRuntime.wrap</code></li></ul> <p>源码有 750 行左右，通读该源码可以了解 <code>regeneratorRuntime</code> 的作用。</p> <p>笔者整理了一份精简版的 <code>regeneratorRuntime</code> 定义，可简要地介绍其核心逻辑。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> window <span class="token operator">=</span> self <span class="token operator">=</span> global<span class="token punctuation">;</span>
    <span class="token keyword">var</span> ContinueSentinel <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> <span class="token function-variable function">mark</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">genFun</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> generator <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_invoke</span><span class="token punctuation">(</span><span class="token string">&quot;next&quot;</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        genFun<span class="token punctuation">.</span>prototype <span class="token operator">=</span> generator<span class="token punctuation">;</span>
        <span class="token keyword">return</span> genFun<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token parameter">innerFn<span class="token punctuation">,</span> outerFn<span class="token punctuation">,</span> self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> generator <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>outerFn<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;next&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token literal-property property">prev</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token function-variable function">abrupt</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> record <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                record<span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
                record<span class="token punctuation">.</span>arg <span class="token operator">=</span> arg<span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">record<span class="token punctuation">,</span> afterLoc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;return&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>rval <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arg <span class="token operator">=</span> record<span class="token punctuation">.</span>arg<span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> <span class="token string">&quot;return&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token string">&quot;end&quot;</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> ContinueSentinel<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">stop</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rval<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        generator<span class="token punctuation">.</span>_invoke <span class="token operator">=</span> <span class="token function">makeInvokeMethod</span><span class="token punctuation">(</span>innerFn<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> generator<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">makeInvokeMethod</span><span class="token punctuation">(</span><span class="token parameter">innerFn<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> state <span class="token operator">=</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token string">&quot;completed&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            context<span class="token punctuation">.</span>method <span class="token operator">=</span> method<span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>arg <span class="token operator">=</span> arg<span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> <span class="token string">&quot;executing&quot;</span><span class="token punctuation">;</span>

                <span class="token keyword">var</span> record <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;normal&quot;</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">arg</span><span class="token operator">:</span> <span class="token function">innerFn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;normal&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    state <span class="token operator">=</span> context<span class="token punctuation">.</span>done <span class="token operator">?</span> <span class="token string">&quot;completed&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;yield&quot;</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>arg <span class="token operator">===</span> ContinueSentinel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">return</span> <span class="token punctuation">{</span>
                        <span class="token literal-property property">value</span><span class="token operator">:</span> record<span class="token punctuation">.</span>arg<span class="token punctuation">,</span>
                        <span class="token literal-property property">done</span><span class="token operator">:</span> context<span class="token punctuation">.</span>done
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    window<span class="token punctuation">.</span>regeneratorRuntime <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    regeneratorRuntime<span class="token punctuation">.</span>wrap <span class="token operator">=</span> wrap<span class="token punctuation">;</span>
    regeneratorRuntime<span class="token punctuation">.</span>mark <span class="token operator">=</span> mark<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> _marked <span class="token operator">=</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span>helloWorldGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
        <span class="token keyword">function</span> <span class="token function">gen$</span><span class="token punctuation">(</span><span class="token parameter">_context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>_context<span class="token punctuation">.</span>prev <span class="token operator">=</span> _context<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                    _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token string">'a'</span><span class="token punctuation">;</span>

                    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                    _context<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token string">'b'</span><span class="token punctuation">;</span>

                    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;end&quot;</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> _context<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _marked<span class="token punctuation">,</span>
        <span class="token keyword">this</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 运行 gen</span>
<span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br></div></div><p>其运行图如下:</p> <p><img src="https://user-images.githubusercontent.com/5757051/155271428-c2f536db-7955-48ce-84bd-6912c03fae6c.png" alt="Runtime/regenerator-runtime"></p></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><!----> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">March 9, 2022 10:03</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: antfootmail@gmail.com" class="contributor">
          hoperyy
        </span> <!----></span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/books/deep-in-babel/07.Babel%E5%86%85%E7%BD%AEpreset/" class="prev"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon prev-icon"><path d="M906.783 588.79c-.02 8.499-6.882 15.36-15.38 15.37l-443.7-.01 75.704 191.682c2.52 6.42.482 13.763-5.038 17.91-5.52 4.168-13.138 4.147-18.616-.092L123.228 524.175a15.362 15.362 0 0 1-6-12.165c0-4.782 2.222-9.277 6-12.185L499.753 210.35a15.388 15.388 0 0 1 9.38-3.195c3.236 0 6.502 1.034 9.236 3.103 5.52 4.147 7.578 11.49 5.038 17.91L447.683 419.84l443.72-.01c8.498.01 15.36 6.881 15.36 15.36l.02 153.6z" fill="currentColor"></path></svg>
        第 7 章 - Babel 内置 Preset
      </a></span> <span class="next"><a href="/books/deep-in-babel/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/">
        第 9 章 - Babel 项目管理
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon next-icon"><path d="M906.772 512c0 4.772-2.211 9.267-5.99 12.175L524.257 813.66a15.37 15.37 0 0 1-18.616.092 15.368 15.368 0 0 1-5.038-17.91l75.714-191.672h-443.73c-8.488 0-15.36-6.881-15.36-15.36v-153.6c0-8.489 6.872-15.36 15.36-15.36h443.73l-75.714-191.682a15.358 15.358 0 0 1 5.048-17.91c5.51-4.158 13.128-4.137 18.606.092l376.525 289.485a15.323 15.323 0 0 1 5.99 12.165z" fill="currentColor"></path></svg></a></span></p></div> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/books/deep-in-babel/assets/js/app.e5f107d9.js" defer></script><script src="/books/deep-in-babel/assets/js/vendors~layout-Layout.d24908b2.js" defer></script><script src="/books/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" defer></script><script src="/books/deep-in-babel/assets/js/page--4c0dc106.7ad2507e.js" defer></script><script src="/books/deep-in-babel/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" defer></script>
  </body>
</html>
