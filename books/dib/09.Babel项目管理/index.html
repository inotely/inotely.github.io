<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《深入理解 Babel》 · 刘远洋</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="manifest" href="/books/dib/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="Just playing around">
    <meta property="og:url" content="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/">
    <meta property="og:site_name" content="《深入理解 Babel》 · 刘远洋">
    <meta property="og:description" content="Babel 是一个比较庞大的项目，其子工程就有至少 140 个，产出的子工具已经是前端开发的基础设施，对开发效率、代码质量等有非常高的要求。 本章，我们将了解 Babel 是怎样进行项目管理的。 本书从工程管理、代码管理、文档管理、质量管理四个方面对 Babel 项目管理进行拆解分析。 工程管理; Babel 是典型的 monorepo 项目，即单仓库项目，">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="《深入理解 Babel》 · 刘远洋">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/books/dib/assets/css/0.styles.e02910b1.css" as="style"><link rel="preload" href="/books/dib/assets/js/app.809f2d11.js" as="script"><link rel="preload" href="/books/dib/assets/js/vendors~layout-Layout.d24908b2.js" as="script"><link rel="preload" href="/books/dib/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" as="script"><link rel="preload" href="/books/dib/assets/js/page--d99aed8e.d5506aaa.js" as="script"><link rel="preload" href="/books/dib/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" as="script"><link rel="prefetch" href="/books/dib/assets/js/23.202ad9ba.js"><link rel="prefetch" href="/books/dib/assets/js/layout-Blog.b0c6dcb7.js"><link rel="prefetch" href="/books/dib/assets/js/layout-Layout.54347a9b.js"><link rel="prefetch" href="/books/dib/assets/js/layout-NotFound.846facba.js"><link rel="prefetch" href="/books/dib/assets/js/layout-Slide.88fa1023.js"><link rel="prefetch" href="/books/dib/assets/js/page--340e5eca.4373e080.js"><link rel="prefetch" href="/books/dib/assets/js/page--4c0dc106.a16b31f1.js"><link rel="prefetch" href="/books/dib/assets/js/page--4fdeacc4.6b1859ac.js"><link rel="prefetch" href="/books/dib/assets/js/page--584954b8.fb993ab2.js"><link rel="prefetch" href="/books/dib/assets/js/page--5e0b8312.6ee9d185.js"><link rel="prefetch" href="/books/dib/assets/js/page--6723acaa.1756275c.js"><link rel="prefetch" href="/books/dib/assets/js/page--8fcba694.86160d67.js"><link rel="prefetch" href="/books/dib/assets/js/page--9bf3e428.eb051bdc.js"><link rel="prefetch" href="/books/dib/assets/js/page--aec4dcea.533be8cb.js"><link rel="prefetch" href="/books/dib/assets/js/page--c3b426fa.a5024669.js"><link rel="prefetch" href="/books/dib/assets/js/page-前言.27ba744d.js"><link rel="prefetch" href="/books/dib/assets/js/page-语法分析和语义分析.d7c53948.js"><link rel="prefetch" href="/books/dib/assets/js/vendors~photo-swipe.a1ad4d40.js">
    <link rel="stylesheet" href="/books/dib/assets/css/0.styles.e02910b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/books/dib/" class="home-link router-link-active"><!----> <!----> <span class="site-name can-hide">《深入理解 Babel》 · 刘远洋</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://notelyio.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  撰写工具 · Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github · hoperyy
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></nav> <!----> <!----> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="https://notelyio.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  撰写工具 · Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github · hoperyy
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><a href="/books/dib/00.%E5%89%8D%E8%A8%80/" class="sidebar-link">第 0 章 - 前言</a></li><li><a href="/books/dib/01.%E6%A6%82%E8%BF%B0/" class="sidebar-link">第 1 章 - 概述</a></li><li><a href="/books/dib/02.%E8%BD%AC%E8%AF%91%E5%8E%9F%E7%90%86(1)/" class="sidebar-link">第 2 章 - 转译原理 (1)</a></li><li><a href="/books/dib/02.%E8%BD%AC%E8%AF%91%E5%8E%9F%E7%90%86(2)/" class="sidebar-link">第 2 章 - 转译原理 (2)</a></li><li><a href="/books/dib/03.Babel%E8%8A%82%E7%82%B9/" class="sidebar-link">第 3 章 - Babel 节点</a></li><li><a href="/books/dib/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/" class="sidebar-link">第 4 章 - Babel 工具集</a></li><li><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/" class="sidebar-link">第 5 章 - Babel 插件编写</a></li><li><a href="/books/dib/06.Babel%E5%86%85%E7%BD%AEplugin/" class="sidebar-link">第 6 章 - Babel 内置 Plugin</a></li><li><a href="/books/dib/07.Babel%E5%86%85%E7%BD%AEpreset/" class="sidebar-link">第 7 章 - Babel 内置 Preset</a></li><li><a href="/books/dib/08.runtime/" class="sidebar-link">第 8 章 - runtime</a></li><li><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" aria-current="page" class="active sidebar-link">第 9 章 - Babel 项目管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-1-monorepo" class="sidebar-link">9.1 monorepo</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-1-1-什么是-monorepo" class="sidebar-link heading3">9.1.1 什么是 monorepo</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-1-2-monorepo-的优缺点" class="sidebar-link heading3">9.1.2 monorepo 的优缺点</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#优点" class="sidebar-link heading3">优点</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#缺点" class="sidebar-link heading3">缺点</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#选择" class="sidebar-link heading3">选择</a></li></ul></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-2-lerna" class="sidebar-link">9.2 lerna</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-2-1-lerna命令集" class="sidebar-link heading3">9.2.1 lerna命令集</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#命令行列表" class="sidebar-link heading3">命令行列表</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#全局配置项" class="sidebar-link heading3">全局配置项</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#过滤器参数" class="sidebar-link heading3">过滤器参数</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#命令行详解" class="sidebar-link heading3">命令行详解</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-2-2-lerna原理解析" class="sidebar-link heading3">9.2.2 lerna原理解析</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#文件结构" class="sidebar-link heading3">文件结构</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#命令行注册" class="sidebar-link heading3">命令行注册</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#依赖管理" class="sidebar-link heading3">依赖管理</a></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#git相关" class="sidebar-link heading3">Git相关</a></li></ul></li><li class="sidebar-sub-header"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-3-todo" class="sidebar-link">9.3 TODO</a></li></ul></li><li><a href="/books/dib/10.%E8%BD%AC%E8%AF%91%E5%99%A8%E5%AF%B9%E6%AF%94/" class="sidebar-link">第 10 章 - 转译器对比</a></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline"></span></h1> <div class="page-info"><!----> <!----><!----><span aria-label="Writing Date📅" data-balloon-pos="down" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2022-2-24</span></span><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 51 min</span> <meta property="timeRequired" content="PT51M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-1-monorepo" class="anchor-link heading2"><div>9.1 monorepo</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-1-1-什么是-monorepo" class="anchor-link heading3"><div>9.1.1 什么是 monorepo</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-1-2-monorepo-的优缺点" class="anchor-link heading3"><div>9.1.2 monorepo 的优缺点</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#优点" class="anchor-link heading3"><div>优点</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#缺点" class="anchor-link heading3"><div>缺点</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#选择" class="anchor-link heading3"><div>选择</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-2-lerna" class="anchor-link heading2"><div>9.2 lerna</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-2-1-lerna命令集" class="anchor-link heading3"><div>9.2.1 lerna命令集</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#命令行列表" class="anchor-link heading3"><div>命令行列表</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#全局配置项" class="anchor-link heading3"><div>全局配置项</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#过滤器参数" class="anchor-link heading3"><div>过滤器参数</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#命令行详解" class="anchor-link heading3"><div>命令行详解</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-2-2-lerna原理解析" class="anchor-link heading3"><div>9.2.2 lerna原理解析</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#文件结构" class="anchor-link heading3"><div>文件结构</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#命令行注册" class="anchor-link heading3"><div>命令行注册</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#依赖管理" class="anchor-link heading3"><div>依赖管理</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#git相关" class="anchor-link heading3"><div>Git相关</div></a></li><li class="anchor"><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/#_9-3-todo" class="anchor-link heading2"><div>9.3 TODO</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><p>Babel 是一个比较庞大的项目，其子工程就有至少 140 个，产出的子工具已经是前端开发的基础设施，对开发效率、代码质量等有非常高的要求。</p> <p>本章，我们将了解 Babel 是怎样进行项目管理的。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155271288-1fbf98d9-d03e-401e-9008-6bbb86098f32.jpg" alt="Babel项目管理/概览"></p> <p>本书从工程管理、代码管理、文档管理、质量管理四个方面对 Babel 项目管理进行拆解分析。</p> <ul><li><p>工程管理</p> <p>Babel 是典型的 monorepo 项目，即单仓库项目，所有的子模块在同一个仓库里。Babel 目前有 140+ 个子模块，在工程管理部分，需要解决以下问题：</p> <ul><li>模块间如何方便地互相关联进行本地开发</li> <li>整个项目的版本控制</li> <li>操作自动化</li></ul> <p>工程管理部分主要使用 lerna、yarn 等工具。</p></li> <li><p>代码风格</p> <p>Babel 是多人协作开发的开源项目，如何保证代码风格一致，Babel 使用的是社区常见的解决方案。</p> <p>该模块主要使用 eslint、prettier 等工具。</p></li> <li><p>文档</p> <p>Babel 的迭代速度很快、涉及的模块很多，该模块解决版本发布后如何自动更新相关文档等问题。</p> <p>该模块主要使用 lerna 等工具。</p></li> <li><p>质量控制</p> <p>Babel 的产品是前端开发的基础设施，该模块主要保证 Babel 的产出是高质量的。</p> <p>该模块主要使用 jest、git blame 等工具。</p></li></ul> <h2 id="_9-1-monorepo"><a href="#_9-1-monorepo" class="header-anchor">#</a> 9.1 monorepo</h2> <p>Babel 使用 monorepo 模式进行工程管理。</p> <h3 id="_9-1-1-什么是-monorepo"><a href="#_9-1-1-什么是-monorepo" class="header-anchor">#</a> 9.1.1 什么是 monorepo</h3> <p>monorepo(monolithic repository)，指的是单仓库代码，将多个项目代码存储在一个仓库里。另外有一种模式是 multirepo，指的是多仓库代码（one-repository-per-module），不同的项目分布在不同的仓库里。React、Babel、Jest、Vue、Angular均采用 monorepo 进行项目管理。</p> <p>典型的 monorepo 结构是:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>├── packages
|   ├── pkg1
|   |   ├── package.json
|   ├── pkg2
|   |   ├── package.json
├── package.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这是 Babel 源码的目录结构:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>├─ lerna.json
├─ package.json
└─ packages/ # 这里将存放所有子项目目录
    ├─ README.md
    ├─ babel-cli
    ├─ babel-code-frame
    ├─ babel-compat-data
    ├─ babel-core
    ├─ babel-generator
    ├─ babel-helper-annotate-as-pure
    ├─ babel-helper-builder-binary-assignment-operator-visitor
    ├─ babel-helper-builder-react-jsx
    ├─ ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>而 rollup 则采取了 multirepo 的模式:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>├─ rollup
    ├─ package.json
    ├─ ...
├─ plugins
    ├─ package.json
    ├─ ...
├─ awesome
    ├─ package.json
    ├─ ...
├─ rollup-starter-lib
    ├─ package.json
    ├─ ...
├─ rollup-plugin-babel
    ├─ package.json
    ├─ ...
├─ rollup-plugin-commonjs
    ├─ package.json
    ├─ ...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_9-1-2-monorepo-的优缺点"><a href="#_9-1-2-monorepo-的优缺点" class="header-anchor">#</a> 9.1.2 monorepo 的优缺点</h3> <h3 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h3> <ul><li><p>便捷的代码复用与依赖管理</p> <p>当所有项目代码都在一个工程里，抽离可复用的代码就十分容易了。并且抽离后，如果复用的代码有改动，可以通过一些工具，快速定位受影响的子工程，进而做到子工程的版本控制。</p></li> <li><p>便捷的代码重构</p> <p>通过一些工具，monorepo 项目中的代码改动可以快速地定位出代码变更的影响范围，对整个工程进行快速的整体测试。而如果子工程分散在不同的工程分支里的话，通用代码的重构将难以触达各个子工程。</p></li> <li><p>倡导开放、共享</p> <p>monorepo 项目中，开发者可以方便地看到所有子工程，这样响应了&quot;开放、共享&quot;的组织文化。可以激发开发者对工程质量等维护的热情（毕竟别人看不到自己的代码，乱不乱就看自己心情了），有助于团队建立良好的技术氛围。</p></li></ul> <h3 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h3> <ul><li><p>复杂的权限管理</p> <p>因为所有子工程集中在一个工程里，某些子工程如果不希望对外展示的话，monorepo 的权限管理就比较难以实现了，难以锁定目标工程做独立的代码权限管理。</p></li> <li><p>较高的熟悉成本</p> <p>相对于 multirepo，monorepo 涉及各种子工程、通用依赖等，新的开发者在理解整个项目时，可能需要了解较多的信息才能入手，如通用依赖代码、各子工程功能。</p></li> <li><p>较大的工程体积</p> <p>很明显，所有子工程集成在一个工程里，代码体积会非常大，对文件存储系统等提出了较高的要求。</p></li> <li><p>较高的质量风险</p> <p>成也萧何败萧何，monorepo 提供了便捷的代码复用能力，同时，一个公用模块的某个版本有 bug 的话，很容易影响所有用到它的子工程。此时，做好高覆盖率的单元测试就比较重要了。</p></li></ul> <h3 id="选择"><a href="#选择" class="header-anchor">#</a> 选择</h3> <p>multirepo 和 monorepo 是两种不同的理念。</p> <p>multirepo 允许多元化发展，每个模块独立实现自己的构建、单元测试、依赖管理等。monorepo 抹平了模块间的很多差异，通过集中管理和高度集成化的工具，减少开发和沟通时的成本。monorepo 最大的问题可能就是不能管理占用空间太大的项目了。</p> <p>所以，还是要根据项目的实际需求出发选择用哪种项目管理模式。</p> <h2 id="_9-2-lerna"><a href="#_9-2-lerna" class="header-anchor">#</a> 9.2 lerna</h2> <p>http://www.febeacon.com/lerna-docs-zh-cn/routes/commands/bootstrap.html</p> <p>lerna 是基于 git/npm/yarn 等的工作流提效工具，用于维护 monorepo。它是 Babel 开发过程中提升开发效率产出的工具。</p> <p>lerna 本身也是一个 monorepo 的项目，并且，lerna 为 monorepo 项目提供了如下支持:</p> <ul><li><p>项目管理</p> <p>lerna 提供了一系列命令用于 monorepo 项目初始化、添加子项目、查看项目信息等。</p></li> <li><p>依赖管理</p> <p>lerna 支持为 monorepo 项目统一管理公共依赖、自动安装各个子项目的依赖、自动创建子模块符号链接等。</p></li> <li><p>版本管理</p> <p>lerna 可以根据项目代码的变动情况，发现影响的子项目范围，在发布时提供语义化版本推荐等，极大提升了 monorepo 项目的版本管理效率。</p></li></ul> <h3 id="_9-2-1-lerna命令集"><a href="#_9-2-1-lerna命令集" class="header-anchor">#</a> 9.2.1 lerna命令集</h3> <h3 id="命令行列表"><a href="#命令行列表" class="header-anchor">#</a> 命令行列表</h3> <p>lerna 官网有对各种命令各种用法的详细介绍，这些命令可以分为: 项目管理、依赖管理、版本管理三大类。</p> <p>| 分类 | 命令 | 作用 |
| 项目管理 | <code>lerna init</code> | 创建一个新的 monorepo 项目，或者将当前项目升级到支持 monorepo 的状态 |
| 项目管理 | <code>lerna create</code> | 创建一个新的 lerna 管理的包 |
| 项目管理 | <code>lerna import</code> | 将一个包导入到带有提交历史记录的 monorepo 项目中 |
| 项目管理 | <code>lerna list</code> | 列出本地包 |
| 项目管理 | <code>lerna link</code> | 将所有相互依赖的包符号链接在一起 |
| 项目管理 | <code>lerna exec</code> | 在每个包中执行任意命令 |
| 项目管理 | <code>lerna run</code> | 在包含该脚本中的每个包中运行 npm 脚本 |
| 依赖管理 | <code>lerna add</code> | 向匹配的包添加依赖关系，添加公共依赖 |
| 依赖管理 | <code>lerna clean</code> | 删除子项目的 node_modules |
| 依赖管理 | <code>lerna bootstrap</code> | 将本地包链接在一起并安装剩余的包依赖项。 |
| 版本管理 | <code>lerna publish</code> | 发布子项目 |
| 版本管理 | <code>lerna version</code> | 确认发布的版本号 |
| 版本管理 | <code>lerna diff</code> | 获取上次发布后所有包或某个包的代码变更情况 |
| 版本管理 | <code>lerna changed</code> | 列出自上次标记发布以来发生变化的本地包 |
| 版本管理 | <code>lerna info</code> | 打印本地环境信息 |</p> <h3 id="全局配置项"><a href="#全局配置项" class="header-anchor">#</a> 全局配置项</h3> <p>lerna 有一批通用参数，所有子命令均可以使用。</p> <ul><li><p><code>--concurrency</code></p> <p>当 lerna 将任务并行执行时，需要使用多少线程(默认为逻辑 CPU 内核数)。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --concurrency <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>--loglevel &lt;silent|error|warn|success|info|verbose|silly&gt;</code></p> <p>要报告什么级别的日志。如果失败，所有日志都写到当前工作目录中的 lerna-debug.log 中。</p> <p>任何高于该设置的日志都会显示出来。默认值是 <code>&quot;info&quot;</code>。</p></li> <li><p><code>--max-buffer &lt;bytes&gt;</code></p> <p>为每个底层进程调用设置的最大缓冲区长度。例如，当有人希望在运行 <code>lerna import</code> 的同时导入包含大量提交的仓库时，就是它出场的时候了。在这种情况下，内置的缓冲区长度可能不够。</p></li> <li><p><code>--no-progress</code></p> <p>禁用进度条。在CI环境中总是这样。</p></li> <li><p><code>--no-sort</code></p> <p>默认情况下，所有任务都按照拓扑排序的顺序在包上执行，以尊重所讨论的包的依赖关系。在不保证 <code>lerna</code> 调用一致的情况下，以最努力的方式打破循环。</p> <p>如果只有少量的包邮许多依赖项，或者某些包执行的时间长得不成比例，拓扑排序可能会导致并发瓶颈。<code>--no-sort</code> 配置项禁用排序，而是以最大并发的任意顺序执行任务。</p> <p>如果您运行多个 <code>watch</code> 命令，该配置项也会有所帮助。因为 <code>lerna run</code> 将按照拓扑排序的顺序执行命令，所以在继续执行之前可能会等待某个命令。当您运行 &quot;<code>watch</code>&quot; 命令时会阻塞执行，因为他们通常不会结束。</p></li> <li><p><code>--reject-cycles</code></p> <p>如果(在 <code>bootstrap</code>、<code>exec</code>、<code>publish</code> 或 <code>run</code> 中)发现循环，则立即失败。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna bootstrap --reject-cycles
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <h3 id="过滤器参数"><a href="#过滤器参数" class="header-anchor">#</a> 过滤器参数</h3> <ul><li><p><code>--scope &lt;glob&gt;</code></p> <p>只包含名称与给定通配符匹配的包。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> --scope my-component -- <span class="token function">ls</span> -la
lerna run --scope toolbar-* <span class="token builtin class-name">test</span>
lerna run --scope package-1 --scope *-2 lint
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>--ignore &lt;glob&gt;</code></p> <p>排除名称与给定通配符匹配的包。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> --ignore package-<span class="token punctuation">{</span><span class="token number">1,2</span>,5<span class="token punctuation">}</span>  -- <span class="token function">ls</span> -la
lerna run --ignore package-1  <span class="token builtin class-name">test</span>
lerna run --ignore package-@<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">|</span><span class="token number">2</span><span class="token punctuation">)</span> --ignore package-3 lint
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>--no-private</code></p> <p>排除私有的包。默认情况下是包含它们的。</p></li> <li><p><code>--since [ref]</code></p> <p>只包含自指定 <code>ref</code> 以来已经改变的包。如果没有传递 <code>ref</code>，它默认为最近的标记。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 列出自最新标记以来发生变化的包的内容</span>
$ lerna <span class="token builtin class-name">exec</span> --since -- <span class="token function">ls</span> -la

<span class="token comment"># 为自“master”以来所有发生更改的包运行测试</span>
$ lerna run <span class="token builtin class-name">test</span> --since master

<span class="token comment"># 列出自“某个分支”以来发生变化的所有包</span>
$ lerna <span class="token function">ls</span> --since some-branch
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在 <code>CI</code> 中使用时， 如果您可以获得 <code>PR</code> 将要进入的目标分支，那么它将特别有用，因为您可以将其作为 <code>--since</code> 配置项的 <code>ref</code>。这对于进入 <code>master</code> 和 <code>feature</code> 分支的 <code>PR</code> 来说很有效。</p></li> <li><p><code>--exclude-dependents</code></p> <p>当使用 <code>--since</code> 运行命令时，排除所有传递的被依赖项，覆盖默认的 <code>&quot;changed&quot;</code> 算法。</p> <p>如果没有 <code>--since</code> 该参数时无效的，会抛出错误。</p></li> <li><p><code>--include-dependents</code></p> <p>在运行命令时包括所有传递的被依赖项，无视 <code>--scope</code>、<code>--ignore</code> 或 <code>--since</code>。</p></li> <li><p><code>--include-dependencies</code></p> <p>在运行命令时包括所有传递依赖项，无视 <code>--scope</code>、<code>--ignore</code> 或 <code>--since</code>。</p> <p>与接受 <code>--scope(bootstrap、clean、ls、run、exec)</code> 的任何命令组合使用。确保对任何作用域的包(通过 <code>--scope</code> 或 <code>--ignore</code>)的所有依赖项(和 <code>dev</code> 依赖项)也进行操作。</p> <blockquote><p>注意
这将会覆盖 <code>--scope</code> 和 <code>--ignore</code>。
例如，如果一个匹配了 <code>--ignore</code> 的包被另一个正在引导的包所以来，那么它仍会照常工作。</p></blockquote> <p>当您想要&quot;设置&quot;一个依赖于其他正在设置的包其中的一个包时，这是非常有用的。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna bootstrap --scope my-component --include-dependencies
<span class="token comment"># my-component 及其所有依赖项将被引导</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna bootstrap --scope <span class="token string">&quot;package-*&quot;</span> --ignore <span class="token string">&quot;package-util-*&quot;</span> --include-dependencies
<span class="token comment"># 所有匹配 &quot;package-util-*&quot; 的包将被忽略，除非它们依赖于名称匹配 &quot;package-*&quot; 的包</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p><code>--include-merged-tags</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> --since --include-merged-tags -- <span class="token function">ls</span> -la
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在使用 <code>--since</code> 命令时，它包含来自合并分支的标记。这只有在从 <code>feature</code> 分支进行大量发布时才有用，通常情况下不推荐这样做。</p></li></ul> <h3 id="命令行详解"><a href="#命令行详解" class="header-anchor">#</a> 命令行详解</h3> <h4 id="lerna-init"><a href="#lerna-init" class="header-anchor">#</a> <code>lerna init</code></h4> <ul><li><p>作用</p> <p>创建一个新的 monorepo 项目，或者将当前项目升级到支持 monorepo 的状态。</p> <ul><li><p>创建一个新的 monorepo 项目</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">mkdir</span> lerna-project
<span class="token builtin class-name">cd</span> lerna-project
lerna init
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>会创建如下文件和文件夹：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>packages/
package.json
lerna.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>将已有项目升级到支持 monorepo 的状态</p> <p>一个项目已经执行过 <code>git init</code> 并已有一些文件时:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>src/
package.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>执行 <code>lerna init</code>，会有如下动作:</p> <ul><li>如果 <code>package.json</code> 中缺失 <code>lerna</code> 的依赖声明，则优先添加到 <code>devDependencies</code></li> <li>创建 <code>lerna.json</code> 用于存储 <code>version</code> 等配置字段</li></ul></li></ul></li> <li><p>配置项</p> <ul><li><p><code>lerna init --independent</code></p> <p>参数 <code>--independent</code>，表示当前项目是否是独立模式，默认为非独立模式。</p> <p>非独立模式下，lerna.json的内容为：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;packages/*&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>子工程的版本号统一保持一致。</p> <p>独立模式下，即用 <code>lerna init --independent</code> 初始化项目，lerna.json 的内容为：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;packages/*&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;independent&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>子工程的版本号独立维护。</p></li> <li><p><code>lerna init --exact</code></p> <p>默认情况下，当添加或更新 lerna 的本地版本时，<code>lerna init</code> 将使用插入符号范围，如 <code>npm install --save-dev lerna</code>。</p> <p>为了保留 <code>lerna 1.x</code> 的&quot;精确&quot;安装行为，可以传递该参数。也可以在 <code>lerna.json</code> 中配置以强制后续所有都执行精确匹配:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;init&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;exact&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul></li> <li><p>原理</p> <p>TODO</p></li></ul> <h4 id="lerna-create-name-loc"><a href="#lerna-create-name-loc" class="header-anchor">#</a> <code>lerna create &lt;name&gt; [loc]</code></h4> <ul><li><p>作用</p> <p>创建一个新的 lerna 管理的包。</p> <p>比如，在项目目录执行：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna create module1
lerna create module2
lerna create module3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>项目目录会包含：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>packages/
    module1/
    module2/
    module3/
package.json
lerna.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>参数</p> <ul><li><p><code>&lt;name&gt;</code></p></li> <li><p><code>[loc]</code></p></li> <li><p><code>--access</code></p></li> <li><p><code>--bin</code></p></li> <li><p><code>--description</code></p></li> <li><p><code>--dependencies</code></p></li> <li><p><code>--es-module</code></p></li> <li><p><code>--homepage</code></p></li> <li><p><code>--keywords</code></p></li> <li><p><code>--license</code></p></li> <li><p><code>--private</code></p></li> <li><p><code>--registry</code></p></li> <li><p><code>--tag</code></p></li> <li><p><code>--yes</code></p></li></ul></li></ul> <h4 id="lerna-import"><a href="#lerna-import" class="header-anchor">#</a> <code>lerna import</code></h4> <ul><li><p>作用</p> <p>将一个包导入到带有提交历史记录的 monorepo 项目中。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token function">import</span> <span class="token operator">&lt;</span>path-to-external-repository<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将位于 <code>&lt;path-to-external-repository&gt;</code> 处的带有提交历史记录的包导入到 <code>packages/&lt;directory-name&gt;</code> 中。原始提交作者、日期和消息保存了下来。提交应用于当前 monorepo 分支。</p> <p>这对于将预先存在的独立的包收集到 <code>lerna</code> 仓库非常有用。每次提交都修改为相对于包目录进行更改。例如，添加 <code>package.json</code> 的提交将改为添加 <code>packages/&lt;directory-name&gt;/package.json</code>。</p></li> <li><p>配置项</p> <ul><li><p><code>lerna import --flatten</code></p> <p>当导入带有冲突合并提交的存储库时，<code>import</code> 命令在尝试应用所有提交时将失败。用户可以使用这个标志来请求&quot;抹平(<code>flat</code>)&quot;历史的导入，也就是说，在每次合并提交时，合并就会被引入。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna import ~/Product --flatten
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>lerna import --dest</code></p> <p>在导入存储库时，可以根据 <code>lerna.json</code> 中列出的目录指定目标目录。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna import ~/Product --dest=utilities
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>--preserve-commit</code></p> <p>每次 git 提交都有一位作者和一位提交者(每人都有一个单独的日期)。通常他们是同一个人(和日期)，但是因为 <code>lerna import</code> 从外部存储库重新创建每个提交，提交者就变成了当前的 git 用户(和日期)。这在技术上是正确的，但可能并不可取，例如，在 Github 上，如果作者和提交者是不同的人，它就会同时显示他们，这可能会导致导入提交时的历史/职责出现混乱。</p> <p>启用该配置项可以保留原始提交者(和提交日期)，以避免此类问题。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna import ~/Product --preserve-commit
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li></ul> <h4 id="lerna-list"><a href="#lerna-list" class="header-anchor">#</a> <code>lerna list</code></h4> <ul><li><p>作用</p> <p>列出本地包。</p></li> <li><p>使用</p> <p><code>lerna list</code> 有很多简写方式:</p> <ul><li><code>lerna ls</code>: 和 <code>lerna list</code> 相同</li> <li><code>lerna ll</code>: 和 <code>lerna list -l</code> 相同</li> <li><code>lerna la</code>: 和 <code>lerna list -la</code> 相同，显示所有的包（包括子包）</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna ls

package-1
package-2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在 <code>shell</code> 中运行这些命令时，您可能会注意到 lerna 提供了额外的日志记录。请放心，它们不会污染您的命令，因为所有的日志都是按照 <code>strerr</code> 发送的而非 <code>stdout</code>。</p> <p>在任何情况下，你可以随时通过 <code>--loglevel silent</code> 恢复原始的 <code>shell</code> 显示。</p></li> <li><p>配置项</p> <p><code>lerna list</code> 命令支持过滤器参数，lerna 的 <code>@lerna/filter-options</code> 工程描述了 lerna 支持的过滤器参数列表:</p> <ul><li><p><code>--json</code></p> <p>用 JSON 数组的形式展示子工程。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;package-1&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/path/to/packages/pkg-1&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;package-2&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;location&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/path/to/packages/pkg-2&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li> <li><p><code>--ndjson</code></p> <p>用换行分隔（<code>ndjson</code>）的方式展示子工程。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;package-1&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;private&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token string">&quot;/path/to/packages/pkg-1&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;package-2&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;version&quot;</span><span class="token operator">:</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;private&quot;</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token property">&quot;location&quot;</span><span class="token operator">:</span><span class="token string">&quot;/path/to/packages/pkg-2&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p><code>--all, -a</code></p> <p>展示默认隐藏的私有包。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>package<span class="token number">-1</span>
package<span class="token number">-2</span>
package<span class="token number">-3</span> (private)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>--long, -l</code></p> <p>显示扩展信息。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna ls --long
package-1 v1.0.1 packages/pkg-1
package-2 v1.0.2 packages/pkg-2

lerna ls -la
package-1 v1.0.1 packages/pkg-1
package-2 v1.0.2 packages/pkg-2
package-3 v1.0.3 packages/pkg-3 (private)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p><code>--parseable, -p</code></p> <p>显示可解析的输出，而不是竖向排列的显示。</p> <p>默认情况下，每一行都是包的绝对路径。</p> <p>如果新增了 <code>--long</code> 参数，每一行的格式都是以 <code>:</code> 分隔的 <code>&lt;fullpath&gt;:&lt;name&gt;:&lt;version&gt;[:flags..]</code>。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna ls --parseable
/path/to/packages/pkg-1
/path/to/packages/pkg-2

lerna ls -pl
/path/to/packages/pkg-1:package-1:1.0.1
/path/to/packages/pkg-2:package-2:1.0.2

lerna ls -pla
/path/to/packages/pkg-1:package-1:1.0.1
/path/to/packages/pkg-2:package-2:1.0.2
/path/to/packages/pkg-3:package-3:1.0.3:PRIVATE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p><code>--toposort</code></p> <p>按照拓扑顺序对包进行排序，而不是按目录对包进行词法排序。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>json dependencies &lt;packages/pkg-1/package.json
{
&quot;pkg-2&quot;: &quot;file:../pkg-2&quot;
}

lerna ls --toposort
package-2
package-1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p><code>--graph</code></p> <p>将依赖图显示为 json 格式的邻接表。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna ls --graph
{
    &quot;pkg-1&quot;: [
        &quot;pkg-2&quot;
    ],
    &quot;pkg-2&quot;: []
}

lerna ls --graph --all
{
    &quot;pkg-1&quot;: [
        &quot;pkg-2&quot;
    ],
    &quot;pkg-2&quot;: [
        &quot;pkg-3&quot;
    ],
    &quot;pkg-3&quot;: [
        &quot;pkg-2&quot;
    ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li></ul></li></ul> <h4 id="lerna-link"><a href="#lerna-link" class="header-anchor">#</a> <code>lerna link</code></h4> <ul><li><p>作用</p> <p>将所有相互依赖的包符号链接在一起。</p></li> <li><p>使用</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token function">link</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将当前 lerna 仓库中相互依赖的所有 lerna packages 符号链接在一起。</p></li> <li><p>配置项</p> <ul><li><p><code>--force-local</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token function">link</span> --force-local
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当使用该参数时，此标志将导致 <code>link</code> 命令始终符号链接本地依赖项，而不考虑匹配的版本范围。</p></li> <li><p><code>publishConfig.directory</code></p> <p>这是一个非标准字段，它将允许您定制作为符号链接的源目录的符号链接子目录，就像使用已发布的包一样。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;publishConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;directory&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在这个例子中，当该包连接时，<code>dist</code> 目录将成为源目录(例如，<code>package-1/dist =&gt; node_modules/package-1</code>)。</p></li></ul></li></ul> <h4 id="lerna-exec"><a href="#lerna-exec" class="header-anchor">#</a> <code>lerna exec</code></h4> <ul><li><p>作用</p> <p>在每个包中执行任意命令。</p></li> <li><p>使用</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> -- <span class="token operator">&lt;</span>command<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">..</span>args<span class="token punctuation">]</span> <span class="token comment"># 在所有包中运行命令</span>
lerna <span class="token builtin class-name">exec</span> -- <span class="token function">rm</span> -rf ./node_modules
lerna <span class="token builtin class-name">exec</span> -- protractor conf.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在每个包中执行任意命令。必须使用双横线--来将虚线参数传递给派生的命令，但当所有参数都是位置时，就不是必需的了。</p> <p>当前包的名称可以通过环境变量 <code>LERNA_PACKAGE_NAME</code> 获取:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> -- <span class="token function">npm</span> view <span class="token punctuation">\</span><span class="token variable">$LERNA_PACKAGE_NAME</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>您也可以通过环境变量 <code>LERNA_ROOT_PATH</code> 在一个复杂的目录结构中运行一个位于根目录下的脚本:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> -- <span class="token function">node</span> <span class="token punctuation">\</span><span class="token variable">$LERNA_ROOT_PATH</span>/scripts/some-script.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>配置项</p> <ul><li><p><code>lerna exec</code> 接受所有的过滤器参数</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> --scope my-component -- <span class="token function">ls</span> -la
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用给定的并发(除了 <code>--parallel</code>)并行生成命令。输出是以管道形式传输的，所以并不确定。如果您想一个接一个包运行这个命令，可以这样使用:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> --concurrency <span class="token number">1</span> -- <span class="token function">ls</span> -la
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>--stream</code></p> <p>立即从子进程输出流，它的前缀为原始的包名。这让不同的包交叉输出成为可能。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> --stream -- babel src -d lib
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>--parallel</code></p> <p>和 <code>--stream</code> 相类似，但完全忽略并发性和拓扑顺序。它会立即在带有前缀的流输出的所有匹配包中运行给定的命令或脚本。这是在许多包上运行的长时间运行的进程(如 <code>babel src -d lib -w</code>)的首选参数。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> --parallel -- babel src -d lib -w
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>注意</p> <p>在使用 <code>--parallel</code> 时建议限制该命令的作用域，因为生成几十个子进程可能会损害 shell 的稳定性(例如，最大文件描述符限制)。这个因人而异。</p></blockquote></li> <li><p><code>--no-bail</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 运行一个命令，忽略非零(错误)退出代码</span>
lerna <span class="token builtin class-name">exec</span> --no-bail <span class="token operator">&lt;</span>command<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>默认情况下，如果任何执行过程返回一个非零的退出代码，<code>lerna exec</code> 将退出并报错。<code>——no-bail</code> 可以禁用此行为，让其所有包中执行，而无视退出代码。</p></li> <li><p><code>--no-prefix</code></p> <p>当输出为流(<code>--stream</code> 或 <code>--parallel</code>)时禁用包名前缀。该配置项应用在将结果传输到其他进程时很有用，比如编辑器插件。</p></li> <li><p><code>--profile</code></p> <p>对命令执行进行分析，并生成性能分析文件，可以在基于 chrome 的浏览器中使用 DevTools 进行分析(URL 为：<code>devtools://devtools/bundled/devtools_app.html</code>)。该分析文件显示了命令执行的时间线，其中每次执行都会分配给一个打开的槽。槽的数量由 <code>--concurrency</code> 决定，开放槽的数量由 <code>--concurrency</code> 减去正在进行的操作的数量决定。最终结果是对并行执行命令的可视化展示。</p> <p>性能分析文件输出的默认位置是项目的根目录。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> --profile -- <span class="token operator">&lt;</span>command<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Lerna 只会在启用拓扑排序(即不使用 <code>--parallel</code> 和 <code>--no-sort</code>)时分析性能。</p></li> <li><p><code>--profile-location &lt;location&gt;</code></p> <p>您可以提供一个自定义位置用于性能分析文件的输出。提供的路径是相对于当前工作目录进行解析的。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token builtin class-name">exec</span> --profile --profile-location<span class="token operator">=</span>logs/profile/ -- <span class="token operator">&lt;</span>command<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li></ul> <h4 id="lerna-run"><a href="#lerna-run" class="header-anchor">#</a> <code>lerna run</code></h4> <ul><li><p>作用</p> <p>在包含该脚本中的每个包中运行 npm 脚本。</p></li> <li><p>使用</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna run <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span> -- <span class="token punctuation">[</span><span class="token punctuation">..</span>args<span class="token punctuation">]</span> <span class="token comment"># 在所有包含 my-script 的包中运行 npm run</span>
lerna run <span class="token builtin class-name">test</span>
lerna run build

<span class="token comment"># 观察所有包和 transpile 的变化，使用流前缀输出</span>
lerna run --parallel <span class="token function">watch</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在包含该脚本中的每个包中运行 npm 脚本，必须使用双横线 <code>--</code> 来将虚线参数传递给给执行的脚本。</p></li> <li><p>配置项</p> <p>TODO 好像和 exec 一样。</p></li></ul> <h4 id="lerna-add"><a href="#lerna-add" class="header-anchor">#</a> <code>lerna add</code></h4> <ul><li><p>作用</p> <p>向匹配的包添加依赖关系，添加公共依赖。</p></li> <li><p>使用</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna add &lt;package&gt;[@version] [--dev] [--exact] [--peer]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将本地或远程 package 作为依赖项添加到当前 <code>lerna</code> 仓库中的包。注意，与 <code>yarn add</code> 或 <code>npm install</code> 相比，一次只能添加一个包。</p> <p>运行时，该命令将：</p> <ul><li>向每个适用的包添加 <code>package</code>。适用是指在作用域内且不是 <code>package</code> 的包</li> <li>对 <code>manifest</code> 文件(<code>package.json</code>)进行更改的引导包</li> <li>如果没有提供 <code>version</code> 指示符，其默认值为 <code>latestdist-tag</code>，和 <code>npm install</code> 一样</li></ul></li> <li><p>配置项</p> <p><code>lerna add</code> 接受所有的过滤器参数。</p> <ul><li><p><code>lerna add --dev</code></p> <p>将新包添加到 <code>devDependencies</code>而不是 <code>dependencies</code>。</p></li> <li><p><code>lerna add --exact</code></p> <p>为新包添加一个确切的版本(例如，<code>1.0.1</code>)，而不是默认的^语义化版本号范围(例如，<code>^1.0.1</code>)。</p></li> <li><p><code>lerna add --peer</code></p> <p>将新包添加到 <code>peerDependencies</code> 而不是 <code>dependencies</code>。</p></li> <li><p><code>lerna add --registry &lt;url&gt;</code></p> <p>使用自定义注册表安装目标包。</p></li> <li><p><code>lerna add --no-bootstrap</code></p> <p>跳过链式的 <code>lerna bootstrap</code>。</p></li></ul></li> <li><p>示例</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 将 module-1 的包添加到以“prefix-”为前缀文件夹中的包中</span>
lerna <span class="token function">add</span> module-1 packages/prefix-*

<span class="token comment"># 将 module-1 安装到 module-2</span>
lerna <span class="token function">add</span> module-1 --scope<span class="token operator">=</span>module-2

<span class="token comment"># 将 module-1 安装到 module-2 的 devDependencies</span>
lerna <span class="token function">add</span> module-1 --scope<span class="token operator">=</span>module-2 --dev

<span class="token comment"># 将 module-1 安装到 module-2 的 peerDependencies</span>
lerna <span class="token function">add</span> module-1 --scope<span class="token operator">=</span>module-2 --peer

<span class="token comment"># 将 module-1 安装到除了 module-1 的所有模块</span>
lerna <span class="token function">add</span> module-1

<span class="token comment"># 在所有模块中安装 babel-core</span>
lerna <span class="token function">add</span> babel-core

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>比如，执行 <code>lerna add vue</code> 的话，会默认在各个子项目中添加 vue，此时各个子项目均会安装一遍 vue。</p> <p>如果不希望子项目重复安装，可以在项目 lerna.json 添加字段：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;bootstrap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;hoist&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>此时，vue 作为依赖会被安装在项目根目录，而子项目中的 package.json 也会声明该依赖。</p></li></ul> <h4 id="lerna-clean"><a href="#lerna-clean" class="header-anchor">#</a> <code>lerna clean</code></h4> <ul><li><p>作用</p> <p>删除子项目的 node_modules。</p></li> <li><p>参数</p> <p><code>lerna clearn</code> 接受所有的过滤器参数，以及 <code>--yes</code>。</p> <p><code>lerna clean</code> 不会从根 <code>node_modules</code> 目录中删除模块，即使您使用了 <code>--hoist</code>。</p></li></ul> <h4 id="lerna-bootstrap"><a href="#lerna-bootstrap" class="header-anchor">#</a> <code>lerna bootstrap</code></h4> <ul><li><p>作用</p> <p>将本地包链接在一起并安装剩余的包依赖项。</p></li> <li><p>使用</p> <p>引导当前 <code>lerna</code> 仓库中的包。安装其所有依赖项并连接所有的交叉依赖。</p> <p>在运行时，该命令:</p> <ul><li><code>npm install</code> 每个包所有的外部依赖</li> <li>将所有相互依赖的 <code>lerna</code> <code>package</code> 符号链接在一起（symlink）</li> <li>在所有引导包中运行 <code>npm run prepublish</code>(除非传入了 <code>--ignore-prepublish</code>)</li> <li>在所有引导包中运行 <code>npm run prepare</code></li></ul></li> <li><p>配置项</p> <ul><li><p><code>lerna bootstrap</code> 接受所有过滤器属性</p></li> <li><p>通过将额外的参数放在 <code>--</code> 之后来传递给 npm 客户端</p> <p><code>lerna bootstrap -- --production --no-optional</code></p> <p>也可以在 lerna.json 中这样配置:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;npmClient&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;npmClientArgs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;--production&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--no-optional&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p><code>--hoist [glob]</code></p> <p>在仓库根目录安装与 <code>glob</code> 匹配的外部依赖，这样所有包都可以使用他们。这些依赖的任何二进制文件都将链接到依赖包的 <code>node_modules/.bin/</code> 目录中，这样 <code>npm</code> 脚本就可以使用它们了。如果传了该参数但却没有设置 <code>glob</code>，则默认为 <code>**</code>(提升所有)。该配置项仅影响 <code>bootstrap</code> 命令。</p> <blockquote><p>如果包依赖于不同版本的外部依赖项，则会将最常用的版本提升，并发出警告
<code>--hoist</code> 与 <code>file</code>: 标识符不兼容，请只使用一个</p></blockquote></li> <li><p><code>--strict</code></p> <p>当和 <code>hoist</code> 一起使用时，会抛出一个错误，并在发出版本警告后停止引导。如果没有 <code>hoist</code> 或没有版本警告则无效果。</p></li> <li><p><code>--nohoist [glob]</code></p> <p>不要在仓库根目录安装与 <code>glob</code> 匹配的外部依赖项。该参数可以用来选择不提升某些依赖项。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna bootstrap --hoist --nohoist<span class="token operator">=</span>babel-*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>--ignore</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna bootstrap --ignore component-*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该参数与 <code>bootstrap</code> 命令一起使用时，也可以在 lerna.json 的 <code>command.bootstrap.ignore</code> 中设置。命令行中设置该参数优先于 <code>lerna.json</code>。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;bootstrap&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;ignore&quot;</span><span class="token operator">:</span> <span class="token string">&quot;component-*&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>通配符匹配的是 <code>package.json</code> 中定义的包名，而不是与包所在的目录名。</p></blockquote></li> <li><p><code>--ignore-prepublish</code></p> <p>跳过在引导包中默认运行的预发布生命周期脚本。注意，这个生命周期是已废弃的，可能会在 <code>lerna</code> 的下一个主要版本中被删除。</p></li> <li><p><code>--ignore-scripts</code></p> <p>跳过在引导包中正常运行的生命周期脚本(<code>prepare</code> 等等)。</p></li> <li><p><code>--registry &lt;url&gt;</code></p> <p>当使用该参数时，转发的 npm 命令将为您的包使用指定的注册表。</p> <p>如果您不想在使用私有注册表时在所有 <code>package.json</code> 文件中分别设置注册表配置，那么这就是它出场的时候了。</p></li> <li><p><code>--npm-client &lt;client&gt;</code></p> <p>它必须是一个知道如何安装 <code>npm</code> 包依赖的可执行文件。默认的 <code>--npm-client</code> 是 <code>npm</code>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna bootstrap --npm-client<span class="token operator">=</span>yarn
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可在lerna.json中配置:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;npmClient&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>--use-workspaces</code></p> <p>支持和 yarn 工作区 (从 yarn@0.27+ 版本开始)数组中的值是 lerna 将在其中委托操作给 Yarn 的命令(目前仅在 <code>bootstrap</code> 中可用)。如果 <code>--use-workspaces</code> 为真，那么 packages 将被 package.json/workspaces 的值覆盖。</p> <p>也可在 lerna.json 中配置:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;npmClient&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;useWorkspaces&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>根级别的 package.json 还必须包含一个工作区数组:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;lerna&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.2.0&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;workspaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;packages/*&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这个列表与 lerna 的 package 配置大体上类似(通过 package.json 用通配符匹配的目录列表)，只是它不支持递归的通配符匹配(<code>**</code>，也叫 <code>&quot;globstars&quot;</code>)。</p></li> <li><p><code>--no-ci</code></p> <p>当使用默认的 <code>--npm-client</code>，<code>lerna bootstrap</code> 将调用 <code>npm ci</code> 而非在 CI 环境中调用 <code>npm install</code>。若要禁用此行为，可以使用 <code>--no-ci</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna bootstrap --no-ci
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>若要在本地安装期间强制执行(在本地安装中不会自动启用)，请使用 <code>--ci</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna bootstrap --ci
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这对于&quot;干净地&quot;重新安装或重新克隆后的初次安装非常有用。</p></li> <li><p><code>--force-local</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna bootstrap --force-local
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当使用该参数时，它会让 <code>bootstrap</code> 命令始终符号链接本地依赖项，而不考虑匹配的版本范围。</p></li> <li><p><code>publishConfig.directory</code></p> <p>这个非标准字段允许您自定义符号链接子目录，它会作为符号链接的源目录，就像使用已发布的包一样。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;publishConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;directory&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在本例中，当这个包被引导并链接时，dist 目录将是源目录(例如 <code>package-1/dist =&gt; node_modules/package-1</code>)。</p></li></ul></li> <li><p>原理</p> <p>TODO</p></li></ul> <h4 id="lerna-publish"><a href="#lerna-publish" class="header-anchor">#</a> <code>lerna publish</code></h4> <ul><li><p>作用</p> <p>在当前项目中发布包。</p></li> <li><p>使用</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish              <span class="token comment"># 发布自上一个版本以来发生了变化的包</span>
lerna publish from-git     <span class="token comment"># 发布当前提交中标记的包</span>
lerna publish from-package <span class="token comment"># 发布注册表中没有最新版本的包</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在运行时，该命令做了下面几件事中的一个：</p> <ul><li>发布自上一个版本以来更新的包(背后调用了 <code>lerna version</code>)。这是 lerna 2.x 版本遗留下来的。</li> <li>发布在当前提交中标记的包(<code>from-git</code>)。</li> <li>发布在最新提交时注册表中没有版本的包(<code>from-package</code>)。</li> <li>发布在前一次提交中更新的包(及其依赖项)的&quot;金丝雀(<code>canary</code>)&quot;版。</li></ul> <p>Lerna 永远不会发布标记为 <code>private</code> 的包（package.json 中的 <code>&quot;private&quot;: true</code>）。</p> <p>在所有的发布过程中，都有生命周期在根目录和每个包中运行(除非使用了 <code>--ignore-scripts</code>)。</p></li> <li><p>位置</p> <ul><li><p><code>from-git</code></p> <p>除了 <code>lerna version</code> 支持的语义化版本关键字外，<code>lerna publish</code> 也支持 <code>from-git</code> 关键字。这将会识别 <code>lerna version</code> 标记的包，并将它们发布到 npm。这在您希望手动增加版本的 CI 场景中非常有用，但要通过自动化过程一直地发布包内容本身。</p></li> <li><p><code>from-package</code></p> <p>与 from-git 关键字类似，只是要发布的包列表是通过检查每个 package.json 确定的，并且要确定注册表中是否存在任意版本的包。注册表中没有的任何版本都将被发布。当前一个 <code>lerna publish</code> 未能将所有包发布到注册表时，就是他发挥的时候了。</p></li></ul></li> <li><p>生命周期</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>// prepublish:      在打包和发布包之前运行。
// prepare:         在打包和发布包之前运行，在 prepublish 之后，prepublishOnly 之前。
// prepublishOnly:  在打包和发布包之前运行，只在 <span class="token function">npm</span> publish 时运行。
// prepack:         只在源码压缩打包之前运行。
// postpack:        在源码压缩打包生成并移动到最终目的地后运行。
// publish:         在包发布后运行。
// postpublish:     在包发布后运行。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Lerna 将在 <code>lerna publish</code> 期间运行 npm 生命周期脚本，顺序如下:</p> <ul><li>如果采用没有指定版本，则运行所有版本生命周期脚本</li> <li>如果可用，在根目录运行 prepublish 生命周期。</li> <li>在根目录中运行 prepare 生命周期。</li> <li>在根目录中运行 prepublishOnly 生命周期。</li> <li>在根目录运行 prepack 生命周期。</li> <li>对于每个更改的包，按照拓扑顺序(所有依赖项在依赖关系之前):
<ul><li>如果可用，运行 prepublish 生命周期。</li> <li>运行 prepare 生命周期。</li> <li>运行 prepublishOnly 生命周期。</li> <li>运行 prepack 生命周期。</li> <li>通过 JS API 在临时目录中创建源码压缩包。</li> <li>运行 postpack 生命周期。</li></ul></li> <li>在根目录运行 postpack 生命周期。</li> <li>对于每个更改的包，按照拓扑顺序(所有依赖项在依赖关系之前):
<ul><li>通过 JS API 发布包到配置的注册表。</li> <li>运行 publish 生命周期。</li> <li>运行 postpublish 生命周期。</li></ul></li> <li>在根目录中运行publish生命周期。</li> <li>为了避免递归调用，不要使用这个根生命周期来运行 lerna publish。</li> <li>在根目录中运行 postpublish 生命周期。</li> <li>如果可用，将临时的 dist-tag 更新到最新</li></ul></li> <li><p>配置项</p> <p><code>lerna publish</code> 支持 <code>lerna version</code> 提供的所有配置项，除了以下这些:</p> <ul><li><p><code>--canary</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --canary
<span class="token comment"># 1.0.0 =&gt; 1.0.1-alpha.0+${SHA} of packages changed since the previous commit</span>
<span class="token comment"># a subsequent canary publish will yield 1.0.1-alpha.1+${SHA}, etc</span>

lerna publish --canary --preid beta
<span class="token comment"># 1.0.0 =&gt; 1.0.1-beta.0+${SHA}</span>

<span class="token comment"># The following are equivalent:</span>
lerna publish --canary minor
lerna publish --canary preminor
<span class="token comment"># 1.0.0 =&gt; 1.1.0-alpha.0+${SHA}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>当使用该标志运行时，<code>lerna publish</code> 以更粒度的方式(每次提交)来发布包。在发布到 npm 之前，它会通过当前的 version 创建新的 version 标记，升级到下一个小版本(minor)，添加传入的 meta 后缀(默认为 alpha)并且附加当前的 git sha 码（例如：<code>1.0.0</code> 变成 <code>1.1.0-alpha.0+81e3b443</code>）。</p> <p>如果您已经从 <code>CI</code> 中的多个活动开发分支发布了 <code>canary</code> 版本，那么建议在每个分支的基础上定制 <code>--preid</code> 和 <code>--dist-tag &lt;tag&gt;</code> 以避免版本冲突。</p> <blockquote><p>该参数是需要发布每次提交版或每日构建版时使用。</p></blockquote></li> <li><p><code>--contents &lt;dir&gt;</code></p> <p>要发布的子目录。必定应用于所有包，且必须包含 package.json 文件。包的生命周期仍然在原来的叶子目录中运行。您应当使用其中的一个生命周期(<code>prepare</code>、<code>prepublishOnly</code> 或 <code>prepack</code>)来创建子目录等等。</p> <p>如果您不喜欢非必要的复杂发布，这将给您带来乐趣。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --contents dist
<span class="token comment"># 发布每个由 Lerna 管理的叶子包的 dist 文件夹</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>注意
您应该等到 <code>postpublish</code> 生命周期阶段(根目录或叶目录)才清理这个生成的子目录，因为生成的 package.json 是在包上传期间(在 <code>postpack</code> 之后)使用的。</p></blockquote></li> <li><p><code>--dist-tag &lt;tag&gt;</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --dist-tag next
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当带有该参数时，<code>lerna publish</code> 将使用给定的 npm <code>dist-tag</code>(默认为 <code>latest</code>) 发布到 npm。</p> <p>该配置项可用于在非 <code>latest</code> 的 <code>dist-tag</code> 下发布预发布或 <code>beta</code> 版本，帮助用户免于自动升级到预发布质量的代码。</p> <blockquote><p>注意
<code>latest</code> 标记是用户运行 <code>npm install my-package</code> 时使用的标记。要安装不同的标记，用户可以运行 <code>npm install my-package@prerelease</code>。</p></blockquote></li> <li><p><code>--git-head &lt;sha&gt;</code></p> <p>在打包压缩时，显式地在 manifest 上设置为 gitHead，该操作只允许通过 <code>from-package</code> 位置进行。</p> <p>举个例子，当我们从 AWS CodeBuild (这里 <code>git</code> 用不了)发布时，您可以使用该配置项传递适当的环境变量来作为该包的元数据。</p> <p><code>lerna publish</code> 时，只会更新发生变更的子项目的版本号，如果没有特殊制定，未变更的则不会更新版本号。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish from-package --git-head <span class="token variable">${CODEBUILD_RESOLVED_SOURCE_VERSION}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>在所有其他情况下，该值是从本地的 git 命令派生而成的。</p></blockquote></li> <li><p><code>--graph-type &lt;all|dependencies&gt;</code></p> <p>设置在构建包依赖图时使用哪种依赖关系。默认值是 <code>dependencies</code>，因此只包括包的 package.json 的 <code>dependencies</code>部分中列出的包。若设置为 all，则在构建包依赖图和决定拓扑顺序时会包括 <code>dependencies</code> 和 <code>devDependencies</code>。</p> <p>在使用传统的 peer + dev 依赖对时，应该将此项配置为 <code>all</code>，以便 peer 可以总在其依赖项之前发布。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --graph-type all
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通过 lerna.json 来配置:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;publish&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;graphType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p><code>--ignore-scripts</code></p> <p>这个参数会让 <code>lerna publish</code> 在发布期间禁用运行的生命周期脚本。</p></li> <li><p><code>--ignore-prepublish</code></p> <p>这个参数会让 <code>lerna publish</code> 在发布期间禁用已废弃的 <code>prepublish</code> 脚本。</p></li> <li><p><code>--legacy-auth</code></p> <p>当您发布需要身份验证但使用内部托管的NPM注册表时，该注册表只使用旧 Base64 版本的 <code>username:password</code>。这与 NPM publish 的 <code>_auth</code> 标志相同。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --legacy-auth aGk6bW9t
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>--no-git-reset</code></p> <p>默认情况下，<code>lerna publish</code> 确保任何对工作树的更改都会被重置。</p> <p>为了避免这种情况，可以设置 <code>——no-git-reset</code>。当作为 CI 流程的一部分与 <code>——canary</code> 一起使用时，这一点特别有用。例如，已经被替换的 package.json 版本号可能需要在随后的 CI 流程步骤中使用(比如 Docker 构建)。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --no-git-reset
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><code>--no-granular-pathspec</code></p> <p>默认情况下，<code>lerna publish</code> 将尝试(如果启用)只 <code>git checkout</code> 在发布过程中临时修改的叶子包清单。这相当于 <code>git checkout -- packages/*/package.json</code>，但是精确地定制了变化。</p> <p>如果您确实知道您需要不同的行为，那么您就会理解：通过 <code>--no-granular-pathspec</code> 会让 git 命令执行的 <code>git checkout -- .</code>。通过选择这个路径规范，您必须有意忽略所有未版本化的内容。</p> <p>该项最好在 lerna.json 中配置，否则会原地去世的：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;independent&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;granularPathspec&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>根级配置是有意为之，因为它还包括了 <code>lerna version</code> 中的同名配置项。</p></li> <li><p><code>--no-verify-access</code></p> <p>默认情况下，lerna 将严重登录的 npm 用户对即将发布的包的访问权限。设置该参数将禁用该验证。</p> <p>如果您使用的是不支持 <code>npm access ls-packages</code> 的第三方注册表，则需要设置它(或在 lerna.json 中设置 <code>command.publish.verifyAccess</code> 为 <code>false</code>)。</p> <blockquote><p>请小心使用</p></blockquote></li> <li><p><code>--otp</code></p> <p>当发布需要双重身份验证的包时，您可以使用 <code>——otp</code> 指定一次性密码:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --otp <span class="token number">123456</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>请注意
一次性密码在生成后 30 秒内过期。如果它在发布操作期间到期，提示符将在继续之前请求更新后的值。</p></blockquote></li> <li><p><code>--preid</code></p> <p>和同名的 <code>lerna version</code> 配置项不同，该配置项仅适用于 <code>--canary</code> 版本计算。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --canary
<span class="token comment"># 举例，使用下一个语义化预发布版本</span>
<span class="token comment"># 1.0.0 =&gt; 1.0.1-alpha.0</span>

lerna publish --canary --preid next
<span class="token comment"># 举例，使用指定的预发布标识符来标识下一个语义化预发布版本</span>
<span class="token comment"># 1.0.0 =&gt; 1.0.1-next.0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>当使用该参数运行时，<code>lerna publish --canary</code> 将使用指定的 <code>prerelease</code> 标识符递增 <code>premajor</code>、<code>preminor</code>、<code>prepatch</code> 或 <code>prerelease</code> 语义化版本。</p></li> <li><p><code>--pre-dist-tag &lt;tag&gt;</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --pre-dist-tag next
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>除了只适用于与预发行版本一起发布的软件包外，它和 <code>--dist-tag</code> 并无二致。</p></li> <li><p><code>--registry &lt;url&gt;</code></p> <p>当使用该参数运行时，转发的 npm 命令将为您的包使用指定 url 的注册表。</p> <p>如果您不想在使用私有注册表时在所有 package.json 文件中分别设置注册表配置，那就是它出场的时候。</p></li> <li><p><code>--tag-version-prefix</code></p> <p>配置项项允许提供自定义前缀来替代默认的 <code>v</code>:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 本地</span>
lerna version --tag-version-prefix<span class="token operator">=</span><span class="token string">''</span>

<span class="token comment"># CI</span>
lerna publish from-git --tag-version-prefix<span class="token operator">=</span><span class="token string">''</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>您也可以在 lerna.json 中进行配置，对这两个命令也同样适用:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;tagVersionPrefix&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;packages/*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;independent&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p><code>--temp-tag</code></p> <p>当传递了该参数时，他将会改变默认的发布过程，首先将所有更改过的包发布到一个临时的 <code>dist-tag</code>(<code>lerna-temp</code>)中，然后将新版本移动到由 <code>--dist-tag</code> 配置的 <code>dist-tag</code> 中(默认值 <code>latest</code>)。</p> <p>这通常是没有必要的，因为 Lerna 在默认情况下会按照拓扑顺序(所有依赖项优先)来发布包。</p></li> <li><p><code>--yes</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna publish --canary --yes
<span class="token comment"># 跳过“您确定要发布上述更改吗?”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当使用此标志运行时，lerna publish 将跳过所有确认提示。在持续集成(CI)中用于自动回答发布确认提示。</p></li> <li><p>每个包的配置</p> <p>叶子包可以可以配置特殊的 <code>publishConfig</code>，在某些情况下可以改变 <code>lerna publish</code> 的行为。</p> <ul><li><p><code>publishConfig.access</code></p> <p>要发布具有作用域的包(如 <code>@mycompany/rocks</code>)，您必须设置 <code>access</code>:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;publishConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;access&quot;</span><span class="token operator">:</span> <span class="token string">&quot;public&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>如果把该字段设置到无作用域的包上，那么它会失败的。</li> <li>如果您希望限定范围的包保持私有状态(即&quot;<code>restricted</code>&quot;)，则无需设置该值。</li></ul> <blockquote><p>注意：这与在叶子包中设置 &quot;<code>private:true</code>&quot; 不一样。如果设置了 <code>private</code> 字段，那么在任何情况下都不会发布该包。</p></blockquote></li> <li><p><code>publishConfig.registry</code></p> <p>您可以通过设置 registry 在每个包上定制注册表。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;publishConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;registry&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://my-awesome-registry.com/&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>传入 <code>--registry</code> 可以应用到全局，其实在某些情况下会起到反效果。</p></li> <li><p><code>publishConfig.tag</code></p> <p>您可以通过设置tag来定制每个包的 <code>dist-tag</code>:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;publishConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;flippin-sweet&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>传入 <code>--dist-tag</code> 将会覆盖该值。</li> <li>如果同时传入了 <code>--canary</code> 则该值会被忽略。</li></ul></li> <li><p><code>publishConfig.directory</code></p> <p>这个非标准字段允许您定制已发布的子目录，就像 <code>--contents</code> 一样，但它是以每个包为基础的。所有其他关于 <code>--contents</code> 的内容仍然适用。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;publishConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;directory&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li></ul></li></ul> <h4 id="lerna-version"><a href="#lerna-version" class="header-anchor">#</a> <code>lerna version</code></h4> <ul><li><p>作用</p> <p>更改自上次发布以来的包版本号。</p></li> <li><p>使用</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version <span class="token number">1.0</span>.1 <span class="token comment"># 显式指定</span>
lerna version patch <span class="token comment"># 语义化关键字</span>
lerna version       <span class="token comment"># 根据提示选择</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在运行时，该命令执行以下操作:</p> <ul><li>标识自上一个版本以来更新的包。</li> <li>提示输入新版本。</li> <li>修改包的元数据，在根目录和每个包当中运行适当的生命周期脚本。</li> <li>提交这些更改并打上标记。</li> <li>推动到 git 远程服务器。</li></ul></li> <li><p>位置</p> <ul><li><p>语义化版本号</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version <span class="token punctuation">[</span>major <span class="token operator">|</span> minor <span class="token operator">|</span> patch <span class="token operator">|</span> premajor <span class="token operator">|</span> preminor <span class="token operator">|</span> prepatch <span class="token operator">|</span> prerelease<span class="token punctuation">]</span>
<span class="token comment"># 使用下一个语义化版本号，然后跳过“为…选择一个新版本”的提示。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当传递位置参数时，<code>lerna version</code> 将跳过版本选择的提示问题并根据关键字增加版本号。当然仍然需要使用 <code>--yes</code> 来避免所有的问题。</p></li> <li><p>预发布</p> <p>如果你有一个预发布版本号的软件包(例如 <code>2.0.0-beta.3</code>)，并且你运行了 <code>lerna version</code> 和一个非预先发布的版本(<code>major</code>、<code>minor</code>或<code>patch</code>)，它将会发布那些之前发布的软件包以及自上次发布以来已经改变的软件包。</p> <p>对于使用常规提交的项目，使用以下标志进行预发行管理：</p> <ul><li><code>--conventional-prerelease</code>: 将当前更改作为预发行版本发布。</li> <li><code>--conventional-graduate</code>: 将预发布版本的包升级为稳定版本。</li></ul> <p>如果不使用上面的参数运行 <code>lerna version --conventional-commits</code>，则只有在版本已经在 <code>prerelease</code> 中时，才会将当前更改作为 <code>prerelease</code> 释放。</p></li></ul></li> <li><p>生命周期</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>// preversion:  在设置版本号之前运行.
// version:     在设置版本号之后，提交之前运行.
// postversion: 在设置版本号之后，提交之后运行.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>lerna将在<code>lerna version</code>期间运行npm生命周期脚本：</p> <ul><li>侦测更改的包，选择版本号进行覆盖。</li> <li>在根目录运行 preversion。</li> <li>对于每个更改的包，按照拓扑顺序(所有依赖项在依赖关系之前):
<ul><li>运行 preversion 生命周期。</li> <li>更新 package.json 中的版本。</li> <li>运行 version 生命周期。</li></ul></li> <li>在根目录运行 version 生命周期。</li> <li>如果可用，将更改文件添加到索引。</li> <li>如果可用创建提交和标记。</li> <li>对于每个改变包，按照词法顺序(根据目录结构的字母顺序):
<ul><li>运行 postversion 生命周期。</li></ul></li> <li>在根目录运行 postversion。</li> <li>如果可用推动提交和标记到远程服务器。</li> <li>如果可用创建发布。</li></ul></li> <li><p>配置项</p> <ul><li><p><code>--allow-branch &lt;glob&gt;</code></p> <p>匹配启用了 <code>lerna version</code> 的 git 分支的白名单。在 lerna.json 中配置它是最简单的(我们也这么推荐)，但是也可以将它作为 CLI 配置项传入进去。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;allowBranch&quot;</span><span class="token operator">:</span> <span class="token string">&quot;master&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用上面的配置，<code>lerna version</code> 在除 <code>master</code> 之外的任何分支运行时都将失败。最佳实践是将 <code>lerna version</code> 限制到主分支。</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;allowBranch&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;master&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;feature/*&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在上面的配置中，<code>lerna version</code> 将被允许出现在任何以 <code>feature/</code> 为前缀的分支中。请注意，在 feature 分支中生成 git 标签会产生潜在的错误，因为这些分支会被合并到主分支中。如果标签和其原始上下文“分离”开来(可能通过 <code>squash merge</code> 或 <code>conflicted merge</code> 提交)，那么未来的 <code>lerna version</code> 执行将很难确定正确的&quot;自上一个版本以来的差异&quot;。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --allow-branch hotfix/oops-fix-the-thing
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用命令行会覆盖这个&quot;持久&quot;的配置，请谨慎使用。</p></li> <li><p><code>--amend</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --amend
<span class="token comment"># 保留 commit 的消息，并跳过 git push</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当使用该参数运行时，<code>lerna version</code> 将对当前提交执行所有更改，而不是添加一个新的。这在持续集成(CI)期间非常有用，可以减少项目历史记录中的提交数量。</p> <p>为了防止意外的覆盖，这个命令将跳过 <code>git push</code>(也就是说<code>--no-push</code>)。</p></li> <li><p><code>--changelog-preset</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --conventional-commits --changelog-preset angular-bitbucket
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>默认情况下，changelog 预设值是 angular。在某些情况下，您可能需要使用另一个预设值或自定义一个。</p> <p>预设值是常规更改日志的内置或可安装配置的名称。预设值可以作为包的全名或自动扩展的后缀进行传递(举个例子，angular 扩展为<code>conventional-changelog-angular</code>)。</p></li> <li><p><code>--conventional-commits</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --conventional-commits
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当您使用这个参数运行时，<code>lerna version</code> 将使用传统的提交规范来确定版本并生成 CHANGELOG.md 文件。</p> <p>传入 <code>--no-changelog</code> 将阻止生成(或更新) CHANGELOG.md 文件。</p></li> <li><p><code>--conventional-graduate</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --conventional-commits --conventional-graduate<span class="token operator">=</span>package-2,package-4

<span class="token comment"># 强制分隔所有的预发行包</span>
lerna version --conventional-commits --conventional-graduate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当使用该参数时，<code>lerna version</code> 将使用 <code>*</code> 分隔指定的包(用逗号隔开的)或所有的包。无论当前的HEAD是否已释放，该命令都可以工作，它和 <code>--force-publish</code> 相类似，除了忽略任何非预发布包。如果未指定的包(如果指定了包)或未预先发布的包发生了更改，那么这些包将按照它们通常使用的 <code>--conventional-commits</code> 提交的方式进行版本控制。</p> <p>&quot;分隔&quot;一个软件包意味着一个预发布版本的非预发布版本变体。例如 <code>package-1@1.0.0-alpha.0 =&gt; package-1@1.0.0</code>。</p> <blockquote><p>注意：当指定包时，它的依赖项将被释放，但不会被分隔。</p></blockquote></li> <li><p><code>--conventional-prerelease</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --conventional-commits --conventional-prerelease<span class="token operator">=</span>package-2,package-4

<span class="token comment"># 强制所有发生改变的包变为预发布</span>
lerna version --conventional-commits --conventional-prerelease
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当使用该参数时，<code>lerna version</code> 将使用 <code>*</code> 分隔指定的包(用逗号隔开的)或所有的包。通过在 <code>conventional-commits</code> 的版本推荐之前加上 <code>pre</code>，可以将所有未发布的更改作为 <code>pre</code> (<code>patch/minor/major/release</code>)版来发布。如果当前的更改包含了特性提交，那么推荐的版本将成为 <code>minor</code>，因此该参数会使其成为 <code>preminor</code> 发布。如果未指定的包(如果指定了包)或未预先发布的包发生了更改，那么这些包将按照它们通常使用的 <code>--conventional-commits</code> 提交的方式进行版本控制。</p></li> <li><p><code>--create-release &lt;type&gt;</code></p> <p>当使用该参数时，<code>lerna version</code> 将基于更改的包创建一个正式的 GitHub 或 GitLab 版本。需要传递 <code>conventional-commits</code> 以便生成变更日志。</p> <p>要使用 Github 进行身份验证，可以定义以下环境变量。</p> <ul><li><code>GH_TOKEN</code>（必须）- 您的 GitHub 认证 token (在设置(Settings) &gt; 开发人员设置(Developer Settings) &gt; 个人访问令牌(Personal access tokens)下)。</li> <li><code>GHE_API_URL</code> - 当使用 GitHub Enterprise 时，API 的绝对 URL。</li> <li><code>GHE_VERSION</code> - 当使用 GitHub Enterprise 时，当前安装的 GHE 版本。</li></ul> <p>要使用 GitLab 进行身份验证，可以定义以下环境变量。</p> <ul><li><code>GL_TOKEN</code>（必须）- 您的 GitLab 认证 token (在用户设置(User Settings) &gt; 访问令牌(Access Tokens)下)</li> <li><code>GL_API_URL</code> - API 的绝对URL，包括版本号。(默认值：https://gitlab.com/api/v4)</li></ul> <blockquote><p>注意
当使用该配置项的时候，不要设置<code>--no-changelog</code></p></blockquote> <p>该配置项也可以在 lerna.json 中配置：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;changelogPreset&quot;</span><span class="token operator">:</span> <span class="token string">&quot;angular&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果预先导出一个构件函数（如：<code>conventional-changelog-conventionalcommits</code>），您也可以指定预设配置：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;changelogPreset&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;conventionalcommits&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;issueUrlFormat&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{{host}}/{{owner}}/{{repository}}/issues/{{id}}&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p><code>--exact</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --exact
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当使用该参数时，<code>lerna version</code> 将在更新的包中精确地指定更新过的依赖项(无标点符号)，而不做语义化版本号兼容(使用 <code>^</code>)。</p></li> <li><p><code>--force-publish</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --force-publish<span class="token operator">=</span>package-2,package-4

<span class="token comment"># 强制所有的包标上版本</span>
lerna version --force-publish
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当使用该参数时，<code>lerna version</code> 将强制发布指定的包(逗号分隔)或使用 <code>*</code> 发布所有包。</p> <blockquote><p>注意
这将跳过以更改包的 <code>lerna changed</code> 检查，并强制更新没有 <code>git diff</code> 更改的包。</p></blockquote></li> <li><p><code>--git-remote &lt;name&gt;</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --git-remote upstream
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当使用该参数时，<code>lerna version</code> 将把 <code>git</code> 更改推送到指定的远程服务器，而不是 <code>origin</code>。</p></li> <li><p><code>--ignore-changes</code></p> <p>当检测到更改的包时，忽略由通配符匹配到的文件中的更改。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --ignore-changes <span class="token string">'**/*.md'</span> <span class="token string">'**/__tests__/**'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该配置项最好通过 lerna.json 指定，既避免过早的 shell 验证也能够和 <code>lerna diff</code> 及 <code>lerna changed</code> 共享配置：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;ignoreChanges&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;**/__fixtures__/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;**/__tests__/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;**/*.md&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用 <code>--no-ignore-changes</code> 禁用任何现有的持久配置。</p> <blockquote><p>在下列情况下，无论该配置项如何设置，包都会发布：</p> <ol><li>该包的最新版本是 prerelease 版(即 <code>1.0.0-alpha</code>，<code>1.0.0-0.3.7</code> 等等)。</li> <li>包的一个或多个相关依赖项已发生更改。</li></ol></blockquote></li> <li><p><code>--ignore-scripts</code></p> <p>当使用该参数时，<code>lerna version</code>会在运行期间禁用生命周期脚本。</p></li> <li><p><code>--include-merged-tags</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --include-merged-tags
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在检测更改的包时包含合并分支的标记。</p></li> <li><p><code>--message &lt;msg&gt;</code></p> <p>可简写为 <code>-m</code>，用于 <code>git commit</code>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version -m <span class="token string">&quot;chore(release): publish %s&quot;</span>
<span class="token comment"># commit message = &quot;chore(release): publish v1.0.0&quot;</span>

lerna version -m <span class="token string">&quot;chore(release): publish %v&quot;</span>
<span class="token comment"># commit message = &quot;chore(release): publish 1.0.0&quot;</span>

<span class="token comment"># 当单独对包进行版本控制时，不会替换占位符</span>
lerna version -m <span class="token string">&quot;chore(release): publish&quot;</span>
<span class="token comment"># commit message = &quot;chore(release): publish</span>
<span class="token comment">#</span>
<span class="token comment"># - package-1@3.0.1</span>
<span class="token comment"># - package-2@1.5.4&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当使用该参数时，<code>lerna version</code> 会在提交发布版本更新时使用所提供的消息。对于将 lerna 集成到期望提交消息遵守某些规则的项目中非常有用，例如使用 <code>commitizen</code> 和 <code>/</code> 或语义化版本发布的项目。</p> <p>如果消息包含 <code>%s</code>，则将其替换为新的全局版本版本号，该版本号前缀为 &quot;<code>v</code>&quot;。如果消息包含 <code>%v</code>，它将被替换为新的全局版本版本号，但没有前缀 &quot;<code>v</code>&quot;。注意，这个占位符插值只在使用默认的&quot;固定&quot;版本模式时使用，因为在独立版本控制时没有&quot;全局&quot;版本可以进行插值。</p> <p>在 lerna.json 中这样配置：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chore(release): publish %s&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p><code>--no-changelog</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --conventional-commits --no-changelog
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用 <code>--conventional-commits</code> 时，不要生成任何 CHANGELOG.md 文件。</p> <blockquote><p>注意
当使用该配置项的时候，不要设置 <code>--create-release</code></p></blockquote></li> <li><p><code>--no-commit-hooks</code></p> <p>默认情况下，<code>lerna version</code> 将允许 <code>git commit</code> 钩子在提交版本更改时运行。通过 <code>——no-commit-hook</code> 来禁用此行为。</p> <p>该配置项类似于 <code>npm version</code> 的 <code>--commit-hooks</code> 配置项，只是反过来了。</p></li> <li><p><code>--no-git-tag-version</code></p> <p>默认情况下，<code>lerna version</code> 将提交对 package.json 文件的更改，并标记发行版。通过 <code>——no-git-tag-version</code> 可以禁用该行为。</p> <p>该配置项与 <code>npm version</code> 的配置项 <code>--git-tag-version</code> 相类似，只是反过来了。</p></li> <li><p><code>--no-granular-pathspec</code></p> <p>默认情况下，<code>lerna version</code> 将在 <code>git add</code> 时只添加在版本控制过程中更改过的叶子包 manifest (可能还有更改日志)。这相当于 <code>git add -- packages/*/package.json</code>，但是精确地定制了变化。</p> <p>如果您确定需要不同的行为，您就会理解：通过 <code>——no-granular-pathspec</code> 来使 git 命令执行 <code>git add -- .</code>。通过设置 <code>pathspec</code>，您必须将所有秘密和构建输出适当地忽略掉，否则它们会被提交并推到仓库的。</p> <p>通过lerna.json设置：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;independent&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;granularPathspec&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>采用根级配置是有意为之，因为它还包括了 <code>lerna publish</code> 中的同名配置项。</p></li> <li><p><code>--no-private</code></p> <p>默认情况下，<code>lerna version</code> 将在选择版本、提交和标记发布时包含私有包。我们可以通过 <code>--no-private</code> 来禁用该行为。</p> <blockquote><p>注意
该配置项并未将私有作用域的包排除在外，只会排除 package.json 文件中<code>private</code>字段设置为<code>true</code>的包。</p></blockquote></li> <li><p><code>--no-push</code></p> <p>默认情况下，<code>lerna version</code> 将提交和标记的更改推到已配置的 git 远程服务器。设置 <code>--no-push</code> 来禁用此行为。</p></li> <li><p><code>--preid</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version prerelease
<span class="token comment"># 使用下一个语义化预发布版本，如：</span>
<span class="token comment"># 1.0.0 =&gt; 1.0.1-alpha.0</span>

lerna version prepatch --preid next
<span class="token comment"># 通过制定的预发布标识符以使用下一个语义化预发布版本，如</span>
<span class="token comment"># 1.0.0 =&gt; 1.0.1-next.0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用该参数时，<code>lerna version</code> 将使用指定的 <code>prerelease</code> 标识符递增 <code>premajor</code>、<code>preminor</code>、<code>prepatch</code> 或 <code>prerelease</code> 语义化版本号。</p></li> <li><p><code>--sign-git-commit</code></p> <p>该配置项和 <code>npm version</code> 的同名配置项相类似。</p></li> <li><p><code>--sign-git-tag</code></p> <p>该配置项和 <code>npm version</code> 的同名配置项相类似。</p></li> <li><p><code>--force-git-tag</code></p> <p>该配置项将替换任意的现有标签，而非失败信息。</p></li> <li><p><code>--tag-version-prefix</code></p> <p>该配置项允许设置自定义前缀，默认的前缀是: <code>v</code>。</p> <blockquote><p>目前您必须设置两次：分别对应 version 命令和 publish 命令。</p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 本地</span>
lerna version --tag-version-prefix<span class="token operator">=</span><span class="token string">''</span>
<span class="token comment"># 在 CI 上</span>
lerna publish from-git --tag-version-prefix<span class="token operator">=</span><span class="token string">''</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p><code>--yes</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna version --yes
<span class="token comment"># 跳过 `Are you sure you want to publish these packages?`</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当使用该参数运行时，<code>lerna version</code> 将将跳过所有确认提示。在持续集成(CI)中用于自动回答发布确认提示。</p></li></ul></li> <li><p>生成初始的更新日志</p> <p>如果您在 monorepo 启动一段时间后才开始使用 <code>--conventional-commits</code> 配置项，您仍然可以使用 <code>conventional-changelog-cli</code> 和 <code>lerna exec</code> 为以前的版本生成更改日志。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># Lerna does not actually use conventional-changelog-cli, so you need to install it temporarily</span>
<span class="token function">npm</span> i -D conventional-changelog-cli
<span class="token comment"># Documentation: `npx conventional-changelog --help`</span>

<span class="token comment"># fixed versioning (default)</span>
<span class="token comment"># run in root, then leaves</span>
npx conventional-changelog --preset angular --release-count <span class="token number">0</span> --outfile ./CHANGELOG.md --verbose
npx lerna <span class="token builtin class-name">exec</span> --concurrency <span class="token number">1</span> --stream -- <span class="token string">'conventional-changelog --preset angular --release-count 0 --commit-path $PWD --pkg $PWD/package.json --outfile $PWD/CHANGELOG.md --verbose'</span>

<span class="token comment"># independent versioning</span>
<span class="token comment"># (no root changelog)</span>
npx lerna <span class="token builtin class-name">exec</span> --concurrency <span class="token number">1</span> --stream -- <span class="token string">'conventional-changelog --preset angular --release-count 0 --commit-path $PWD --pkg $PWD/package.json --outfile $PWD/CHANGELOG.md --verbose --lerna-package $LERNA_PACKAGE_NAME'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>如果您使用 <code>--changelog-preset</code> 进行自定义，那么您应该相应地更改上面的示例中的 <code>--preset</code> 值。</p></li></ul> <h4 id="lerna-diff-package"><a href="#lerna-diff-package" class="header-anchor">#</a> <code>lerna diff [package]</code></h4> <ul><li><p>作用</p> <p>获取上次发布后所有包或某个包的代码变更情况。</p></li> <li><p>使用</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>lerna <span class="token function">diff</span> <span class="token punctuation">[</span>package<span class="token punctuation">]</span>

lerna <span class="token function">diff</span>
<span class="token comment"># 显示指定包的差异</span>
lerna <span class="token function">diff</span> package-name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>底层依赖<code>git diff</code>实现。</p></li></ul> <h4 id="lerna-changed"><a href="#lerna-changed" class="header-anchor">#</a> <code>lerna changed</code></h4> <ul><li><p>作用</p> <p>列出自上次标记发布以来发生变化的本地包。</p></li> <li><p>使用</p> <p><code>lerna changed</code>输出的是下一个 <code>lerna version</code> 或 <code>lerna publish</code> 执行后的包列表。</p> <blockquote><p><code>lerna publish</code> 和 <code>lerna version</code> 的 lerna.json 配置也会影响 <code>lerna changed</code>。比如 <code>command.publish.ignoreChanges</code>。</p></blockquote></li> <li><p>配置项</p> <p><code>lerna changed</code> 支持 <code>lerna ls</code> 的所有参数。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>--json
--ndjson
--a, --all
-l, --long
-p, --parseable
--toposort
--graph
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>和 <code>lerna ls</code> 不同，<code>lerna changed</code> 并不支持过滤器配置项，因为其本身并不为 <code>lerna version</code> 或 <code>lerna publish</code> 所支持。</p> <p><code>lerna changed</code> 支持下列 <code>lerna version</code> 的配置项(其他的都无关紧要了):</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>--conventional-graduate
--force-publish
--ignore-changes
--include-merged-tags
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ul> <h4 id="lerna-info"><a href="#lerna-info" class="header-anchor">#</a> <code>lerna info</code></h4> <ul><li><p>作用</p> <p>打印本地环境信息。</p></li> <li><p>使用</p> <p><code>lerna info</code> 打印的本地环境信息在提交 bug 报告时尤其有用。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna notice cli v4.0.0

Environment info:

System:
    OS: macOS 11.2.3
    CPU: (8) arm64 Apple M1
Binaries:
    Node: 16.4.2 - ~/.nvm/versions/node/v16.4.2/bin/node
    Yarn: 1.22.10 - ~/.nvm/versions/node/v16.4.2/bin/yarn
    npm: 7.18.1 - ~/.nvm/versions/node/v16.4.2/bin/npm
Utilities:
    Git: 2.30.1 - /usr/bin/git
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li></ul> <h3 id="_9-2-2-lerna原理解析"><a href="#_9-2-2-lerna原理解析" class="header-anchor">#</a> 9.2.2 lerna原理解析</h3> <h3 id="文件结构"><a href="#文件结构" class="header-anchor">#</a> 文件结构</h3> <p>以下是 lerna 的主要目录结构（省略了一些文件和文件夹）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>lerna
├─ CHANGELOG.md -- 更新日志
├─ README.md -- 文档
├─ commands -- 核心子模块
├─ core -- 核心子模块
├─ utils -- 核心子模块
├─ lerna.json -- lerna 配置文件
├─ package-lock.json -- 依赖声明
├─ package.json -- 依赖声明
├─ scripts -- 内置脚本
└─ yarn.lock -- 依赖声明
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>有趣的是，lerna 本身也是用 lerna 进行开发管理的。它是一个 monorepo 项目，其各个子项目分布在 <code>lerna/commands/*、core/*、utils/*</code>目 录下。</p> <p>另外，在源码中，经常会看到名称为 <code>@lerna/command</code> 的子项目，如 <code>lerna/core/lerna/index.js</code> 的内容是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> cli <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/cli&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> addCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/add/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bootstrapCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/bootstrap/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> changedCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/changed/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cleanCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/clean/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> createCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/create/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> diffCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/diff/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> execCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/exec/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> importCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/import/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> infoCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/info/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> initCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/init/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> linkCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/link/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> listCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/list/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> publishCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/publish/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> runCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/run/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> versionCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/version/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这些子项目分布在 <code>lerna/commands/*、core/*、utils/*</code> 下，截至本书截稿时，lerna有 61 个子项目。</p> <p>以下是各子项目分布：</p> <table><thead><tr><th>相对路径</th> <th>package 名称</th> <th>作用</th></tr></thead> <tbody><tr><td><code>lerna/commands/add</code></td> <td><code>@lerna/add</code></td> <td></td></tr> <tr><td><code>lerna/commands/bootstrap</code></td> <td><code>@lerna/bootstrap</code></td> <td></td></tr> <tr><td><code>lerna/commands/changed</code></td> <td><code>@lerna/changed</code></td> <td></td></tr> <tr><td><code>lerna/commands/clean</code></td> <td><code>@lerna/clean</code></td> <td></td></tr> <tr><td><code>lerna/commands/create</code></td> <td><code>@lerna/create</code></td> <td></td></tr> <tr><td><code>lerna/commands/diff</code></td> <td><code>@lerna/diff</code></td> <td></td></tr> <tr><td><code>lerna/commands/exec</code></td> <td><code>@lerna/exec</code></td> <td></td></tr> <tr><td><code>lerna/commands/import</code></td> <td><code>@lerna/import</code></td> <td></td></tr> <tr><td><code>lerna/commands/info</code></td> <td><code>@lerna/info</code></td> <td></td></tr> <tr><td><code>lerna/commands/init</code></td> <td><code>@lerna/init</code></td> <td></td></tr> <tr><td><code>lerna/commands/link</code></td> <td><code>@lerna/link</code></td> <td></td></tr> <tr><td><code>lerna/commands/list</code></td> <td><code>@lerna/list</code></td> <td></td></tr> <tr><td><code>lerna/commands/publish</code></td> <td><code>@lerna/publish</code></td> <td></td></tr> <tr><td><code>lerna/commands/run</code></td> <td><code>@lerna/run</code></td> <td></td></tr> <tr><td><code>lerna/commands/version</code></td> <td><code>@lerna/version</code></td> <td></td></tr> <tr><td><code>lerna/core/child-process</code></td> <td><code>@lerna/child-process</code></td> <td></td></tr> <tr><td><code>lerna/core/cli</code></td> <td><code>@lerna/cli</code></td> <td></td></tr> <tr><td><code>lerna/core/command</code></td> <td><code>@lerna/command</code></td> <td></td></tr> <tr><td><code>lerna/core/conventional-commits</code></td> <td><code>@lerna/conventional-commits</code></td> <td></td></tr> <tr><td><code>lerna/core/filter-options</code></td> <td><code>@lerna/filter-options</code></td> <td></td></tr> <tr><td><code>lerna/core/global-options</code></td> <td><code>@lerna/global-options</code></td> <td></td></tr> <tr><td><code>lerna/core/lerna</code></td> <td><code>lerna</code></td> <td></td></tr> <tr><td><code>lerna/core/otplease</code></td> <td><code>@lerna/otplease</code></td> <td></td></tr> <tr><td><code>lerna/core/package</code></td> <td><code>@lerna/package</code></td> <td></td></tr> <tr><td><code>lerna/core/package-graph</code></td> <td><code>@lerna/package-graph</code></td> <td></td></tr> <tr><td><code>lerna/core/project</code></td> <td><code>@lerna/project</code></td> <td></td></tr> <tr><td><code>lerna/core/prompt</code></td> <td><code>@lerna/prompt</code></td> <td></td></tr> <tr><td><code>lerna/core/validation-error</code></td> <td><code>@lerna/validation-error</code></td> <td></td></tr> <tr><td><code>lerna/utils/check-working-tree</code></td> <td><code>@lerna/check-working-tree</code></td> <td></td></tr> <tr><td><code>lerna/utils/check-uncommitted</code></td> <td><code>@lerna/check-uncommitted</code></td> <td></td></tr> <tr><td><code>lerna/utils/check-updates</code></td> <td><code>@lerna/check-updates</code></td> <td></td></tr> <tr><td><code>lerna/utils/check-symlink</code></td> <td><code>@lerna/check-symlink</code></td> <td></td></tr> <tr><td><code>lerna/utils/describe-ref</code></td> <td><code>@lerna/describe-ref</code></td> <td></td></tr> <tr><td><code>lerna/utils/filter-packages</code></td> <td><code>@lerna/filter-packages</code></td> <td></td></tr> <tr><td><code>lerna/utils/get-npm-exec-opts</code></td> <td><code>@lerna/get-npm-exec-opts</code></td> <td></td></tr> <tr><td><code>lerna/utils/get-packed</code></td> <td><code>@lerna/get-packed</code></td> <td></td></tr> <tr><td><code>lerna/utils/github-client</code></td> <td><code>@lerna/github-client</code></td> <td></td></tr> <tr><td><code>lerna/utils/gitlab-client</code></td> <td><code>@lerna/gitlab-client</code></td> <td></td></tr> <tr><td><code>lerna/utils/has-npm-version</code></td> <td><code>@lerna/has-npm-version</code></td> <td></td></tr> <tr><td><code>lerna/utils/listable</code></td> <td><code>@lerna/listable</code></td> <td></td></tr> <tr><td><code>lerna/utils/log-packed</code></td> <td><code>@lerna/log-packed</code></td> <td></td></tr> <tr><td><code>lerna/utils/map-to-registry</code></td> <td><code>@lerna/map-to-registry</code></td> <td></td></tr> <tr><td><code>lerna/utils/npm-conf</code></td> <td><code>@lerna/npm-conf</code></td> <td></td></tr> <tr><td><code>lerna/utils/npm-dist-tag</code></td> <td><code>@lerna/npm-dist-tag</code></td> <td></td></tr> <tr><td><code>lerna/utils/npm-install</code></td> <td><code>@lerna/npm-install</code></td> <td></td></tr> <tr><td><code>lerna/utils/npm-publish</code></td> <td><code>@lerna/npm-publish</code></td> <td></td></tr> <tr><td><code>lerna/utils/npm-run-script</code></td> <td><code>@lerna/npm-run-script</code></td> <td></td></tr> <tr><td><code>lerna/utils/output</code></td> <td><code>@lerna/output</code></td> <td></td></tr> <tr><td><code>lerna/utils/pack-directory</code></td> <td><code>@lerna/pack-directory</code></td> <td></td></tr> <tr><td><code>lerna/utils/prerelease-id-from-version</code></td> <td><code>@lerna/prerelease-id-from-version</code></td> <td></td></tr> <tr><td><code>lerna/utils/profiler</code></td> <td><code>@lerna/profiler</code></td> <td></td></tr> <tr><td><code>lerna/utils/pluse-till-done</code></td> <td><code>@lerna/pluse-till-done</code></td> <td></td></tr> <tr><td><code>lerna/utils/query-graph</code></td> <td><code>@lerna/query-graph</code></td> <td></td></tr> <tr><td><code>lerna/utils/resolve-symlink</code></td> <td><code>@lerna/resolve-symlink</code></td> <td></td></tr> <tr><td><code>lerna/utils/rimraf-dir</code></td> <td><code>@lerna/rimraf-dir</code></td> <td></td></tr> <tr><td><code>lerna/utils/run-lifecycle</code></td> <td><code>@lerna/run-lifecycle</code></td> <td></td></tr> <tr><td><code>lerna/utils/run-topologically</code></td> <td><code>@lerna/run-topologically</code></td> <td></td></tr> <tr><td><code>lerna/utils/symlink-binary</code></td> <td><code>@lerna/symlink-binary</code></td> <td></td></tr> <tr><td><code>lerna/utils/symlink-dependencies</code></td> <td><code>@lerna/symlink-dependencies</code></td> <td></td></tr> <tr><td><code>lerna/utils/timer</code></td> <td><code>@lerna/timer</code></td> <td></td></tr> <tr><td><code>lerna/utils/write-log-file</code></td> <td><code>@lerna/write-log-file</code></td> <td></td></tr></tbody></table> <h3 id="命令行注册"><a href="#命令行注册" class="header-anchor">#</a> 命令行注册</h3> <p>lerna 命令注册工作集中在 <code>lerna/core/lerna/*</code> 路径下。</p> <ul><li><p><code>lerna/core/lerna/package.json</code></p> <p>该文件的 <code>bin</code> 字段定义了 <code>lerna</code> 命令：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;lerna&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cli.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>lerna/core/lerna/cli.js</code></p> <p>该文件描述了命令行的执行入口：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token hashbang comment">#!/usr/bin/env node</span>

<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/* eslint-disable import/no-dynamic-require, global-require */</span>
<span class="token keyword">const</span> importLocal <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;import-local&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">importLocal</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;npmlog&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;cli&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;using local version of lerna&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p><code>lerna/core/lerna/index.js</code></p> <p>该文件为命令行引入了所有 lerna 指令：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cli <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/cli&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> addCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/add/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bootstrapCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/bootstrap/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> changedCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/changed/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cleanCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/clean/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> createCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/create/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> diffCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/diff/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> execCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/exec/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> importCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/import/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> infoCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/info/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> initCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/init/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> linkCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/link/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> listCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/list/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> publishCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/publish/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> runCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/run/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> versionCmd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/version/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./package.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> main<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter">argv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">lernaVersion</span><span class="token operator">:</span> pkg<span class="token punctuation">.</span>version<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token function">cli</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>addCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>bootstrapCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>changedCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>cleanCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>createCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>diffCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>execCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>importCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>infoCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>initCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>linkCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>listCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>publishCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>runCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span>versionCmd<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div></li> <li><p><code>Commander</code> 类</p> <p>lerna 的子命令均继承自 <code>Command</code> 类，比如 <code>lerna init</code> 命令定义为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Command <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@lerna/command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">InitCommand</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>Command</code> 类定义在 <code>@lerna/command</code>，位于 <code>lerna/core/command</code> 目录。</p> <p>有一些写法值得借鉴，比如个别方法需要 <code>InitCommand</code> 的实例自行定义，否则抛错，<code>InitCommand</code> 类的定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">InitCommand</span> <span class="token keyword">extends</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>
    
    <span class="token operator">...</span>

    <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ValidationError</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;initialize() needs to be implemented.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ValidationError</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;execute() needs to be implemented.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p><code>import-local</code></p> <p>上文提到，<code>lerna/core/lerna/cli.js</code> 描述了命令行的执行入口：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token hashbang comment">#!/usr/bin/env node</span>

<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/* eslint-disable import/no-dynamic-require, global-require */</span>
<span class="token keyword">const</span> importLocal <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;import-local&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">importLocal</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;npmlog&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;cli&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;using local version of lerna&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>其中，<code>import-local</code> 的作用是，实现本地开发版本和生产版本的切换。<code>import-local/index.js</code> 的内容是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> resolveCwd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'resolve-cwd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pkgDir <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pkg-dir'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">filename</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> globalDir <span class="token operator">=</span> pkgDir<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> relativePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>globalDir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>globalDir<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> localFile <span class="token operator">=</span> resolveCwd<span class="token punctuation">.</span><span class="token function">silent</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>name<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> localNodeModules <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> filenameInLocalNodeModules <span class="token operator">=</span> <span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>localNodeModules<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Use `path.relative()` to detect local package installation,</span>
    <span class="token comment">// because __filename's case is inconsistent on Windows</span>
    <span class="token comment">// Can use `===` when targeting Node.js 8</span>
    <span class="token comment">// See https://github.com/nodejs/node/issues/6624</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>filenameInLocalNodeModules <span class="token operator">&amp;&amp;</span> localFile <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>localFile<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">''</span> <span class="token operator">&amp;&amp;</span> <span class="token function">require</span><span class="token punctuation">(</span>localFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>原理解析：TODO</p></li></ul> <h3 id="依赖管理"><a href="#依赖管理" class="header-anchor">#</a> 依赖管理</h3> <p>Babel使用 <code>lerna</code> 进行依赖管理。其中，<code>lerna</code> 自己实现了一套依赖管理机制，也支持基于 <code>yarn</code> 的依赖管理。</p> <ul><li><p>yarn的依赖管理</p> <p>pnp: https://loveky.github.io/2019/02/11/yarn-pnp/</p> <p>官网: https://yarnpkg.com/features/pnp</p> <p>https://www.yuque.com/allenstone/learn/deb1n1</p> <p>对比: https://www.qiyuandi.com/zhanzhang/zonghe/12444.html</p></li> <li><p>lerna 的 <code>hoisting</code></p> <p>子模块相同的依赖可以通过依赖提升（<code>hoisting</code>），将相同的依赖安装在根目录下，本地包之间用软连接实现。</p> <ul><li><p><code>lerna bootstrap</code></p> <p>该命令执行时，会在每个子项目下面，各自安装其中 package.json 声明的依赖。</p> <p>这样会有一个问题，相同的依赖会被重复安装，除了占用更多空间外，依赖安装速度也受影响。</p></li> <li><p><code>lerna bootstrap --hoist</code></p> <p><code>--hoist</code> 标记时，<code>lerna bootstrap</code> 会识别子项目下名称和版本号相同的依赖，并将其安装在根目录的 <code>node_modules</code> 下，子项目的 <code>node_modules</code> 会生成软连接。</p> <p>这样节省了空间，也减少了依赖安装的耗时。</p></li> <li><p><code>yarn install</code></p> <p>当在项目中声明 <code>yarn</code> 作为依赖安装的底层依赖，如：</p> <p>lerna.json</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;npmClient&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;useWorkspaces&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>package.json</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;workspaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;packages/*&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>相对于 <code>lerna</code>，<code>yarn</code> 提供了更强大的依赖分析能力、hoisting 算法。而且，默认情况下，yarn 会开启 <code>hoist</code> 功能，也可以设置 <code>nohoist</code> 关闭该功能：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;workspaces&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;Packages/*&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;nohoist&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;**&quot;</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ul></li></ul> <h3 id="git相关"><a href="#git相关" class="header-anchor">#</a> Git相关</h3> <p>lerna 中广泛使用了 Git 命令用于内部工作，这里列举了 lerna 中使用的 Git 命令。</p> <ul><li><p><code>git init</code></p></li> <li><p><code>git rev-parse</code></p></li> <li><p><code>git describe</code></p></li> <li><p><code>git rev-list</code></p></li> <li><p><code>git tag</code></p></li> <li><p><code>git log</code></p></li> <li><p><code>git config</code></p></li> <li><p><code>git diff-index</code></p></li> <li><p><code>git --version</code></p></li> <li><p><code>git show</code></p></li> <li><p><code>git am</code></p></li> <li><p><code>git reset</code></p></li> <li><p><code>git ls-files</code></p></li> <li><p><code>git diff-tree</code></p></li> <li><p><code>git commit</code></p></li> <li><p><code>git ls-remote</code></p></li> <li><p><code>git checkout</code></p></li> <li><p><code>git push</code></p></li> <li><p><code>git add</code></p></li> <li><p><code>git remote</code></p></li> <li><p><code>git show-ref</code></p></li></ul> <h2 id="_9-3-todo"><a href="#_9-3-todo" class="header-anchor">#</a> 9.3 TODO</h2></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><!----> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">March 9, 2022 10:03</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: antfootmail@gmail.com" class="contributor">
          hoperyy
        </span> <!----></span></div></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/books/dib/assets/js/app.809f2d11.js" defer></script><script src="/books/dib/assets/js/vendors~layout-Layout.d24908b2.js" defer></script><script src="/books/dib/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" defer></script><script src="/books/dib/assets/js/page--d99aed8e.d5506aaa.js" defer></script><script src="/books/dib/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" defer></script>
  </body>
</html>
