<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《深入理解 Babel》 · 刘远洋</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="manifest" href="/books/dib/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="Just playing around">
    <meta property="og:url" content="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/">
    <meta property="og:site_name" content="《深入理解 Babel》 · 刘远洋">
    <meta property="og:description" content="接触过 Babel 插件编写的话，可能有个感受，官方文档提供的介绍太少了，社区中关于如何写插件介绍的比较多，但对其中用到的工具的介绍却比较少。 为什么需要插件呢？ babel-parser 主要有两个功能： 1. 识别各种语法，且默认情况下，并不开启所有语法的识别支持，这是出于性能考虑 2. 解析源码字符串为抽象语法树，并不负责对源码的转译 在Babel的整">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="《深入理解 Babel》 · 刘远洋">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <link rel="preload" href="/books/dib/assets/css/0.styles.e02910b1.css" as="style"><link rel="preload" href="/books/dib/assets/js/app.8353d921.js" as="script"><link rel="preload" href="/books/dib/assets/js/vendors~layout-Layout.f8963aab.js" as="script"><link rel="preload" href="/books/dib/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" as="script"><link rel="preload" href="/books/dib/assets/js/page--8fcba694.bce8a031.js" as="script"><link rel="preload" href="/books/dib/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" as="script"><link rel="prefetch" href="/books/dib/assets/js/22.6353f00e.js"><link rel="prefetch" href="/books/dib/assets/js/layout-Blog.b0c6dcb7.js"><link rel="prefetch" href="/books/dib/assets/js/layout-Layout.54347a9b.js"><link rel="prefetch" href="/books/dib/assets/js/layout-NotFound.846facba.js"><link rel="prefetch" href="/books/dib/assets/js/layout-Slide.88fa1023.js"><link rel="prefetch" href="/books/dib/assets/js/page--4c0dc106.e01026ad.js"><link rel="prefetch" href="/books/dib/assets/js/page--4fdeacc4.4fefec57.js"><link rel="prefetch" href="/books/dib/assets/js/page--584954b8.4de9e155.js"><link rel="prefetch" href="/books/dib/assets/js/page--5e0b8312.811f53a6.js"><link rel="prefetch" href="/books/dib/assets/js/page--6723acaa.de33344c.js"><link rel="prefetch" href="/books/dib/assets/js/page--6ea6aa74.2faeac60.js"><link rel="prefetch" href="/books/dib/assets/js/page--9bf3e428.c48ad253.js"><link rel="prefetch" href="/books/dib/assets/js/page--aec4dcea.791e332f.js"><link rel="prefetch" href="/books/dib/assets/js/page--c3b426fa.583b2445.js"><link rel="prefetch" href="/books/dib/assets/js/page--d99aed8e.8fc5ad8d.js"><link rel="prefetch" href="/books/dib/assets/js/page-前言.11daa51b.js"><link rel="prefetch" href="/books/dib/assets/js/vendors~photo-swipe.e221f9da.js">
    <link rel="stylesheet" href="/books/dib/assets/css/0.styles.e02910b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/books/dib/" class="home-link router-link-active"><!----> <!----> <span class="site-name can-hide">《深入理解 Babel》 · 刘远洋</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://notelyio.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  撰写工具 · Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github · hoperyy
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></nav> <!----> <!----> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="https://notelyio.com/home" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  撰写工具 · Notely
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/hoperyy" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github · hoperyy
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><a href="/books/dib/00.%E5%89%8D%E8%A8%80/" class="sidebar-link">第 0 章 - 前言</a></li><li><a href="/books/dib/01.%E6%A6%82%E8%BF%B0/" class="sidebar-link">第 1 章 - 概述</a></li><li><a href="/books/dib/02.%E8%BD%AC%E8%AF%91%E5%8E%9F%E7%90%86/" class="sidebar-link">第 2 章 - 转译原理</a></li><li><a href="/books/dib/03.Babel%E8%8A%82%E7%82%B9/" class="sidebar-link">第 3 章 - Babel 节点</a></li><li><a href="/books/dib/04.Babel%E5%B7%A5%E5%85%B7%E9%9B%86/" class="sidebar-link">第 4 章 - Babel 工具集</a></li><li><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/" aria-current="page" class="active sidebar-link">第 5 章 - Babel 插件编写</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-遍历节点" class="sidebar-link">5.1 遍历节点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-1-babel-traverse" class="sidebar-link heading3">5.1.1 babel-traverse</a></li><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-2-visitor" class="sidebar-link heading3">5.1.2 Visitor</a></li><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-3-path" class="sidebar-link heading3">5.1.3 path</a></li><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#path功能" class="sidebar-link heading3">path功能</a></li><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#api" class="sidebar-link heading3">API</a></li><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-4-state" class="sidebar-link heading3">5.1.4 state</a></li></ul></li><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-2-节点操作-babel-types" class="sidebar-link">5.2 节点操作: babel-types</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-2-1-读节点" class="sidebar-link heading3">5.2.1 读节点</a></li><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-2-2-写节点" class="sidebar-link heading3">5.2.2 写节点</a></li></ul></li><li class="sidebar-sub-header"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-3-插件编写实战" class="sidebar-link">5.3 插件编写实战</a></li></ul></li><li><a href="/books/dib/06.Babel%E5%86%85%E7%BD%AEplugin/" class="sidebar-link">第 6 章 - Babel 内置 Plugin</a></li><li><a href="/books/dib/07.Babel%E5%86%85%E7%BD%AEpreset/" class="sidebar-link">第 7 章 - Babel 内置 Preset</a></li><li><a href="/books/dib/08.runtime/" class="sidebar-link">第 8 章 - runtime</a></li><li><a href="/books/dib/09.Babel%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" class="sidebar-link">第 9 章 - Babel 项目管理</a></li><li><a href="/books/dib/10.%E8%BD%AC%E8%AF%91%E5%99%A8%E5%AF%B9%E6%AF%94/" class="sidebar-link">第 10 章 - 转译器对比</a></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline"></span></h1> <div class="page-info"><!----> <!----><!----><span aria-label="Writing Date📅" data-balloon-pos="down" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2022-2-24</span></span><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 25 min</span> <meta property="timeRequired" content="PT25M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-遍历节点" class="anchor-link heading2"><div>5.1 遍历节点</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-1-babel-traverse" class="anchor-link heading3"><div>5.1.1 babel-traverse</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-2-visitor" class="anchor-link heading3"><div>5.1.2 Visitor</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-3-path" class="anchor-link heading3"><div>5.1.3 path</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#path功能" class="anchor-link heading3"><div>path功能</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#api" class="anchor-link heading3"><div>API</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-1-4-state" class="anchor-link heading3"><div>5.1.4 state</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-2-节点操作-babel-types" class="anchor-link heading2"><div>5.2 节点操作: babel-types</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-2-1-读节点" class="anchor-link heading3"><div>5.2.1 读节点</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-2-2-写节点" class="anchor-link heading3"><div>5.2.2 写节点</div></a></li><li class="anchor"><a href="/books/dib/05.Babel%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99/#_5-3-插件编写实战" class="anchor-link heading2"><div>5.3 插件编写实战</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><p>接触过 Babel 插件编写的话，可能有个感受，官方文档提供的介绍太少了，社区中关于如何写插件介绍的比较多，但对其中用到的工具的介绍却比较少。</p> <p>为什么需要插件呢？</p> <p>babel-parser 主要有两个功能：</p> <ol><li>识别各种语法，且默认情况下，并不开启所有语法的识别支持，这是出于性能考虑</li> <li>解析源码字符串为抽象语法树，并不负责对源码的转译</li></ol> <p>在Babel的整体设计中，对于部分语法支持的开关、对抽象语法树的读取和修改等操作，均用插件配合完成。有些插件可以作为语法开关，有些插件可以解析修改抽象语法树以实现转译功能。</p> <p>那么，本章就来攻克下 Babel 插件编写这一环吧。</p> <p>编写插件的过程，实际上是对 AST 节点的遍历和操作。需要了解如何遍历节点、如何操作节点。</p> <h2 id="_5-1-遍历节点"><a href="#_5-1-遍历节点" class="header-anchor">#</a> 5.1 遍历节点</h2> <p>Babel 通过 babel-traverse 遍历 AST 节点，并在遍历的过程中，接收开发者传入的处理逻辑对 AST 节点进行增删改查。</p> <h3 id="_5-1-1-babel-traverse"><a href="#_5-1-1-babel-traverse" class="header-anchor">#</a> 5.1.1 babel-traverse</h3> <ul><li><p>基本功能</p> <p>babel-traverse 维护了 Babel 的节点状态，通过它，可以遍历 AST 节点，插件开发者可以在遍历过程中对节点进行替换、删除、添加等操作。</p> <p>比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> parser <span class="token keyword">from</span> <span class="token string">'@babel/parser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> traverse <span class="token keyword">from</span> <span class="token string">'@babel/traverse'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> generator <span class="token keyword">from</span> <span class="token string">'@babel/generator'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function square(n) {
    return n * n;
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'Identifier'</span> <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'x'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> newCode <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>traverse</code> 接收一些参数，并处理后，AST 发生了变动。</p> <p>上述代码执行后，打印 <code>newCode</code> 结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">*</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>参数</p> <p>babel-traverse 对外暴露的方法 <code>traverse</code> 定义在 <code>packages/babel-traverse/src/index.ts</code>：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">traverse</span><span class="token punctuation">(</span>
    parent<span class="token operator">:</span> t<span class="token punctuation">.</span>Node<span class="token punctuation">,</span>
    opts<span class="token operator">:</span> TraverseOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    scope<span class="token operator">?</span><span class="token operator">:</span> Scope<span class="token punctuation">,</span>
    state<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
    parentPath<span class="token operator">?</span><span class="token operator">:</span> NodePath<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>各参数含义如下：</p> <ul><li><p><code>parent</code>: 要遍历的节点对象</p></li> <li><p><code>opts</code>: 遍历配置项</p> <p>参数 <code>opts</code> 的类型描述 <code>TraverseOptions</code> 内容如下：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> <span class="token class-name">TraverseOptions<span class="token operator">&lt;</span><span class="token constant">S</span> <span class="token operator">=</span> t<span class="token punctuation">.</span>Node<span class="token operator">&gt;</span></span> <span class="token operator">=</span>
<span class="token operator">|</span> <span class="token punctuation">{</span>
    scope<span class="token operator">?</span><span class="token operator">:</span> Scope<span class="token punctuation">;</span>
    noScope<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
    denylist<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">|</span> Visitor<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>也就是说，<code>opts</code> 的值可以是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> scope<span class="token punctuation">,</span> noScope<span class="token punctuation">,</span> denyList <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以是一个 Visitor（访问者），下节将详细介绍 Visitor。</p></li> <li><p><code>state</code>: TODO</p> <p>TODO</p></li> <li><p><code>parentPath</code>: TODO</p> <p>TODO</p></li></ul></li></ul> <h3 id="_5-1-2-visitor"><a href="#_5-1-2-visitor" class="header-anchor">#</a> 5.1.2 Visitor</h3> <ul><li><p>访问者模式</p> <p>TODO</p></li> <li><p>Visitor 对象</p> <p>babel-traverse 接收一个 Visitor 对象，开发者通过该对象可以拦截 babel-traverse 对某个节点的访问时刻，并做处理。</p> <p>Visitor 对象有哪些格式呢？babel-traverse 中定义的 Visitor 类型如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> type Visitor<span class="token operator">&lt;</span><span class="token constant">S</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token operator">=</span> VisitNodeObject<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Node<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>Type <span class="token keyword">in</span> t<span class="token punctuation">.</span>Node<span class="token punctuation">[</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">:</span> VisitNode<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> Extract<span class="token operator">&lt;</span>t<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Type <span class="token punctuation">}</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token operator">&amp;</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> keyof t<span class="token punctuation">.</span>Aliases<span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">:</span> VisitNode<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Aliases<span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token operator">&amp;</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token constant">K</span> <span class="token keyword">in</span> keyof VirtualTypeAliases<span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">:</span> VisitNode<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> VirtualTypeAliases<span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>k<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> VisitNode<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Node<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> type VisitNode<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">P</span> <span class="token keyword">extends</span> <span class="token class-name">t<span class="token punctuation">.</span>Node</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
    <span class="token operator">|</span> VisitNodeFunction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">P</span><span class="token operator">&gt;</span>
    <span class="token operator">|</span> VisitNodeObject<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">P</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> type VisitNodeFunction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">P</span> <span class="token keyword">extends</span> <span class="token class-name">t<span class="token punctuation">.</span>Node</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> <span class="token constant">S</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> NodePath<span class="token operator">&lt;</span><span class="token constant">P</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token constant">S</span><span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VisitNodeObject</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">P</span> <span class="token keyword">extends</span> <span class="token class-name">t<span class="token punctuation">.</span>Node</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    enter<span class="token operator">?</span><span class="token operator">:</span> VisitNodeFunction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">P</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    exit<span class="token operator">?</span><span class="token operator">:</span> VisitNodeFunction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">P</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>可以看到，Visitor 可以有多种写法：</p> <ul><li><p>enter/exit 式写法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>比如，</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">babelTraverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>遍历ast上的每个时，<code>enter/exit</code> 均会触发。</p> <p>有意思的是，<code>babel-core</code> 内部也实用了 <code>babel-traverse</code> 对目标代码对应的 AST 节点进行遍历，但它禁止这样写，比如：</p> <p>index.js:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babel-core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const a = 1;</span><span class="token template-punctuation string">`</span></span>

babel<span class="token punctuation">.</span><span class="token function">transformSync</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'./plugin.js'</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>./plugin.js</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">api</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>babel-core 将这种写法视为非法：<code>cannot contain catch-all &quot;enter&quot; or &quot;exit&quot; handlers. Please target individual nodes.</code>。</p></li> <li><p>节点名称 + 函数式写法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>节点名称 + enter/exit 式写法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token literal-property property">Identifier</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul> <p>其中，节点名称可以是以下几种方式：</p> <ul><li><p>节点名称</p> <p>定义在 <code>babel-types/src/ast-types/generated/index.ts</code> 的 <code>Node</code> 字段。</p></li> <li><p>节点别名</p> <p>定义在 <code>babel-types/src/ast-types/generated/index.ts</code> 的 <code>Aliases</code> 字段，以及定义在 <code>babel-traverse/src/path/generated/virtual-types.ts</code> 的类型。</p></li> <li><p>其他名称</p> <p>源码中是这样写的：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token punctuation">[</span>k<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> VisitNode<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Node<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以是任何字符串，但很显然没有这么自由，具体可写的内容后文会介绍。</p></li></ul></li> <li><p>Visitor 的参数</p> <ul><li><p>对 Visitor 处理函数的封装</p> <p>babel-traverse 内部对传入的插件处理函数做了一层封装，在文件 <code>babel-traverse/src/visitors.ts</code> 中有这么一段代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> newFn <span class="token operator">=</span> fn<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">newFn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行 visitor</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> path<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newFn <span class="token operator">=</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>key<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Override toString in case this function is printed, we want to print the wrapped function, same as we do in `wrapCheck`</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>newFn <span class="token operator">!==</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newFn<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> fn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>其中，<code>fn</code> 是插件传入的处理方法，<code>newFn</code> 是封装后的方法，有这么几个特点：</p> <ul><li><code>fn</code> 的两个参数是 <code>path</code> 和 <code>state</code></li> <li><code>fn</code> 执行的时候，上下文是 <code>state</code></li> <li><code>newFn</code> 重写了 <code>toString</code> 方法，当需要打印函数体时，可以还原 <code>fn</code>，这是一个值得借鉴的细节</li></ul></li> <li><p>Visitor 的参数</p> <p>上述代码中，Visitor 对象提供的处理函数 <code>fn</code> 可接收 2 个参数：<code>path</code>、<code>state</code>，且 <code>this</code> 的值为 <code>state</code>。</p> <p><code>path</code> 和 <code>state</code> 对象描述了当前被访问节点的各类信息，这两个参数携带的属性和方法非常多，下文另开一节对其详细介绍。</p></li></ul></li> <li><p>节点处理队列</p> <p>插件开发者提供的 Visitor，在 babel-traverse 处理时，会针对每个 Visitor 的 key（节点名称），会有一个数组用于存储插件传入的处理方法，也就是说，针对一个节点，有一个处理队列。</p></li></ul> <h3 id="_5-1-3-path"><a href="#_5-1-3-path" class="header-anchor">#</a> 5.1.3 path</h3> <p>path 对象是内部 NodePath 类的实例。</p> <h3 id="path功能"><a href="#path功能" class="header-anchor">#</a> path功能</h3> <p><code>path</code> 上的 API 非常多，如下图所示：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155270654-6fdc9d73-d475-478d-9f60-fdb72342c4e2.jpg" alt="Babel插件编写/path"></p> <p>根据上图，从来源看，<code>path</code> 作为 <code>NodePath</code> 类的实例，该对象上的 API 可以分为几类：</p> <ul><li><code>path</code> 对象自身的属性和方法</li> <li><code>path</code> 继承自 <code>NodePath</code> 类的原型上的属性和方法</li> <li>各功能模块对外暴露的属性和方法，被添加到 <code>NodePath.prototype</code>，便于 <code>path</code> 使用</li> <li>各功能功能模块为 <code>path</code> 对象直接设置的属性/方法</li></ul> <p>从功能上，<code>path</code> 有以下能力：</p> <ul><li>断言与校验，等同于 babel-types 的断言</li> <li>操作祖先节点、家族节点</li> <li>替换、转换、修改、删除节点</li> <li>节点计算操作</li> <li>获取节点上下文的信息</li> <li>获取节点命名空间的信息</li> <li>和注释节点相关的操作</li> <li>...</li></ul> <h3 id="api"><a href="#api" class="header-anchor">#</a> API</h3> <p>笔者将下文中部分 API 的调用链路进行了图解，重点描述：<code>path.context</code>、插件引入的方法执行链路等信息。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155273662-d602f720-1928-48eb-a6df-88828b7af64f.jpg" alt="Babel插件编写/path-context-visit"></p> <blockquote><p>阅读建议：下文的 API 介绍可以参照上图一起了解</p></blockquote> <ul><li><p>基本属性/方法</p> <ul><li><p><code>path.node: t.Node</code></p> <p>表示 AST 节点对象。关于节点对象的具体信息，章节&quot;Babel节点集&quot;中对各个节点有详细的介绍。</p></li> <li><p><code>path.opts: any = null</code></p> <p><code>path.opts</code> 就是执行 <code>babelTraverse</code> 传入的遍历配置项。从上文的图解可以看到该属性的设置过程：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">babelTraverse</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">,</span> opts<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span>

<span class="token operator">--</span><span class="token operator">&gt;</span>

<span class="token comment">// ./context.ts</span>
context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TraversalContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span><span class="token punctuation">,</span> opts <span class="token punctuation">}</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>opts <span class="token operator">=</span> opts

<span class="token operator">--</span><span class="token operator">&gt;</span>

<span class="token comment">// ./path/context.ts</span>
path<span class="token punctuation">.</span>opts <span class="token operator">=</span> context<span class="token punctuation">.</span>opts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p><code>path.skipKeys</code></p> <ul><li>babel-traverse/src/context.ts</li></ul></li> <li><p><code>path.parentPath</code></p> <p>父级 <code>path</code> 对象。</p></li> <li><p><code>path.container</code></p> <p>TODO</p></li> <li><p><code>path.listKey</code></p></li> <li><p><code>path.key</code></p></li> <li><p><code>path.type</code></p></li> <li><p><code>path.inList</code></p></li> <li><p><code>path.getScope(scope: Scope): Scope</code></p> <p>获取当前节点对应的 <code>scope</code> 作用域空间对象。</p></li> <li><p><code>path.traverse&lt;T&gt;(visitor: Visitor&lt;T&gt;, state: T): void</code></p> <p>遍历当前节点及其子节点。</p></li> <li><p><code>path.buildCodeFrameError</code></p> <p>内部调用的是 <code>path.hub.buildError</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">buildError</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> Error <span class="token operator">=</span> TypeError<span class="token punctuation">)</span><span class="token operator">:</span> Error <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>path.parent</code></p> <p>表示当前节点的父节点。</p></li></ul></li> <li><p>上下文信息: <code>path.context</code></p> <ul><li><p><code>path.context: TraversalContext</code></p> <p><code>path.context</code> 是 <code>TraversalContext</code> 类的实例，表示当前访问节点的上下文信息。文件 <code>babel/packages/babel-traverse/src/context.ts</code> 定义了 <code>TraversalContext</code> 类。</p> <p>在遍历节点队列的过程中，每访问一个节点，<code>path.context</code> 就会被设置为被访问节点对应的上下文 <code>context</code> 对象，上图有描述。</p> <p>一个较为迷惑的点是，<code>./context.ts</code> 和 <code>./path/context.ts</code> 二者有什么区别？</p> <ul><li><code>./context.ts</code> 定义了 <code>TraversalContext</code> 类，该类的实例，作为属性 <code>path.context</code> 的值</li> <li><code>./path/context.ts</code> 对外暴露的各个方法和属性，可以直接被 <code>path</code> 对象访问，因为这些方法和属性被直接添加到 <code>NodePath.prototype</code> 上，<code>path</code> 作为 <code>NodePath</code> 的实例是可以直接访问的</li></ul></li> <li><p><code>path.context.visit(node, key): boolean</code></p> <p>遍历 <code>node[key]</code> 节点集合及其子节点，返回值表示是否结束节点遍历。</p> <p>该方法的执行，会调用 Babel 插件里注册的处理函数，分别在 <code>enter/exit</code> 阶段执行，从源码和上图可以看到如下执行链路：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ./context.ts</span>
path<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">--</span><span class="token operator">&gt;</span>

<span class="token comment">// ./path/context.ts</span>
path<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">--</span><span class="token operator">&gt;</span>

<span class="token comment">// ./path/context.ts</span>
<span class="token function">path</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">--</span><span class="token operator">&gt;</span> 

<span class="token comment">// ./path/context.ts</span>
fns队列依次执行，fns就是插件传入的处理方法
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这是插件提供的处理函数的调用方式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> ret <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> ret<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You appear to be using a plugin with an async traversal visitor, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">which your current version of Babel does not support. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">If you're using a published plugin, you may need to upgrade </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">your @babel/core version.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unexpected return value from visitor method </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fn<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以看到：</p> <ul><li>函数的 <code>this</code> 指向 <code>path.state</code>，两个参数分别指向 <code>path</code> 和 <code>path.state</code></li> <li>Babel 还未支持异步的 Visitor 处理函数</li> <li>Visitor 处理函数不能反悔非空值</li></ul></li> <li><p><code>path.contexts: Array&lt;TraversalContext&gt;</code></p> <p>某种类型的节点队列在遍历过程中，<code>path</code> 对象维护了一个 <code>path.contexts</code> 数组，每当遍历一个节点时，<code>path.contexts</code> 数组即会将当前被访问节点的上下文信息对象 <code>context</code> 推入该数组。如果整个队列遍历结束，则会清空 <code>path.contexts</code>。</p></li></ul></li> <li><p>作用域信息: <code>path.scope</code></p> <p><code>path.scope</code> 描述 <code>path.node</code> 节点所在的作用域的所有信息。</p> <p><code>path.scope</code> 对象对应的构造函数 <code>Scope</code>，定义于文件 <code>babel/packages/babel-traverse/src/scope/index.ts</code>，通过 <code>init/crawl</code> 等方法完成实例的初始化操作。</p> <ul><li><p><code>path.scope.binding: Binding</code></p> <p>既然介绍作用域空间，肯定要涉及变量绑定等信息，babel-traverse 用单独的 <code>babel/packages/babel-traverse/src/scope/binding.ts</code> 文件定义了绑定信息类 <code>Binding</code>。</p> <p>在此初始化一个 <code>Binding</code> 类的实例 <code>binding</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span>binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以下是 <code>path.scope.binding</code> 对象的一些属性和方法：</p> <ul><li><p><code>path.scope.binding.identifier: t.Identifier</code></p> <p>指向标识符 AST 节点。</p></li> <li><p><code>path.scope.binding.scope: Scope</code></p> <p>对 <code>scope</code> 的反向引用：<code>path.scope.binding.scope</code> 指向 <code>path.scope</code>。</p></li> <li><p><code>path.scope.binding.path: NodePath</code></p> <p>对 <code>path</code> 的反向引用：<code>path.scope.binding.path</code> 指向 <code>path</code>。</p></li> <li><p><code>path.scope.binding.kind: string</code></p> <p>绑定类型，值可以是：<code>&quot;var&quot; | &quot;let&quot; | &quot;const&quot; | &quot;module&quot; | &quot;hoisted&quot; | &quot;param&quot; | &quot;local&quot; | &quot;unknown&quot;</code>。</p></li> <li><p><code>path.scope.binding.references: number</code></p> <p>表示 <code>binding</code> 对象对应的变量被引用的次数。以下述代码为例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> key<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token keyword">of</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    key
    key
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>变量 <code>key</code> 的 <code>binding.references</code> 值是 2，因为 <code>for</code> 循环内部有 2 处对 <code>key</code> 的引用。</p></li> <li><p><code>path.scope.binding.referencePaths: Array&lt;NodePath&gt;</code></p> <p>它是一个数组，用于记录 <code>path.node</code> 被引用的各个节点。</p></li> <li><p><code>path.scope.binding.referenced: boolean</code></p> <p>描述当前 <code>path.node</code> 节点是否被引用到。该属性可用于&quot;tree-shaking&quot;功能，如果没有被引用到，则该节点可被删除。</p></li></ul></li> <li><p><code>path.scope.bindings</code></p> <p>该对象初始值为 <code>Object.create(null)</code>，近似于 <code>{}</code>，但原型链查找链路只有一层（对象自身）。</p> <p>babel-traverse 在节点扫描过程中会为该对象不断添加当前 <code>path.node</code> 节点作用域内的变量绑定信息，设置方式为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// this 就是 path.scope </span>
<span class="token keyword">this</span><span class="token punctuation">.</span>bindings<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">identifier</span><span class="token operator">:</span> id<span class="token punctuation">,</span>
    <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> bindingPath<span class="token punctuation">,</span>
    <span class="token literal-property property">kind</span><span class="token operator">:</span> kind<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p><code>path.scope.uid: string</code></p> <p>唯一的 scope id。</p> <p>babel-traverse 过程中，各个 <code>path.scope</code> 具有唯一的 <code>uid</code>，如 <code>&quot;_id1&quot;</code>，其中 <code>id1</code> 往往是当前变量的名称。</p></li> <li><p><code>path.scope.path: NodePath</code></p> <p>反向引用：<code>path.scope.path</code> 指向 <code>path</code>。</p></li> <li><p><code>path.scope.block</code></p> <p>TODO</p></li> <li><p><code>path.scope.globals</code></p> <p><code>path.scope</code> 的内部变量，用于当前节点所处的 <code>ProgramParent</code> 节点存储一些绑定信息。</p></li> <li><p><code>path.scope.uids: { [name: string]: boolean }</code></p> <p>TODO，待验证</p> <p>初始值为 <code>Object.create(null)</code>。</p> <p>该对象记录了 <code>path.scope</code> 作用域中涉及的所有节点的 <code>uid</code>，其值类似：<code>{ _id1: true, _id2: true, _id3: false }</code>。</p></li> <li><p><code>path.scope.data: Object</code></p> <p><code>path.scope.data</code> 记录了 babel-traverse 运行过程中的一些数据信息，用于内部流转。</p></li> <li><p><code>path.scope.crawling: boolean</code></p> <p>标志位，表示 <code>path.scope</code> 是否在初始化过程中，因为初始化中涉及对各类树的遍历操作，因此称为 <code>crawling</code>。</p></li> <li><p><code>path.scope.parent</code></p> <p>指向父级 <code>scope</code> 节点。</p></li> <li><p><code>path.scope.parentBlock</code></p> <p>指向父级 <code>block</code>。</p></li> <li><p><code>path.scope.hub</code></p> <p>TODO</p></li> <li><p>遍历方法: <code>path.scope.traverse: Function</code></p> <p>该方法就是 babel-traverse 对外暴露的 <code>traverse</code> 方法，用于遍历节点树。</p></li> <li><p><code>path.scope.generateUidIdentifier(name?: string): t.Identifier</code></p> <p>生成基于 <code>name</code>，且名称唯一的、新 Identifier 节点。</p></li> <li><p><code>path.scope.generateDeclaredUidIdentifier(name?: string): t.Identifier</code></p> <p>生成基于 <code>name</code>，且名称唯一的、新 Identifier 节点，不过其返回的是用 <code>path.scope.generateUidIdentifier</code> 生成的新节点的副本节点。</p></li> <li><p><code>path.scope.generateUid(name?: string): string</code></p> <p>基于 <code>name</code> 生成新的唯一的 <code>uid</code>。</p> <p>内部使用 <code>do...while</code> 保证了对名称唯一性验证的持续进行，同时新的 <code>uid</code> 避免和以下场景冲突：</p> <ul><li><code>this.hasLabel(uid)</code>: 和标记的关键词同名</li> <li><code>this.hasBinding(uid)</code>: 和绑定的变量同名</li> <li><code>this.hasGlobal(uid)</code>: 和全局变量同名</li> <li><code>this.hasReference(uid)</code>: 和被引用中的变量同名</li></ul></li> <li><p><code>path.scope.generateUidBasedOnNode(node: t.Node, defaultName?: string): string</code></p> <p>基于 <code>node</code> 生成 <code>uid</code>。方法内部通过对 <code>node</code> 的递归遍历，生成一个 <code>name</code> 数组。案例TODO</p></li> <li><p><code>path.scope.generateUidIdentifierBasedOnNode(node: t.Node, defaultName?: string): t.Identifier</code></p> <p>生成既有基于 <code>node</code> 生成的新 <code>uid</code> 的新 <code>Identifier</code> 节点。</p></li> <li><p><code>path.scope.isStatic</code></p> <p>TODO</p></li> <li><p><code>path.scope.maybeGenerateMemoised</code></p> <p>TODO</p></li> <li><p><code>path.scope.checkBlockScopedCollisions</code></p> <p>TODO</p></li> <li><p><code>path.scope.rename</code></p> <p>TODO</p></li> <li><p><code>path.scope.dump</code></p> <p>TODO</p></li> <li><p><code>path.scope.hasLabel(name: string): boolean</code></p> <p><code>path.node</code> 是否含有标签类型的关键字。</p></li> <li><p><code>path.scope.getLabel(name: string): NodePath&lt;t.LabeledStatement&gt;</code></p> <p>获取 <code>path.node</code> 携带的标签关键字节点。</p></li> <li><p><code>path.scope.registerLabel(path: NodePath&lt;t.LabeledStatement&gt;): void</code></p> <p>将标签关键字节点注册到当前 <code>scope</code>。</p></li> <li><p><code>path.scope.registerDeclaration(path: NodePath): void</code></p> <p>根据 <code>path</code> 对应的节点类型，注册到各类map对象中。</p> <p>和 <code>path.scope.binding.kind: string</code>字段对应的（<code>&quot;var&quot; | &quot;let&quot; | &quot;const&quot; | &quot;module&quot; | &quot;hoisted&quot; | &quot;param&quot; | &quot;local&quot; | &quot;unknown&quot;</code>），以下类型的节点会被注册：</p> <ul><li><code>LabeledStatement</code>: 写入 <code>this.labels</code> 对象</li> <li><code>FunctionDeclaration</code>: 写入 <code>hoisted</code></li> <li><code>VariableDeclaration</code>: 写入 <code>path.scope.bindings</code> 的 <code>var/let/const</code> 类型</li> <li><code>ClassDeclaration</code>: 写入 <code>path.scope.bindings</code> 的 <code>let</code>类型</li> <li><code>ImportDeclaration</code>: 写入<code>path.scope.bindings</code> 的 <code>module</code>类型</li> <li><code>ExportDeclaration</code>: 解构该节点，并递归注册</li> <li>无法识别的，注册为 <code>unknown</code></li></ul></li> <li><p><code>path.scope.buildUndefinedNode(): t.UnaryExpression</code></p> <p>生成一个 <code>undefined</code> 节点。</p></li> <li><p><code>path.scope.registerConstantViolation</code></p> <p>TODO</p></li> <li><p><code>path.scope.registerBinding</code></p> <p>为 <code>path.scope.bindings</code> 对象设置当前 <code>path.node</code> 节点对应作用域的所有绑定信息。</p></li> <li><p><code>path.scope.addGlobal</code></p> <p>TODO</p></li> <li><p><code>path.scope.hasUid(name: string): boolean</code></p> <p>沿着 <code>path.scope</code> 及以上的 <code>scope</code> 节点对象，判断是否含有 <code>uid</code> 为 <code>name</code> 的节点。</p></li> <li><p><code>path.scope.hasGlobal(name: string): boolean</code></p> <p>判断当前节点及各级父节点中，每个<code>scope.globals</code>对象是否含有<code>key</code>为<code>name</code>的属性。</p></li> <li><p><code>path.scope.hasReference(name: string): boolean</code></p> <p>直接根据顶层作用域节点 <code>ProgramParent</code> 得知是否含有 <code>uid</code> 为 <code>name</code> 的节点。</p></li> <li><p><code>path.scope.isPure</code></p> <p>TODO</p></li> <li><p><code>path.scope.crawl</code></p> <p>初始化 <code>path.scope</code> 实例时执行的方法，<code>crawl</code> 意为&quot;爬取&quot;，该方法有以下作用：</p> <ul><li>初始化 <code>path.scope</code> 的一系列属性：<code>references/bindings/globals/uids/data</code></li> <li>遍历当前 <code>path</code> 节点及其子节点，注册 <code>path.scope</code> 的各类属性</li></ul></li> <li><p><code>path.scope.getProgramParent(): Scope | null</code></p> <p>向上遍历<code>scope</code>树，直到遇到类型是<code>Program</code>的<code>scope</code>节点。</p></li> <li><p><code>path.scope.getFunctionParent(): Scope | null</code></p> <p>向上遍历 <code>scope</code> 树，直到遇到类型是 <code>Function</code> 的 <code>scope</code> 节点。</p></li> <li><p><code>path.scope.getBlockParent: Scope</code></p> <p>从当前节点到各级父节点，判断是否有块级作用域的存在。块级作用域对应的节点有：<code>BlockStatement/Loop/Program/Function/Switch</code>。</p></li> <li><p><code>path.scope.getAllBindings: { [ key: string ]: Binding }</code></p> <p>从当前节点到各级父节点，遍历时收集每个 <code>scope</code> 节点的 <code>scope.bindings</code> 信息。返回收集的所有绑定信息对象。</p></li> <li><p><code>path.scope.getAllBindingsOfKind(...kinds: string[]): any</code></p> <p>从当前节点到各级父节点，判断每个节点的类型是否匹配 <code>kinds: string[]</code> 中的元素，如有匹配，则收集该 <code>scope</code> 节点的 <code>scope.bindings</code> 信息。返回收集的所有绑定信息对象。</p></li> <li><p><code>path.scope.bindingIdentifierEquals(name: string, node: t.Node): boolean</code></p> <p>从当前节点到各级父节点，获取 <code>uid</code> 为 <code>name</code> 的标识符节点，并判断该节点和传入的 <code>node</code> 是否相同。</p></li> <li><p><code>path.scope.getBinding(name: string): Binding | undefined</code></p> <p>从当前节点到各级父节点，判断每个节点是否含有 <code>uid</code> 为 <code>name</code> 的 <code>scope.binding</code> 对象，如有，则就近返回第一个匹配的 <code>binding</code> 对象。</p></li> <li><p><code>path.scope.getOwnBinding(name: string): Binding | undefined</code></p> <p>获取当前节点中，<code>uid</code> 为 <code>name</code> 的 <code>scope.binding</code> 对象。</p></li> <li><p><code>path.scope.getBindingIdentifier(name: string): t.Identifier | undefined</code> TODO PR</p> <p>从当前节点及各级父节点，获取索引 <code>key</code> 为 <code>name</code> 的节点。</p></li> <li><p><code>path.scope.getOwnBindingIdentifier(name: string): t.Identifier | undefined</code></p> <p>从当前节点的 <code>binding</code> 信息获取 <code>uid</code> 为 <code>name</code> 的节点。</p></li> <li><p><code>path.scope.hasOwnBinding(name: string): boolean</code></p> <p>判断当前节点中，是否含有 <code>uid</code> 为 <code>name</code> 的 <code>scope.binding</code> 对象。</p></li> <li><p><code>path.scope.hasBinding(name: string, noGlobals?): boolean</code></p> <p>判断当前节点及向上一级的父节点是否有 <code>uid</code> 为 <code>name</code> 的绑定节点信息。</p></li> <li><p><code>path.scope.parentHasBinding(name: string, noGlobals?)</code></p> <p>判断当前节点的向上一级的父节点，是否有 <code>uid</code> 为 <code>name</code> 的绑定节点信息。</p></li> <li><p><code>path.scope.moveBindingTo(name: string, scope: Scope)</code></p> <p>移动当前命名空间中名称为 <code>name</code> 的绑定信息到目标 <code>scope</code> 命名空间。</p></li> <li><p><code>path.scope.removeOwnBinding(name: string): void</code></p> <p>删除当前节点的 <code>uid</code> 为 <code>name</code> 的绑定信息。</p></li> <li><p><code>path.scope.removeBinding(name: string): void</code></p> <p>删除当前节点及各级父节点的 <code>uid</code> 为 <code>name</code> 的绑定信息。</p></li></ul></li> <li><p>家族节点(family)</p> <ul><li><p><code>path.getOpposite(this: NodePath): NodePath | null</code></p> <p>获取“对面”的兄弟节点，比如一个二元表达式含有左右两个节点，如 <code>1 + 2</code>，节点是 <code>left</code> 节点，该方法返回的就是 <code>right</code> 节点。</p> <p>源码为：</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">getOpposite</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> NodePath<span class="token punctuation">)</span><span class="token operator">:</span> NodePath <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSibling</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSibling</span><span class="token punctuation">(</span><span class="token string">&quot;left&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p><code>path.getCompletionRecords</code></p> <p>TODO</p></li> <li><p><code>path.getSibling(this: NodePath, key: string | number): NodePath</code></p> <p>获取对应 <code>key</code> 值的兄弟节点。</p></li> <li><p><code>path.getPrevSibling(this: NodePath): NodePath</code></p> <p>获取前一个兄弟节点。</p></li> <li><p><code>path.getNextSibling(this: NodePath): NodePath</code></p> <p>获取下一个兄弟节点。</p></li> <li><p><code>path.getAllNextSiblings(this: NodePath): NodePath[]</code></p> <p>获取后面所有的兄弟节点。</p></li> <li><p><code>path.getAllPrevSiblings(this: NodePath): NodePath[]</code></p> <p>获取前面所有的兄弟节点。</p></li> <li><p><code>path.get&lt;T extends t.Node&gt;(this: NodePath&lt;T&gt;, key: string, context?: true | TraversalContext ): NodePath | NodePath[]</code></p> <p>根据 <code>key</code> 值获取目标节点。key的内容可以是 <code>&quot;foo&quot;</code> 或 <code>&quot;foo.bar&quot;</code> 这样的写法。</p></li> <li><p><code>path.getBindingIdentifiers( duplicates?: boolean ): Record&lt;string, t.Identifier[] | t.Identifier&gt;</code></p> <p>获取和 <code>path.node</code> 节点绑定的标识符列表。该方法等同于 <code>t.getBindingIdentifiers()</code></p></li> <li><p><code>path.getOuterBindingIdentifiers(duplicates: true ): Record&lt;string, t.Identifier[]&gt;</code></p> <p>TODO</p></li> <li><p><code>path.getBindingIdentifierPaths(this: NodePath, duplicates: boolean = false, outerOnly: boolean = false ): { [x: string]: NodePath;}</code></p> <p>TODO</p></li> <li><p><code>path.getOuterBindingIdentifierPaths(this: NodePath, duplicates?: boolean ): { [x: string]: NodePath;}</code></p> <p>TODO</p></li></ul></li> <li><p>祖先节点(ancestry)</p> <ul><li><p><code>path.findParent(callback: (path: NodePath) =&gt; boolean ): NodePath | null</code></p> <p>从当前节点的父节点开始，递归向上查找目标祖先节点，直到 <code>callback</code> 返回 <code>true</code>，<code>callback</code> 参数为递归向上过程的各级父节点。</p></li> <li><p><code>path.find(callback: (path: NodePath) =&gt; boolean ): NodePath | null</code></p> <p>从当前节点开始，递归向上查找目标祖先节点，直到 <code>callback</code> 返回 <code>true</code>，<code>callback</code> 参数为递归向上过程的各级父节点。</p></li> <li><p><code>path.getFunctionParent(this: NodePath): NodePath&lt;t.Function&gt; | null</code></p> <p>这是基于 <code>findParent</code> 的快捷方法，如果向上递归过程中，有一个祖先节点是函数，则停止查找并返回该节点。</p></li> <li><p><code>path.getStatementParent(this: NodePath): NodePath&lt;t.Statement&gt;</code></p> <p>从当前节点开始，递归向上查找类型为 <code>Statement</code> 的祖先节点。</p></li> <li><p><code>path.getEarliestCommonAncestorFrom(this: NodePath, paths: Array&lt;NodePath&gt; ): NodePath</code></p> <p>TODO</p></li> <li><p><code>path.getDeepestCommonAncestorFrom</code></p> <p>参数及返回值类型：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">getDeepestCommonAncestorFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> NodePath<span class="token punctuation">,</span> <span class="token literal-property property">paths</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>NodePath<span class="token operator">&gt;</span><span class="token punctuation">,</span> filter<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">deepest</span><span class="token operator">:</span> t<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token literal-property property">i</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">ancestries</span><span class="token operator">:</span> NodePath<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> NodePath<span class="token punctuation">)</span><span class="token operator">:</span> NodePath
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>TODO</p></li> <li><p><code>path.getAncestry(this: NodePath): Array&lt;NodePath&gt;</code></p> <p>获取包含当前节点的所有祖先节点的节点列表。</p></li> <li><p><code>path.isAncestor(this: NodePath, maybeDescendant: NodePath): boolean</code></p> <p>TODO</p></li> <li><p><code>path.isDescendant(this: NodePath, maybeAncestor: NodePath): boolean</code></p> <p>判断 <code>maybeAncestor</code> 节点是否是 <code>node</code> 的祖先节点，内部利用 <code>findParent</code> 方法。</p></li> <li><p><code>path.inType(this: NodePath, ...candidateTypes: string[]): boolean</code></p> <p>TODO</p></li></ul></li> <li><p>推断相关: inference</p> <ul><li><p><code>path.getTypeAnnotation(): t.FlowType</code></p> <p>获取当前节点的类型推断。</p></li> <li><p><code>path.isBaseType(baseName: string, soft?: boolean): boolean</code></p> <p>是否是基本类型，包括：<code>string / number / boolean / any / mixed / empty / void</code>。</p> <p>值得注意的是，该方法接收一个 <code>soft: boolean</code> 属性，表示是否是宽松式地检查，如果值为 <code>false</code>，则会抛出错误。</p></li> <li><p><code>path.couldBeBaseType(name: string): boolean</code></p> <p>判断当前节点是否是基础类型，包括：<code>string / number / boolean / any / mixed / empty / void</code>。</p> <p>TODO</p></li> <li><p><code>path.baseTypeStrictlyMatches(rightArg: NodePath): boolean</code></p> <p>TODO</p></li> <li><p><code>path.isGenericType(genericName: string): boolean</code></p> <p>TODO</p></li></ul></li> <li><p>计算相关: evaluation</p> <ul><li><p><code>path.evaluateTruthy(this: NodePath): boolean | undefined</code></p> <p>计算当前表达式节点的计算结果是否可以转为 <code>true</code> 或 <code>false</code>，该方法可能有如下返回值：</p> <ul><li><code>true</code>: 确定该表达式的计算结果可以转为 <code>true</code></li> <li><code>false</code>: 确定该表达式的计算结果可以转为 <code>false</code></li> <li><code>undefined</code>: 不确定该表达式的计算结果是否可转为 <code>true</code> 还是 <code>false</code></li></ul> <p>对于该方法的返回值 <code>returnedValue</code>，要特别注意要使用 <code>returnedValue === false</code> 判断其是否为 <code>false</code>。</p></li> <li><p><code>path.evaluate(this: NodePath): { confident: boolean; value: any; deopt?: NodePath; }</code></p> <p>计算当前表达式节点的值的相关信息。</p> <p>当然这也是尝试计算，所以该方法的返回值结构为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> 
    confident<span class="token punctuation">,</span> <span class="token comment">// 表示是否确定能获取表达式的值，类型为 boolean</span>
    value<span class="token punctuation">,</span> <span class="token comment">// 表达式的值，默认为 undefined</span>
    deopt <span class="token comment">// TODO</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>源码的注释里介绍了几种场景：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;5 + 5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { confident: true, value: 10 }</span>
t<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;!true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { confident: true, value: false }</span>
t<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;foo + foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { confident: false, value: undefined, deopt: NodePath }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li> <li><p>introspection</p> <ul><li><p><code>path.matchesPattern(this: NodePath, pattern: string, allowPartial?: boolean ): boolean</code></p> <p>判断当前节点是否匹配传入的 <code>pattern</code> 模板字符。比如 <code>pattern = 'React.createClass'</code> 匹配的AST节点对象是 <code>React.createClass</code> 和 <code>React[&quot;createClass&quot;]</code>。</p> <p>方法内部依赖 babel-types：<code>t.matchesPattern(this.node, pattern, allowPartial)</code>。</p></li> <li><p><code>path.has(this: NodePath, key: string): boolean</code></p> <p>判断 <code>node</code> 节点对象的 <code>node[key]</code> 是否有值。</p> <p>这里额外判断了 <code>node[key]</code> 为数组时，是否为空数组的情况。</p></li> <li><p><code>path.is(this: NodePath, key: string): boolean</code></p> <p>等同于 <code>path.has</code>。</p></li> <li><p><code>path.isnt(this: NodePath, key: string): boolean</code></p> <p>等同于 <code>!path.is(this: NodePath, key: string): boolean</code>。</p></li> <li><p><code>path.isStatic(this: NodePath): boolean</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> NodePath</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>判断当前 <code>node</code> 节点所在的作用域是否是静态的。TODO</p></li> <li><p><code>path.equals(this: NodePath, key: string, value): boolean</code></p> <p>检查当前 <code>node</code> 的 key 值是否严格等于 value。</p></li> <li><p><code>path.isNodeType(this: NodePath, type: string): boolean</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isNodeType</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> NodePath<span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">isType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>判断当前节点类型 <code>node.type</code> 是否是目标类型 <code>type</code>。</p></li> <li><p><code>path.canHaveVariableDeclarationOrExpression</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">canHaveVariableDeclarationOrExpression</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token operator">:</span> NodePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">&quot;init&quot;</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span><span class="token function">isFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>判断当前节点是下述 <code>for</code> 循环中的变量：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token constant">KEY</span> <span class="token keyword">in</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token constant">KEY</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p><code>path.canSwapBetweenExpressionAndStatement</code></p> <p>判断一个节点是否可以在表达式与语句之间相互转化，针对的是这种写法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span>

<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>path.isCompletionRecord</code></p> <p>TODO</p></li> <li><p><code>path.isStatementOrBlock</code></p> <p>TODO</p></li> <li><p><code>path.referencesImport</code></p> <p>TODO</p></li> <li><p><code>path.getSource</code></p> <p>TODO</p></li> <li><p><code>path.willIMaybeExecuteBefore</code></p> <p>TODO</p></li> <li><p><code>path.resolve</code></p> <p>TODO</p></li> <li><p><code>path.isConstantExpression</code></p> <p>TODO</p></li> <li><p><code>path.isInStrictMode</code></p> <p>判断当前节点是否位于严格模式的上下文中。</p></li></ul></li> <li><p>上下文相关(context)</p> <ul><li><p><code>path.call(this: NodePath, key: string): boolean</code></p> <ul><li>执行 Visitor 传入的相关节点处理方法</li> <li>返回 true 时：TODO</li> <li>返回 false 时：TODO</li></ul></li> <li><p><code>path.isDenylisted(this: NodePath): boolean</code></p> <p><code>babelTraverse(node, opts)</code> 中，<code>opts</code> 有配置项 <code>denyList: Array&lt;string&gt;</code>，配置不访问的节点。</p></li> <li><p><code>path.visit</code></p></li> <li><p><code>path.skip</code></p></li> <li><p><code>path.skipKey</code></p></li> <li><p><code>path.stop</code></p></li> <li><p><code>path.setScope</code></p></li> <li><p><code>path.setContext</code></p></li> <li><p><code>path.resync</code></p></li> <li><p><code>path.popContext</code></p></li> <li><p><code>path.pushContext</code></p></li> <li><p><code>path.setup</code></p></li> <li><p><code>path.setKey</code></p></li> <li><p><code>path.requeue</code></p></li></ul></li> <li><p>替换节点: replacements</p> <ul><li><p><code>path.replaceWithMultiple&lt;Nodes extends Array&lt;t.Node&gt;&gt;(nodes: Nodes): NodePath[]</code></p> <p>用多个节点替换掉当前节点，并返回替换后的 <code>path</code> 节点列表。</p></li> <li><p><code>path.replaceWithSourceString(this: NodePath, replacement): void</code></p> <p>用字符串形式的代码，替换目标节点 <code>node</code>。</p> <p>内部实现上，会使用 <code>babel-parser</code> 的 <code>parse</code> 方法将代码字符串解析为 AST 节点，然后通过 <code>replaceWith</code> 方法完成节点替换。</p> <p>解析代码字符串失败的话，会抛出错误，描述为 <code>BABEL_REPLACE_SOURCE_ERROR</code> 错误，并用 <code>babel-code-frame</code> 描述出错的代码位置信息。</p></li> <li><p><code>path.replaceWith(this: NodePath, replacement: t.Node | NodePath)</code></p> <p>TODO</p></li> <li><p><code>path.replaceExpressionWithStatements(this: NodePath, nodes: Array&lt;t.Statement&gt;)</code></p> <p>TODO</p></li> <li><p><code>path.replaceInline(this: NodePath, nodes: t.Node | Array&lt;t.Node&gt;)</code></p> <p>TODO</p></li></ul></li> <li><p>转换节点: conversion</p> <ul><li><p><code>path.toComputedKey(this: NodePath)</code></p></li> <li><p><code>path.ensureBlock</code></p> <p>TODO</p></li> <li><p><code>path.arrowFunctionToShadowed</code></p></li> <li><p><code>path.unwrapFunctionEnvironment</code></p></li> <li><p><code>path.arrowFunctionToExpression</code></p> <p>将箭头函数转为 ES5 里的函数表达式。</p> <p>参数：</p> <ul><li><p><code>allowInsertArrow</code>: TODO</p></li> <li><p><code>specCompliant</code>: TODO</p></li> <li><p><code>noNewArrows</code>: TODO</p></li></ul></li></ul></li> <li><p>删除节点: removal</p> <ul><li><code>path.remove</code></li></ul></li> <li><p>修改节点: modification</p> <ul><li><code>path.insertBefore</code></li> <li><code>path.insertAfter</code></li> <li><code>path.updateSiblingKeys</code></li> <li><code>path.unshiftContainer</code></li> <li><code>path.pushContainer</code></li> <li><code>path.hoist</code></li></ul></li> <li><p>注释相关: comments</p> <ul><li><p><code>path.shareCommentsWithSiblings</code></p></li> <li><p><code>path.addComment</code></p> <p>添加一条注释。</p></li> <li><p><code>path.addComments</code></p> <p>添加多条注释。</p></li></ul></li> <li><p>校验节点: validate</p> <p>文件 <code>packages/babel-traverse/src/path/index.ts</code> 中，为 <code>NodePath.prototype</code> 上添加了校验方法，这些方法全部来自 babel-types。</p> <p>使用方式为 <code>path.is{NodeName}</code>，如 <code>path.isFunctionStatement(...)</code>。</p></li></ul> <h3 id="_5-1-4-state"><a href="#_5-1-4-state" class="header-anchor">#</a> 5.1.4 state</h3> <p>babel-traverse 负责调用插件传入的处理方法，其本身是支持传入一个初始化的state的，开发者可以根据自己需要传入一个初始化的 state 值，<code>traverse</code> 方法的定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">traverse</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">parent</span><span class="token operator">:</span> t<span class="token punctuation">.</span>Node<span class="token punctuation">,</span>
  <span class="token literal-property property">opts</span><span class="token operator">:</span> TraverseOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  scope<span class="token operator">?</span><span class="token operator">:</span> Scope<span class="token punctuation">,</span>
  state<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  parentPath<span class="token operator">?</span><span class="token operator">:</span> NodePath<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>开发者实际使用的时候，一般不需要独立使用 babel-traverse，而是根据 babel-core 间接调用 babel-traverse，babel-core 在内部为 state 对象提供了一些属性、方法，便于开发者使用，如下图所示：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155270726-aba9e153-7dba-4e0c-8241-b495bab73168.jpg" alt="Babel插件编写/state"></p> <p>scope - index - crawl</p> <p>在开发者没有设置 state 的情况下，内置遍历过程提供的 state 对象是 <code>babel-core/src/transformation/plugin-pass.ts</code> 定义的 <code>PluginPass</code> 实例。</p> <p>state 实例本身内容并不复杂，其有如下属性或方法：</p> <ul><li><p><code>state.key</code></p></li> <li><p><code>state.cwd</code></p></li> <li><p><code>state.filename</code></p></li> <li><p><code>state.file</code></p> <p><code>state.file</code> 对象是 <code>File</code> 类的实例。<code>File</code> 类定义自文件 <code>babel/packages/babel-core/src/transformation/file/file.ts</code>。</p></li> <li><p><code>state.file.availableHelper</code></p></li> <li><p><code>state.file.addHelper</code></p></li> <li><p><code>state.file.addImport</code></p></li> <li><p><code>state.file.buildCodeFrameError</code></p></li></ul> <h2 id="_5-2-节点操作-babel-types"><a href="#_5-2-节点操作-babel-types" class="header-anchor">#</a> 5.2 节点操作: babel-types</h2> <p>Babel 使用 babel-types 进行节点操作。babel-types 对外暴露出的 API，总体来说，可以分为对节点的“读操作”和“写操作”。</p> <ul><li>读节点
<ul><li>节点校验</li> <li>查找节点</li> <li>节点遍历</li></ul></li> <li>写节点
<ul><li>创建节点</li> <li>修改节点</li> <li>转换节点</li> <li>操作注释</li> <li>复制节点</li></ul></li></ul> <p>babel-types 也提供了对 TypeScript 和 Flow 的 API 支持</p> <p>下文中，用 <code>t</code> 代表 <code>babel-types</code>对外暴露的对象。</p> <h3 id="_5-2-1-读节点"><a href="#_5-2-1-读节点" class="header-anchor">#</a> 5.2.1 读节点</h3> <p>读操作api分布：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155270810-4cf8ec4f-58d7-4f44-9d60-870712009776.jpg" alt="Babel插件编写/babel-types读操作"></p> <ul><li><p>查找节点</p> <ul><li><p><code>t.getBindingIdentifiers</code></p> <ul><li><p>参数与返回值类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">getBindingIdentifiers</span><span class="token punctuation">(</span>node<span class="token operator">:</span> t<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> duplicates<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span> outerOnly<span class="token operator">?</span><span class="token operator">:</span> boolean <span class="token punctuation">)</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Identifier<span class="token operator">&gt;</span> <span class="token operator">|</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Array<span class="token operator">&lt;</span>t<span class="token punctuation">.</span>Identifier<span class="token operator">&gt;&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>TODO</p></li></ul></li> <li><p><code>t.getOuterBindingIdentifiers</code></p> <ul><li><p>参数与返回值类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">getOuterBindingIdentifiers</span><span class="token punctuation">(</span>node<span class="token operator">:</span> t<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> duplicates<span class="token operator">?</span><span class="token operator">:</span> boolean <span class="token punctuation">)</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Identifier<span class="token operator">&gt;</span> <span class="token operator">|</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Array<span class="token operator">&lt;</span>t<span class="token punctuation">.</span>Identifier<span class="token operator">&gt;&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>TODO</p></li></ul></li></ul></li> <li><p>校验节点</p> <ul><li><p><code>t.is</code></p> <ul><li><p>参数与返回值类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 较源码做了简化</span>
t<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>type<span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">node</span><span class="token operator">:</span> t<span class="token punctuation">.</span>Node <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> opts<span class="token operator">?</span><span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token punctuation">)</span><span class="token operator">:</span> boolean
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>功能</p> <p>判断给定的节点 <code>node</code> 的类型是否是 <code>type</code> 的值。</p></li></ul></li> <li><p><code>t.is{NodeName}</code></p></li> <li><p><code>t.isBinding(node: t.Node, parent: t.Node, grandparent?: t.Node): boolean</code></p> <p>TODO</p></li> <li><p><code>t.isBlockScoped(node: t.Node): boolean</code></p> <p>判断 <code>node</code> 节点是否应用于块级作用域。满足条件的节点包括：</p> <p>函数声明（<code>FunctionDeclaration</code>）、类声明（<code>ClassDeclaration</code>）、<code>let/const</code> 声明的变量、TODO</p></li> <li><p><code>t.isImmutable(node: t.Node): boolean</code></p> <p>TODO</p></li> <li><p><code>t.isLet(node: t.Node): boolean</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isLet</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> t<span class="token punctuation">.</span>Node</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token function">isVariableDeclaration</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>node<span class="token punctuation">.</span>kind <span class="token operator">!==</span> <span class="token string">&quot;var&quot;</span> <span class="token operator">||</span> node<span class="token punctuation">[</span><span class="token constant">BLOCK_SCOPED_SYMBOL</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p><code>t.isNode(node: any): node is t.Node</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isNode</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> node is t<span class="token punctuation">.</span>Node <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>node <span class="token operator">&amp;&amp;</span> <span class="token constant">VISITOR_KEYS</span><span class="token punctuation">[</span>node<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>是否是 <code>node</code> 节点的条件：节点存在且是合法的节点类型。</p></li> <li><p><code>t.isNodesEquivalentisNodesEquivalent(a, b): boolean</code></p> <p>判断两个节点是否相等。</p></li> <li><p><code>t.isPlaceholderType(placeholderType: string, targetType: string): boolean</code></p> <p>TODO</p></li> <li><p><code>t.isReferenced(node: t.Node, parent: t.Node, grandparent?: t.Node): boolean</code></p> <p>TODO</p></li> <li><p><code>t.isScope(node: t.Node, parent: t.Node): boolean</code></p> <p>TODO</p></li> <li><p><code>t.isSpecifierDefault(specifier: t.ModuleSpecifier): boolean</code></p> <p>TODO</p></li> <li><p><code>t.isType(nodeType: string | null | undefined, targetType: string): boolean</code></p> <p>TODO</p></li> <li><p><code>t.isValidES3Identifier(name: string): boolean</code></p> <p>TODO</p></li> <li><p><code>t.isValidIdentifier(name: string, reserved: boolean = true): boolean</code></p> <p>TODO</p></li> <li><p><code>t.isVar(node: t.Node): boolean</code></p> <p>TODO</p></li> <li><p><code>t.matchesPattern(member: t.Node | null | undefined, match: string | string[], allowPartial?: boolean): boolean</code></p> <p>TODO</p></li> <li><p><code>t.validate(node: t.Node | undefined | null, key: string, val: any): void</code></p> <p>TODO</p></li> <li><p><code>t.buildMatchMemberExpression(match: string, allowPartial?: boolean)</code></p> <p>TODO</p></li></ul></li> <li><p>遍历节点</p> <ul><li><p><code>t.traverse&lt;T&gt;(node: t.Node, handlers: TraversalHandler&lt;T&gt; | TraversalHandlers&lt;T&gt;, state?: T): void</code></p> <p>TODO</p></li> <li><p><code>t.traverseFast(node: t.Node | null | undefined, enter: (node: t.Node, opts?: any) =&gt; void, opts?: any): void</code></p> <p>TODO</p></li></ul></li></ul> <h3 id="_5-2-2-写节点"><a href="#_5-2-2-写节点" class="header-anchor">#</a> 5.2.2 写节点</h3> <p>写操作api分布：</p> <p><img src="https://user-images.githubusercontent.com/5757051/155270860-0b0b6d0c-f271-4c68-9777-6b07d39c684f.jpg" alt="Babel插件编写/babel-types写操作"></p> <ul><li><p>创建节点</p> <p><code>t.{节点名称}</code></p> <ul><li><p>api格式</p> <p>babel-types 创建节点的 API 以 <code>t.{节点名称}</code> 格式命名，其中节点名称既支持大写开头，也支持小写开头。</p> <p>如创建 <code>Variance</code> 的话，可以是：<code>t.Variance</code> 或 <code>t.variance</code>。</p> <p><img src="https://user-images.githubusercontent.com/5757051/155271011-c2e9ae41-b7dd-4444-905e-0e730e8e580e.png" alt="Babel插件编写/babel-types创建节点"></p></li> <li><p>创建节点的参数</p> <ul><li><p>创建节点的参数由节点定义决定。</p> <p>例如，创建一个 <code>for</code> 循环语句（<code>ForStatement</code>）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>babel-types 中的 API 是 <code>t.forStatement(...)</code></p> <p>那么，使用者如何知道 <code>t.forStatement</code> 方法所需的参数呢？</p> <p>babel-types 创建 API 的参数可参考 <code>babel-types/src/definitions/</code> 目录下各文件对节点的定义的 <code>builder</code> 和 <code>fields</code> 字段。</p> <p><code>ForStatement</code> 节点的定义在 <code>babel-types/src/definitions/core.ts</code> 文件，定义内容：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">defineType</span><span class="token punctuation">(</span><span class="token string">&quot;ForStatement&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;init&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;body&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">aliases</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Scopable&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Statement&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;For&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;BlockParent&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Loop&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">fields</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">init</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">validate</span><span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;VariableDeclaration&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">optional</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">validate</span><span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">optional</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">update</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">validate</span><span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">optional</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">validate</span><span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Statement&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>builder</code> 字段提供参数名称及顺序，<code>field</code> 字段提供每个字段的格式校验规则。</p></li> <li><p>案例</p> <p>从 <code>ForStatement</code> 节点的定义可以看到，<code>t.ForStatement</code> 方法的参数如下：</p> <ul><li><p><code>init</code>: 初始化节点</p> <p>就是例子中的 <code>let i = 0</code>。</p> <p>可以是变量声明（<code>VariableDeclaration</code>）、表达式（<code>Expression</code>）。</p></li> <li><p><code>test</code>: 条件语句节点</p> <p>就是例子中的 <code>i &lt; 3</code>。</p> <p>需要是表达式（<code>Expression</code>）。</p></li> <li><p><code>update</code>: 更新语句节点</p> <p>就是例子中的 <code>i++</code>。</p> <p>需要是表达式（<code>Expression</code>）。</p></li> <li><p><code>body</code>: 循环体</p> <p>就是例子中的循环体部分。</p></li></ul> <p>综上，目标 for 循环语句：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>创建该节点的方法为：</p> <p>TODO</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> forStatement <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">forStatement</span><span class="token punctuation">(</span>

<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul></li> <li><p>部分 AST 节点没有对应的创建节点 API</p> <p>babel-types 中，除了个别节点，其余节点均有对应的创建节点 API。</p> <p>比如 <code>Function</code> 节点，<code>babel-types</code> 没有提供 <code>function</code> API 以创建 <code>Function</code> 节点，一方面是因为 <code>function</code> 本身就是 ECMAScript 的关键字，另一方面，函数要么以函数声明（<code>FunctionDeclaration</code>）出现，要么以函数表达式（<code>FunctionExpression</code>）出现，没有必要出现一个 <code>Function</code>。</p> <p>笔者整理了一些没有没有对应的创建 API 的节点，如下：</p> <ul><li><code>Function</code></li> <li><code>Statement</code></li> <li><code>Declaration</code></li> <li><code>Expression</code></li> <li><code>ObjectMember</code></li> <li><code>UnaryOperator</code></li> <li><code>UpdateOperator</code></li> <li><code>BinaryOperator</code></li> <li><code>LogicalOperator</code></li> <li><code>Pattern</code></li> <li><code>Class</code></li> <li><code>ClassPrivateMethod</code></li> <li><code>StaticBlock</code></li> <li><code>ModuleDeclaration</code></li> <li><code>ModuleSpecifier</code></li> <li><code>ImportAttribute</code></li></ul></li></ul></li> <li><p>修改节点</p> <ul><li><code>t.appendToMemberExpression</code></li> <li><code>t.inherits</code></li> <li><code>t.prependToMemberExpression</code></li> <li><code>t.removeProperties</code></li> <li><code>t.removePropertiesDeep</code></li> <li><code>t.removeTypeDuplicates</code></li></ul></li> <li><p>转换节点</p> <ul><li><code>t.ensureBlock</code></li> <li><code>t.toBindingIdentifierName</code></li> <li><code>t.toBlock</code></li> <li><code>t.toComputedKey</code></li> <li><code>t.toExpression</code></li> <li><code>t.toIdentifier</code></li> <li><code>t.toKeyAlias</code></li> <li><code>t.toSequenceExpression</code></li> <li><code>t.toStatement</code></li> <li><code>t.valueToNode</code></li></ul></li> <li><p>操作注释</p> <ul><li><code>t.addComment</code></li> <li><code>t.addComments</code></li> <li><code>t.inheritInnerComments</code></li> <li><code>t.inheritLeadingComments</code></li> <li><code>t.inheritsComments</code></li> <li><code>t.inheritTrailingComments</code></li> <li><code>t.removeComments</code></li></ul></li> <li><p>复制节点</p> <ul><li><code>t.cloneNode</code></li> <li><code>t.clone</code></li> <li><code>t.cloneDeep</code></li> <li><code>t.cloneDeepWithoutLoc</code></li> <li><code>t.cloneWithoutLoc</code></li></ul></li></ul> <h2 id="_5-3-插件编写实战"><a href="#_5-3-插件编写实战" class="header-anchor">#</a> 5.3 插件编写实战</h2></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><!----> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">March 9, 2022 10:03</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: antfootmail@gmail.com" class="contributor">
          hoperyy
        </span> <!----></span></div></footer> <!----> <!----> <!----> <div class="content__page-bottom"></div></main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button class="pswp__button pswp__button--close"></button> <button class="pswp__button pswp__button--share"></button> <button class="pswp__button pswp__button--fs"></button> <button class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button class="pswp__button pswp__button--arrow--left"></button> <button class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/books/dib/assets/js/app.8353d921.js" defer></script><script src="/books/dib/assets/js/vendors~layout-Layout.f8963aab.js" defer></script><script src="/books/dib/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ebefd1c7.js" defer></script><script src="/books/dib/assets/js/page--8fcba694.bce8a031.js" defer></script><script src="/books/dib/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.33005620.js" defer></script>
  </body>
</html>
